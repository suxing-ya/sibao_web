# è…¾è®¯äº‘æ•°æ®åº“è¿ç§»å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ å½“å‰é¡¹ç›®æ•°æ®åº“åˆ†æ

æ ¹æ®ä½ çš„é¡¹ç›®ä»£ç åˆ†æï¼Œå½“å‰ä½¿ç”¨çš„æ•°æ®åº“è¡¨ç»“æ„ï¼š

### ä¸»è¦æ•°æ®è¡¨ï¼š
1. **profiles** - ç”¨æˆ·æ¡£æ¡ˆè¡¨
2. **merchants** - å•†å®¶ç®¡ç†è¡¨  
3. **shipping_costs** - è¿è´¹æˆæœ¬è¡¨ï¼ˆä¸»è¦ä¸šåŠ¡æ•°æ®ï¼‰
4. **temu_workflow** - Temuå·¥ä½œæµè¡¨
5. **temu_shipment_details** - Temuè´§ä»¶è¯¦æƒ…è¡¨
6. **temu_shipment_ids** - Temuè´§ä»¶IDè¡¨

---

## ğŸ¯ æ–¹æ¡ˆä¸€ï¼šæ•°æ®è¿ç§»åˆ°è…¾è®¯äº‘ï¼ˆæ¨èï¼‰

### ç¬¬ä¸€æ­¥ï¼šè…¾è®¯äº‘æ•°æ®åº“å‡†å¤‡

#### 1.1 è´­ä¹°è…¾è®¯äº‘PostgreSQLæ•°æ®åº“
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. é€‰æ‹©"äº‘æ•°æ®åº“ PostgreSQL"
3. æ¨èé…ç½®ï¼š
   ```
   ç‰ˆæœ¬ï¼šPostgreSQL 13æˆ–14
   è§„æ ¼ï¼š1æ ¸2GBï¼ˆåŸºç¡€ç‰ˆï¼Œå¯åç»­å‡çº§ï¼‰
   å­˜å‚¨ï¼š20GB SSDï¼ˆå¯æ‰©å±•ï¼‰
   ç½‘ç»œï¼šVPCç½‘ç»œï¼ˆä¸ä½ çš„æœåŠ¡å™¨åœ¨åŒä¸€VPCï¼‰
   ```

#### 1.2 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
```sql
-- è¿æ¥åˆ°PostgreSQLåæ‰§è¡Œ
CREATE DATABASE sibao_web;
CREATE USER sibao_admin WITH PASSWORD 'ä½ çš„å¼ºå¯†ç ';
GRANT ALL PRIVILEGES ON DATABASE sibao_web TO sibao_admin;
```

### ç¬¬äºŒæ­¥ï¼šæ•°æ®å¯¼å‡ºï¼ˆä»Supabaseï¼‰

#### 2.1 ä½¿ç”¨Supabaseä»ªè¡¨æ¿å¯¼å‡º
1. ç™»å½•ä½ çš„Supabaseé¡¹ç›®
2. è¿›å…¥SQL Editor
3. æ‰§è¡Œå¯¼å‡ºè„šæœ¬ï¼š

```sql
-- å¯¼å‡ºæ‰€æœ‰è¡¨ç»“æ„å’Œæ•°æ®
-- è¿™ä¸ªè„šæœ¬ä¼šç”ŸæˆCREATE TABLEå’ŒINSERTè¯­å¥
```

#### 2.2 ä½¿ç”¨pg_dumpå¯¼å‡ºï¼ˆå¦‚æœæœ‰ç›´æ¥è®¿é—®æƒé™ï¼‰
```bash
# å¦‚æœSupabaseæä¾›ç›´æ¥è¿æ¥
pg_dump "postgresql://ç”¨æˆ·å:å¯†ç @ä½ çš„supabaseåœ°å€:5432/postgres" \
  --no-owner --no-privileges --clean --if-exists \
  -f supabase_backup.sql
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè¡¨ç»“æ„è„šæœ¬

#### 3.1 åˆ›å»ºå®Œæ•´çš„è¡¨ç»“æ„
```sql
-- ç”¨æˆ·æ¡£æ¡ˆè¡¨
CREATE TABLE profiles (
  id UUID PRIMARY KEY,
  username TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  role TEXT DEFAULT 'normal',
  notes TEXT,
  permissions JSONB DEFAULT '[]'::jsonb
);

-- å•†å®¶è¡¨
CREATE TABLE merchants (
  id BIGSERIAL PRIMARY KEY,
  merchant_code TEXT NOT NULL UNIQUE,
  merchant_name TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  merchant_id_code TEXT
);

-- è¿è´¹æˆæœ¬è¡¨ï¼ˆä¸»è¦ä¸šåŠ¡æ•°æ®ï¼‰
CREATE TABLE shipping_costs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  date DATE,
  freight_unit_price NUMERIC,
  total_settle_weight NUMERIC,
  actual_weight_with_box NUMERIC,
  tracking_number TEXT,
  shipment_id TEXT,
  merchants JSONB,
  order_number TEXT,
  settlement_status TEXT,
  box_count INTEGER DEFAULT 0
);

-- Temuå·¥ä½œæµè¡¨
CREATE TABLE temu_workflow (
  id BIGSERIAL PRIMARY KEY,
  cn_send_date DATE,
  main_tracking_id TEXT,
  box_code TEXT,
  box_count INTEGER,
  inner_count INTEGER,
  status TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Temuè´§ä»¶è¯¦æƒ…è¡¨
CREATE TABLE temu_shipment_details (
  id BIGSERIAL PRIMARY KEY,
  workflow_id BIGINT REFERENCES temu_workflow(id),
  merchant TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  scan_channel TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Temuè´§ä»¶IDè¡¨
CREATE TABLE temu_shipment_ids (
  id BIGSERIAL PRIMARY KEY,
  workflow_id BIGINT REFERENCES temu_workflow(id),
  shipment_id_value TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_shipping_costs_date ON shipping_costs(date);
CREATE INDEX idx_shipping_costs_tracking ON shipping_costs(tracking_number);
CREATE INDEX idx_temu_workflow_date ON temu_workflow(cn_send_date);
```

### ç¬¬å››æ­¥ï¼šæ•°æ®å¯¼å…¥åˆ°è…¾è®¯äº‘

#### 4.1 è¿æ¥è…¾è®¯äº‘æ•°æ®åº“
```bash
# ä½¿ç”¨psqlè¿æ¥
psql -h ä½ çš„è…¾è®¯äº‘æ•°æ®åº“åœ°å€ -p 5432 -U sibao_admin -d sibao_web
```

#### 4.2 å¯¼å…¥è¡¨ç»“æ„
```bash
psql -h ä½ çš„è…¾è®¯äº‘æ•°æ®åº“åœ°å€ -p 5432 -U sibao_admin -d sibao_web -f table_structure.sql
```

#### 4.3 å¯¼å…¥æ•°æ®
```bash
psql -h ä½ çš„è…¾è®¯äº‘æ•°æ®åº“åœ°å€ -p 5432 -U sibao_admin -d sibao_web -f data_import.sql
```

---

## ğŸ¯ æ–¹æ¡ˆäºŒï¼šé‡æ–°æ­å»ºè…¾è®¯äº‘æ•°æ®åº“

### ç¬¬ä¸€æ­¥ï¼šè…¾è®¯äº‘PostgreSQLé…ç½®
åŒæ–¹æ¡ˆä¸€çš„æ•°æ®åº“è´­ä¹°å’Œé…ç½®

### ç¬¬äºŒæ­¥ï¼šç›´æ¥åˆ›å»ºæ–°æ•°æ®åº“
```sql
-- æ‰§è¡Œä¸Šé¢çš„å®Œæ•´è¡¨ç»“æ„è„šæœ¬
-- ä¸éœ€è¦å¯¼å…¥ç°æœ‰æ•°æ®ï¼Œä»é›¶å¼€å§‹
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºåˆå§‹ç®¡ç†å‘˜ç”¨æˆ·
```sql
-- æ’å…¥åˆå§‹ç®¡ç†å‘˜è´¦æˆ·ï¼ˆç”¨äºauth.usersè¡¨çš„æ¨¡æ‹Ÿï¼‰
INSERT INTO profiles (id, username, role, created_at, notes, permissions) 
VALUES (
  gen_random_uuid(), 
  'admin', 
  'admin', 
  NOW(), 
  'ç³»ç»Ÿç®¡ç†å‘˜', 
  '["all"]'::jsonb
);
```

---

## ğŸ”§ é¡¹ç›®ä»£ç ä¿®æ”¹

### ç¬¬ä¸€æ­¥ï¼šæ›´æ–°ç¯å¢ƒå˜é‡é…ç½®

#### ä¿®æ”¹.envæ–‡ä»¶
```env
# è…¾è®¯äº‘PostgreSQLé…ç½®
DB_HOST=ä½ çš„è…¾è®¯äº‘æ•°æ®åº“åœ°å€
DB_PORT=5432
DB_NAME=sibao_web
DB_USER=sibao_admin
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_SSL_MODE=require

# Flaské…ç½®
FLASK_SECRET_KEY=ä½ çš„Flaskå¯†é’¥

# å¦‚æœç»§ç»­ä½¿ç”¨Supabase AuthæœåŠ¡ï¼ˆæ¨èï¼‰
SUPABASE_URL=https://ä½ çš„é¡¹ç›®.supabase.co
SUPABASE_SERVICE_ROLE_KEY=ä½ çš„å¯†é’¥

# æˆ–è€…å®Œå…¨ä¸ä½¿ç”¨Supabase
USE_SUPABASE_AUTH=false
```

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹æ•°æ®åº“è¿æ¥ä»£ç 

#### å®‰è£…PostgreSQLé©±åŠ¨
```bash
pip install psycopg2-binary
```

#### æ›´æ–°requirements.txt
```txt
Flask==2.3.2
Werkzeug==2.3.7
psycopg2-binary==2.9.7
python-dotenv==1.0.0
Flask-CORS==4.0.0
gunicorn==20.1.0
# å¦‚æœç»§ç»­ä½¿ç”¨Supabase Auth
supabase==1.0.4
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ•°æ®åº“è¿æ¥æ¨¡å—

åˆ›å»º `database.py` æ–‡ä»¶ï¼š
```python
import os
import psycopg2
from psycopg2.extras import RealDictCursor
from contextlib import contextmanager

class Database:
    def __init__(self):
        self.host = os.environ.get('DB_HOST')
        self.port = os.environ.get('DB_PORT', '5432')
        self.database = os.environ.get('DB_NAME')
        self.user = os.environ.get('DB_USER')
        self.password = os.environ.get('DB_PASSWORD')
        self.sslmode = os.environ.get('DB_SSL_MODE', 'require')
    
    @contextmanager
    def get_connection(self):
        connection = None
        try:
            connection = psycopg2.connect(
                host=self.host,
                port=self.port,
                database=self.database,
                user=self.user,
                password=self.password,
                sslmode=self.sslmode,
                cursor_factory=RealDictCursor
            )
            yield connection
        except Exception as e:
            if connection:
                connection.rollback()
            raise e
        finally:
            if connection:
                connection.close()

db = Database()
```

---

## ğŸ“± å‰ç«¯ä»£ç ä¿®æ”¹

### æ›´æ–°APIè°ƒç”¨
å°†æ‰€æœ‰å‰ç«¯çš„Supabaseè°ƒç”¨æ”¹ä¸ºè°ƒç”¨Flask APIï¼š

#### ä¿®æ”¹JavaScriptï¼ˆä»¥query.htmlä¸ºä¾‹ï¼‰
```javascript
// åŸæ¥çš„Supabaseè°ƒç”¨
// const { data, error } = await supabase.from('shipping_costs').select('*');

// æ”¹ä¸ºFlask APIè°ƒç”¨
async function loadHistoryData() {
  try {
    const response = await fetch('/api/shipping_costs');
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    return [];
  }
}
```

### åˆ›å»ºAPIè·¯ç”±
åœ¨app.pyä¸­æ·»åŠ APIè·¯ç”±ï¼š
```python
@app.route('/api/shipping_costs', methods=['GET'])
@login_required
def get_shipping_costs():
    try:
        with db.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM shipping_costs ORDER BY date DESC")
            results = cursor.fetchall()
            return jsonify([dict(row) for row in results])
    except Exception as e:
        return jsonify({"error": str(e)}), 500
```

---

## âš¡ å¿«é€Ÿè¿ç§»å·¥å…·

### è‡ªåŠ¨åŒ–è¿ç§»è„šæœ¬
```python
#!/usr/bin/env python3
"""
Supabase to è…¾è®¯äº‘PostgreSQL è¿ç§»å·¥å…·
"""
import os
import psycopg2
from supabase import create_client

def migrate_data():
    # Supabaseè¿æ¥
    supabase = create_client(
        os.environ.get("SUPABASE_URL"),
        os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
    )
    
    # è…¾è®¯äº‘PostgreSQLè¿æ¥
    tencent_conn = psycopg2.connect(
        host=os.environ.get("DB_HOST"),
        database=os.environ.get("DB_NAME"),
        user=os.environ.get("DB_USER"),
        password=os.environ.get("DB_PASSWORD")
    )
    
    # è¿ç§»æ¯ä¸ªè¡¨çš„æ•°æ®
    tables = ['profiles', 'merchants', 'shipping_costs', 'temu_workflow', 
              'temu_shipment_details', 'temu_shipment_ids']
    
    for table in tables:
        print(f"è¿ç§»è¡¨: {table}")
        # ä»Supabaseè·å–æ•°æ®
        response = supabase.from_(table).select("*").execute()
        data = response.data
        
        # æ’å…¥åˆ°è…¾è®¯äº‘æ•°æ®åº“
        if data:
            # è¿™é‡Œéœ€è¦æ ¹æ®æ¯ä¸ªè¡¨çš„ç»“æ„æ¥å†™å…·ä½“çš„æ’å…¥é€»è¾‘
            insert_data_to_tencent(tencent_conn, table, data)
        
        print(f"âœ… {table} è¿ç§»å®Œæˆï¼Œå…± {len(data)} æ¡è®°å½•")

if __name__ == "__main__":
    migrate_data()
```

---

## ğŸš€ æ¨èè¿ç§»æ­¥éª¤

### æœ€ä½³å®è·µæµç¨‹ï¼š
1. **å‡†å¤‡é˜¶æ®µ**ï¼ˆ1å¤©ï¼‰
   - è´­ä¹°è…¾è®¯äº‘PostgreSQL
   - å¤‡ä»½Supabaseæ•°æ®
   - å‡†å¤‡è¿ç§»è„šæœ¬

2. **æµ‹è¯•è¿ç§»**ï¼ˆ1å¤©ï¼‰
   - åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´æµ‹è¯•è¿ç§»æµç¨‹
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - æµ‹è¯•åº”ç”¨åŠŸèƒ½

3. **æ­£å¼è¿ç§»**ï¼ˆåŠå¤©ï¼‰
   - åœæ­¢ç”Ÿäº§ç¯å¢ƒå†™å…¥
   - æ‰§è¡Œæ•°æ®è¿ç§»
   - æ›´æ–°åº”ç”¨é…ç½®
   - å¯åŠ¨æ–°ç¯å¢ƒ

4. **éªŒè¯å’Œä¼˜åŒ–**ï¼ˆ1å¤©ï¼‰
   - å…¨é¢åŠŸèƒ½æµ‹è¯•
   - æ€§èƒ½ä¼˜åŒ–
   - ç›‘æ§è®¾ç½®

---

## ğŸ’° æˆæœ¬å¯¹æ¯”

### Supabaseï¼ˆå½“å‰ï¼‰
- å…è´¹é¢åº¦æœ‰é™
- æµ·å¤–è®¿é—®å»¶è¿Ÿé«˜
- æ•°æ®ä¼ è¾“è´¹ç”¨

### è…¾è®¯äº‘PostgreSQL
- åŸºç¡€ç‰ˆï¼šçº¦200-300å…ƒ/æœˆ
- å›½å†…è®¿é—®é€Ÿåº¦å¿«
- æ•°æ®å®‰å…¨æ€§é«˜

---

## ğŸ¤” å»ºè®®

åŸºäºä½ çš„æƒ…å†µï¼Œæˆ‘å»ºè®®ï¼š

1. **å¦‚æœæœ‰é‡è¦ä¸šåŠ¡æ•°æ®**ï¼šé€‰æ‹©æ–¹æ¡ˆä¸€ï¼ˆæ•°æ®è¿ç§»ï¼‰
2. **å¦‚æœæ•°æ®ä¸å¤šæˆ–å¯ä»¥é‡æ–°å½•å…¥**ï¼šé€‰æ‹©æ–¹æ¡ˆäºŒï¼ˆé‡æ–°æ­å»ºï¼‰
3. **æ¸è¿›å¼è¿ç§»**ï¼šå…ˆä¿æŒSupabase Authï¼Œåªè¿ç§»æ•°æ®åº“
4. **å®Œå…¨è¿ç§»**ï¼šåç»­å¯ä»¥ç”¨è…¾è®¯äº‘çš„èº«ä»½è®¤è¯æœåŠ¡

ä½ æƒ³é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿæˆ‘å¯ä»¥ä¸ºä½ æä¾›æ›´è¯¦ç»†çš„å®æ–½æŒ‡å¯¼ã€‚ 