<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘è´§è´¹ç”¨åˆ†æ‘Šè¡¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36D399',
            neutral: '#F9FAFB',
            'neutral-dark': '#1F2937',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <script>
    // ç°åœ¨ä½¿ç”¨MySQL APIï¼Œä¸å†éœ€è¦Supabase
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary-color: #3B82F6;
      --secondary-color: #10B981;
      --accent-color: #F59E0B;
      --danger-color: #EF4444;
      --warning-color: #F59E0B;
      --success-color: #10B981;
      --info-color: #3B82F6;
      --light-color: #F8FAFC;
      --dark-color: #1E293B;
      --neutral-dark: #374151;
      --border-color: #E5E7EB;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .font-inter { font-family: 'Inter', sans-serif; }
    .bg-primary { background-color: var(--primary-color); }
    .bg-secondary { background-color: var(--secondary-color); }
    .bg-accent { background-color: var(--accent-color); }
    .bg-danger { background-color: var(--danger-color); }
    .bg-warning { background-color: var(--warning-color); }
    .bg-success { background-color: var(--success-color); }
    .bg-info { background-color: var(--info-color); }
    .bg-light { background-color: var(--light-color); }
    .bg-dark { background-color: var(--dark-color); }
    .text-primary { color: var(--primary-color); }
    .text-secondary { color: var(--secondary-color); }
    .text-accent { color: var(--accent-color); }
    .text-danger { color: var(--danger-color); }
    .text-warning { color: var(--warning-color); }
    .text-success { color: var(--success-color); }
    .text-info { color: var(--info-color); }
    .text-light { color: var(--light-color); }
    .text-dark { color: var(--dark-color); }
    .text-neutral-dark { color: var(--neutral-dark); }
    .border-color { border-color: var(--border-color); }
    .shadow-sm { box-shadow: var(--shadow-sm); }
    .shadow-md { box-shadow: var(--shadow-md); }
    .shadow-lg { box-shadow: var(--shadow-lg); }
    .shadow-xl { box-shadow: var(--shadow-xl); }

    .gradient-primary { background: var(--gradient-primary); }
    .gradient-secondary { background: var(--gradient-secondary); }
    .gradient-success { background: var(--gradient-success); }

    /* æ·»åŠ æ›´å¤šè‡ªå®šä¹‰æ ·å¼ */
    .btn-hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
  </style>
</head>
<body class="bg-gray-50 font-inter text-neutral-dark">

  <!-- å¼•å…¥ç”¨æˆ·çŠ¶æ€æ  -->
  {% include 'user_status_bar.html' %}

  <div class="container mx-auto px-4 py-8 max-w-full xl:max-w-7xl">
    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
      <!-- æ–°å¢ï¼šé¡µé¢æ ‡é¢˜å’Œè¿”å›æŒ‰é’® -->
      <div class="flex justify-between items-center w-full md:w-auto mb-4 md:mb-0">
      <div>
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-primary">å‘è´§è´¹ç”¨åˆ†æ‘Šè¡¨</h1>
        <p class="text-gray-500 mt-1">é«˜æ•ˆç®¡ç†å’Œè®¡ç®—æ¯æ—¥å‘è´§è´¹ç”¨</p>
        </div>
        <a href="{{ url_for('pt_function_interface') }}" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg transform hover:translate-y-[-2px] hover:shadow-xl ml-4">
            <i class="fa fa-arrow-left mr-2"></i> è¿”å›åŠŸèƒ½åˆ—è¡¨
        </a>
      </div>
      
      <div class="flex flex-wrap gap-3 w-full md:w-auto">
        <button id="addRowBtn" class="bg-secondary text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg">
          <i class="fa fa-plus mr-2"></i> æ·»åŠ å•†æˆ·
        </button>
        <button id="downloadExcelBtn" class="bg-primary text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg">
          <i class="fa fa-download mr-2"></i> å¯¼å‡ºExcel
        </button>
        <button id="calculateBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg">
          <i class="fa fa-calculator mr-2"></i> é‡æ–°è®¡ç®—
        </button>
        <button id="saveDataBtn" class="bg-orange-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg">
            <i class="fa fa-save mr-2"></i> ä¿å­˜æ•°æ®
        </button>
        <a href="{{ url_for('query_html') }}" target="_blank" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg">
            <i class="fa fa-search mr-2"></i> æ•°æ®æŸ¥è¯¢
        </a>
      </div>
    </div>
    
    <!-- é¡¶éƒ¨æ±‡æ€»ä¿¡æ¯ -->
    <div class="bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 rounded-2xl p-8 mb-8 border border-blue-100/50" 
         style="box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);">
      
      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <div class="mb-6">
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-2">
          å‘è´§è´¹ç”¨åˆ†æ‘Šè¡¨
        </h2>
        <p class="text-gray-600 text-sm">é«˜æ•ˆç®¡ç†å’Œè®¡ç®—æ¯æ—¥å‘è´§è´¹ç”¨</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- å·¦åˆ—: åŸºç¡€ä¿¡æ¯ -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
            <div class="w-1 h-6 bg-gradient-to-b from-blue-500 to-indigo-500 rounded-full mr-3"></div>
            åŸºç¡€ä¿¡æ¯
          </h3>
          
          <div class="space-y-4">
            <div class="group">
              <label for="dateInput" class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
              <input type="date" id="dateInput" value="2025-05-29" 
                     class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl 
                            focus:ring-4 focus:ring-blue-100 focus:border-blue-400 
                            hover:border-blue-300 transition-all duration-300
                            text-gray-800 font-medium shadow-sm">
            </div>
            
            <div class="group">
              <label for="orderNumber" class="block text-sm font-medium text-gray-700 mb-2">è¡¨å•ç¼–å·</label>
              <input type="text" id="orderNumber" 
                     class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl 
                            focus:ring-4 focus:ring-blue-100 focus:border-blue-400 
                            hover:border-blue-300 transition-all duration-300
                            text-gray-800 font-medium shadow-sm"
                     placeholder="è‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥">
            </div>
            
            <div class="group">
              <label for="trackingNumber" class="block text-sm font-medium text-gray-700 mb-2">å¿«é€’å•å·</label>
              <input type="text" id="trackingNumber" 
                     class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl 
                            focus:ring-4 focus:ring-blue-100 focus:border-blue-400 
                            hover:border-blue-300 transition-all duration-300
                            text-gray-800 font-medium shadow-sm"
                     placeholder="è¯·è¾“å…¥å¿«é€’å•å·">
            </div>
            
            <div class="group">
              <label for="shipmentId" class="block text-sm font-medium text-gray-700 mb-2">è´§ä»¶ID</label>
              <input type="text" id="shipmentId" 
                     class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl 
                            focus:ring-4 focus:ring-blue-100 focus:border-blue-400 
                            hover:border-blue-300 transition-all duration-300
                            text-gray-800 font-medium shadow-sm"
                     placeholder="è¯·è¾“å…¥è´§ä»¶ID">
            </div>
          </div>
        </div>
        
        <!-- ä¸­åˆ—: é‡é‡ä¸è´¹ç”¨ -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
            <div class="w-1 h-6 bg-gradient-to-b from-green-500 to-teal-500 rounded-full mr-3"></div>
            é‡é‡ä¸è´¹ç”¨
          </h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                              <div class="group">
                  <label for="freightUnitPrice" class="block text-sm font-medium text-gray-700 mb-2">è¿è´¹å•ä»·</label>
                  <input type="number" id="freightUnitPrice" value="" min="0" step="0.01"
                         class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl 
                                focus:ring-4 focus:ring-blue-100 focus:border-blue-400 
                                hover:border-blue-300 transition-all duration-300
                                text-gray-800 font-medium shadow-sm text-center"
                         placeholder="è¯·è¾“å…¥è¿è´¹å•ä»·">
                </div>
              
              <div class="group">
                <label for="boxCountInput" class="block text-sm font-medium text-gray-700 mb-2">ç®±æ•°</label>
                <div class="relative">
                  <input type="number" id="boxCountInput" min="0" step="1" value=""
                         class="w-full px-4 py-3 bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl 
                                focus:ring-4 focus:ring-orange-100 focus:border-orange-400 focus:bg-white
                                hover:border-orange-300 hover:shadow-md transition-all duration-300
                                text-gray-800 font-semibold shadow-sm text-right pr-10"
                         placeholder="0">
                  <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-orange-600 font-medium">ç®±</span>
                </div>
              </div>
            </div>
            
            <div class="group">
              <label for="totalSettleWeight" class="block text-sm font-medium text-gray-700 mb-2">æ€»ç»“ç®—é‡é‡</label>
              <div class="relative">
                <input type="number" id="totalSettleWeight" step="0.001"
                       class="w-full px-4 py-3 bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-300 rounded-xl 
                              focus:ring-4 focus:ring-yellow-100 focus:border-yellow-400 
                              hover:border-yellow-400 transition-all duration-300
                              text-gray-800 font-bold shadow-sm text-right pr-10">
                <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-yellow-600 font-medium">kg</span>
              </div>
            </div>
            
            <div class="group">
              <label for="actualWeightWithBox" class="block text-sm font-medium text-gray-700 mb-2">å®é‡+çº¸ç®±</label>
              <div class="relative">
                <input type="number" id="actualWeightWithBox" step="0.001"
                       class="w-full px-4 py-3 bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-300 rounded-xl 
                              focus:ring-4 focus:ring-yellow-100 focus:border-yellow-400 
                              hover:border-yellow-400 transition-all duration-300
                              text-gray-800 font-bold shadow-sm text-right pr-10">
                <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-yellow-600 font-medium">kg</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å³åˆ—: æ±‡æ€»ä¿¡æ¯ -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
            <div class="w-1 h-6 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full mr-3"></div>
            æ±‡æ€»ä¿¡æ¯
          </h3>
          
          <div class="space-y-4">
            <!-- ä»Šæ—¥è¿è´¹ - çªå‡ºæ˜¾ç¤º -->
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-4 text-white">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium opacity-90">ä»Šæ—¥è¿è´¹</span>
                <span id="totalFreight" class="text-2xl font-bold">Â¥0.00</span>
              </div>
            </div>
            
            <!-- å…¶ä»–æ±‡æ€»ä¿¡æ¯ -->
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">è´§ç‰©å®é‡</div>
                <div id="actualWeightSum" class="font-semibold text-gray-800">0.000 kg</div>
              </div>
              
              <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">çº¸ç®±é‡é‡</div>
                <div id="boxWeight" class="font-semibold text-gray-800">0.000 kg</div>
              </div>
              
              <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">æŠ›å‡ºé‡é‡</div>
                <div id="throwOut" class="font-semibold text-gray-800">0.000 kg</div>
              </div>
              
              <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">ç®±æ•°</div>
                <div id="boxCount" class="font-semibold text-gray-800">0</div>
              </div>
            </div>
            
            <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm">
              <div class="text-xs text-gray-500 mb-1">å•†æˆ·æ•°é‡</div>
              <div id="merchantCount" class="font-semibold text-gray-800 text-center">0</div>
            </div>
          </div>
        </div>

        <!-- è´¹ç”¨åˆ†å¸ƒå›¾è¡¨ - ç§»åŠ¨åˆ°å³ä¸Šè§’ -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
            <div class="w-1 h-6 bg-gradient-to-b from-pink-500 to-rose-500 rounded-full mr-3"></div>
            è´¹ç”¨åˆ†å¸ƒ
          </h3>
          <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
            <div class="h-64">
              <canvas id="distributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å•†æˆ·æ˜ç»†è¡¨æ ¼ -->
    <div class="bg-white rounded-xl overflow-hidden mb-8" style="box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-gradient-to-r from-gray-50 to-gray-100">
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">åºå·</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200" style="min-width: 140px;">å•†æˆ·</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">ä»¶æ•°</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">è´§ç‰©å®é‡ (kg)</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">æ¯”ä¾‹</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">å çº¸ç®±(kg)</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">å æŠ›å‡º(kg)</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">ç»“ç®—é‡é‡ (kg)</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center border-r border-gray-200">åˆè®¡é‡‘é¢ (Â¥)</th>
              <th class="px-3 py-2 font-semibold text-gray-700 text-sm text-center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="detailTable">
            <tr class="border-b border-gray-200 hover:bg-blue-50/50 transition-colors">
              <td class="px-3 py-2 text-center text-sm">1</td>
              <td class="px-3 py-2 text-center" style="min-width: 140px;">
                <input type="text" value="" class="merchant-input w-full px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 hover:border-blue-400 transition-colors text-sm" list="merchantList" placeholder="è¯·é€‰æ‹©å•†æˆ·">
              </td>
              <td class="px-3 py-2 text-center">
                <input type="number" value="" class="pieces-input w-full px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 hover:border-blue-400 transition-colors text-sm" step="1" placeholder="0">
              </td>
              <td class="px-3 py-2 text-center">
                <input type="number" value="" class="weight-input w-full px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 hover:border-blue-400 transition-colors text-sm" step="0.001" placeholder="0.000">
              </td>
              <td class="px-3 py-2 text-center text-sm font-medium text-blue-600 rate-cell">0.00%</td>
              <td class="px-3 py-2 text-center">
                <input type="number" value="0" class="box-input w-full px-2 py-1 text-center border border-gray-300 rounded-md bg-gray-50 text-gray-600 text-sm" step="0.001" readonly>
              </td>
              <td class="px-3 py-2 text-center">
                <input type="number" value="0" class="throw-input w-full px-2 py-1 text-center border border-gray-300 rounded-md bg-gray-50 text-gray-600 text-sm" step="0.001" readonly>
              </td>
              <td class="px-3 py-2 text-center text-sm font-semibold text-gray-800 settle-weight-cell">0.000</td>
              <td class="px-3 py-2 text-center text-sm font-semibold text-green-600 amount-cell">0.00</td>
              <td class="px-3 py-2 text-center">
                <button class="delete-row text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors">
                  <i class="fa fa-trash text-sm"></i>
                </button>
              </td>
            </tr>
            <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 font-semibold border-t-2 border-blue-200">
              <td colspan="2" class="px-3 py-2 text-center text-sm font-bold text-gray-700">åˆè®¡:</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-pieces">0</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-actual-weight">0.000</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-blue-600">0.00%</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-box-weight">0.000</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-throw">0.000</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-indigo-600 total-settle-weight">0.000</td>
              <td class="px-3 py-2 text-center text-sm font-bold text-green-600 total-amount">0.00</td>
              <td class="px-3 py-2 text-center"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="text-center text-gray-500 text-sm py-4">
      <p>å‘è´§è´¹ç”¨åˆ†æ‘Šè¡¨ &copy; 2025</p>
    </footer>
  </div>

  <audio id="notificationSound" src="https://www.orangefreesounds.com/wp-content/uploads/2020/04/Alert-notification.mp3" preload="auto"></audio>

  <!-- Datalist for merchants -->
  <datalist id="merchantList"></datalist>

  <script>
    // åˆå§‹åŒ–å›¾è¡¨
    let distributionChart;
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      // ç°åœ¨ä½¿ç”¨ MySQL APIï¼Œä¸éœ€è¦Supabase é…ç½®

      // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„é»˜è®¤å€¼å’Œç›‘å¬
      const dateInput = document.getElementById('dateInput');
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      dateInput.value = `${year}-${month}-${day}`;

      // ç›‘å¬æ—¥æœŸå˜åŒ–ï¼Œå½“æ—¥æœŸæ”¹å˜æ—¶ï¼Œé‡æ–°ç”Ÿæˆè¡¨å•ç¼–å·
      dateInput.addEventListener('change', function() {
          loadDataFromUrlOrReset(true); // ä¼ å…¥true è¡¨ç¤ºå¼ºåˆ¶é‡ç½®å¹¶ç”Ÿæˆæ–°ç¼–å·
      });

      // åˆå§‹åŒ–å›¾è¡¨
      initChart();
      
      // ç»‘å®šäº‹ä»¶
      console.log('ğŸ”µ å¼€å§‹ç»‘å®šæŒ‰é’®äº‹ä»¶...');
      
      const saveBtn = document.getElementById('saveDataBtn');
      console.log('ğŸ”µ ä¿å­˜æŒ‰é’®å…ƒç´ :', saveBtn);
      
      document.getElementById('addRowBtn').addEventListener('click', () => addNewRow());
      document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);
      document.getElementById('calculateBtn').addEventListener('click', resetForm);
      
      if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
          console.log('ğŸ”µ ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»!', e);
          saveData();
        });
        console.log('ğŸ”µ ä¿å­˜æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ°ä¿å­˜æŒ‰é’®å…ƒç´ !');
      }

      document.getElementById('freightUnitPrice').addEventListener('change', calculateAll);
      document.getElementById('totalSettleWeight').addEventListener('change', calculateAll);
      document.getElementById('actualWeightWithBox').addEventListener('change', calculateAll);
      
      // ä¸ºè¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
      bindInputEvents();
      
      // ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨
      ensureTotalRowExists();
      
      // åˆå§‹æ—¶åŠ è½½æ•°æ®ï¼ˆæ ¹æ®URLå‚æ•°æˆ–é‡ç½®è¡¨å•ï¼‰
      loadDataFromUrlOrReset();

      // åŠ è½½å•†æˆ·åˆ—è¡¨
      populateMerchantDatalist();
    });
    
    // åˆå§‹åŒ–å›¾è¡¨
    function initChart() {
      const ctx = document.getElementById('distributionChart').getContext('2d');
      const isMobile = window.innerWidth < 768;
      
      // è·å–æ•°æ®
      const labels = Array.from(document.querySelectorAll('.merchant-input')).map(input => input.value);
      const amounts = Array.from(document.querySelectorAll('.amount-cell')).map(cell => parseFloat(cell.textContent));
      
      // åˆ›å»ºå›¾è¡¨
      distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: amounts,
            backgroundColor: [
              '#165DFF', '#36D399', '#F87272', '#A78BFA',
              '#FBBF24', '#FB7185', '#60A5FA', '#818CF8'
            ],
            borderWidth: 1,
            borderColor: '#FFFFFF'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: isMobile ? 'top' : 'right',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: Â¥${value.toFixed(2)} (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateScale: true,
            animateRotate: true
          }
        }
      });

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–ä»¥è°ƒæ•´å›¾è¡¨
      window.addEventListener('resize', () => {
        const newIsMobile = window.innerWidth < 768;
        const newPosition = newIsMobile ? 'top' : 'right';
        if (distributionChart && distributionChart.options.plugins.legend.position !== newPosition) {
          distributionChart.options.plugins.legend.position = newPosition;
          distributionChart.update();
        }
      });
    }
    
    // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
    function bindInputEvents() {
      // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
      document.querySelectorAll('.weight-input, .pieces-input').forEach(input => {
        input.removeEventListener('input', calculateAll); // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬
        input.removeEventListener('change', calculateAll);
        input.addEventListener('input', calculateAll); // æ·»åŠ inputäº‹ä»¶ï¼ˆå®æ—¶æ›´æ–°ï¼‰
        input.addEventListener('change', calculateAll); // æ·»åŠ changeäº‹ä»¶ï¼ˆå¤±å»ç„¦ç‚¹æ—¶æ›´æ–°ï¼‰
      });
      
      // ä¸ºåˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
      document.querySelectorAll('.delete-row').forEach(button => {
        button.removeEventListener('click', deleteRowHandler);
        button.addEventListener('click', deleteRowHandler);
      });

      // ä¸ºå•†æˆ·è¾“å…¥æ¡†ç»‘å®šchangeäº‹ä»¶
      document.querySelectorAll('.merchant-input').forEach(input => {
        input.removeEventListener('change', merchantInputHandler);
        input.addEventListener('change', merchantInputHandler);
      });
    }
    
    // åˆ é™¤è¡Œå¤„ç†å‡½æ•°
    function deleteRowHandler() {
      const row = this.closest('tr');
      const dataRows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
      if (dataRows.length > 1) { // è‡³å°‘ä¿ç•™ä¸€æ¡å•†æˆ·è®°å½•
        row.remove();
        renumberRows();
        calculateAll();
        ensureTotalRowExists(); // ç¡®ä¿åˆè®¡è¡Œä»ç„¶å­˜åœ¨
      } else {
        alert('è‡³å°‘ä¿ç•™ä¸€æ¡å•†æˆ·è®°å½•');
      }
    }
    
    // å•†æˆ·è¾“å…¥æ¡†å¤„ç†å‡½æ•°
    function merchantInputHandler() {
      // å¦‚æœ value æ˜¯"name (code)"ï¼Œåªä¿ç•™ name
      const match = this.value.match(/^(.+?) \([^)]+\)$/);
      if (match) this.value = match[1];
    }
    
    // æ·»åŠ æ–°è¡Œ
    function addNewRow(name = '', weight = '0', pieces = '1', shouldCalculate = true) {
      const tbody = document.getElementById('detailTable');
      
      const newRow = document.createElement('tr');
      newRow.className = 'border-b border-gray-200 hover:bg-blue-50/50 transition-colors';
      newRow.innerHTML = `
        <td class="px-3 py-2 text-center text-sm">${tbody.querySelectorAll('tr').length}</td>
        <td class="px-3 py-2 text-center" style="min-width: 140px;">
          <input type="text" value="${name}" class="merchant-input w-full px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 hover:border-blue-400 transition-colors text-sm" list="merchantList">
        </td>
        <td class="px-3 py-2 text-center">
          <input type="number" value="${pieces}" class="pieces-input w-full px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 hover:border-blue-400 transition-colors text-sm" step="1">
        </td>
        <td class="px-3 py-2 text-center">
          <input type="number" value="${weight}" class="weight-input w-full px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 hover:border-blue-400 transition-colors text-sm" step="0.001">
        </td>
        <td class="px-3 py-2 text-center text-sm font-medium text-blue-600 rate-cell">0.00%</td>
        <td class="px-3 py-2 text-center">
          <input type="number" value="0" class="box-input w-full px-2 py-1 text-center border border-gray-300 rounded-md bg-gray-50 text-gray-600 text-sm" step="0.001" readonly>
        </td>
        <td class="px-3 py-2 text-center">
          <input type="number" value="0" class="throw-input w-full px-2 py-1 text-center border border-gray-300 rounded-md bg-gray-50 text-gray-600 text-sm" step="0.001" readonly>
        </td>
        <td class="px-3 py-2 text-center text-sm font-semibold text-gray-800 settle-weight-cell">0</td>
        <td class="px-3 py-2 text-center text-sm font-semibold text-green-600 amount-cell">0</td>
        <td class="px-3 py-2 text-center">
          <button class="delete-row text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors">
            <i class="fa fa-trash text-sm"></i>
          </button>
        </td>
      `;
      
      // ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨ï¼Œç„¶ååœ¨åˆè®¡è¡Œå‰æ’å…¥æ–°è¡Œ
      ensureTotalRowExists();
      const totalRow = tbody.querySelector('tr.bg-gradient-to-r.from-blue-50.to-indigo-50');
      if (totalRow) {
        tbody.insertBefore(newRow, totalRow);
      } else {
        tbody.appendChild(newRow);
      }
      
      // é‡æ–°ç¼–å·
      renumberRows();
      
      // ç»‘å®šæ–°è¡Œçš„äº‹ä»¶
      bindInputEvents();
      
      if (shouldCalculate) {
        // èšç„¦åˆ°æ–°è¡Œçš„å•†æˆ·åç§°è¾“å…¥æ¡†
        newRow.querySelector('.merchant-input').focus();
        // é‡æ–°è®¡ç®—
        calculateAll();
      }
    }
    
    // é‡æ–°ç¼–å·
    function renumberRows() {
      const rows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
      rows.forEach((row, index) => {
        row.querySelector('td:first-child').textContent = index + 1;
      });
      
      // æ›´æ–°å•†æˆ·æ•°é‡
      document.getElementById('merchantCount').textContent = rows.length;
    }
    
    /**
     * ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨äºè¡¨æ ¼åº•éƒ¨
     */
    function ensureTotalRowExists() {
      const tbody = document.getElementById('detailTable');
      const totalRow = tbody.querySelector('tr.bg-gradient-to-r.from-blue-50.to-indigo-50');
      
      if (!totalRow) {
        // å¦‚æœåˆè®¡è¡Œä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
        const newTotalRow = document.createElement('tr');
        newTotalRow.className = 'bg-gradient-to-r from-blue-50 to-indigo-50 font-semibold border-t-2 border-blue-200';
        newTotalRow.innerHTML = `
          <td colspan="2" class="px-3 py-2 text-center text-sm font-bold text-gray-700">åˆè®¡:</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-pieces">0</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-actual-weight">0.000</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-blue-600">100.00%</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-box-weight">0.000</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-blue-600 total-throw">0.000</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-indigo-600 total-settle-weight">0.000</td>
          <td class="px-3 py-2 text-center text-sm font-bold text-green-600 total-amount">0.00</td>
          <td class="px-3 py-2 text-center"></td>
        `;
        tbody.appendChild(newTotalRow);
      }
    }
    
    /**
     * è·å–æ‰€æœ‰å•†æˆ·çš„æ€»å®é™…é‡é‡
     * @returns {number} æ€»å®é™…é‡é‡
     */
    function getTotalActualWeight() {
        let total = 0;
        const rows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
        rows.forEach(row => {
            const weightInput = row.querySelector('.weight-input');
            if (weightInput) {
                total += parseFloat(weightInput.value) || 0;
            }
        });
        return total;
    }

    /**
     * é‡ç½®è¡¨å•è¾“å…¥æ¡†ï¼ˆé™¤äº†è®¢å•å·ï¼‰
     */
    function resetFormInputs() {
        document.getElementById('dateInput').value = '';
        document.getElementById('freightUnitPrice').value = '';
        document.getElementById('totalSettleWeight').value = '';
        document.getElementById('actualWeightWithBox').value = '';
        document.getElementById('trackingNumber').value = '';
        document.getElementById('shipmentId').value = '';
        document.getElementById('boxCountInput').value = '';
    }

    /**
     * ä¿å­˜å½“å‰æ•°æ®åˆ°è…¾è®¯äº‘ MySQL æ•°æ®åº“çš„ shipping_costs è¡¨
     * @async
     * @returns {Promise<void>}
     */
    async function saveData() {
        console.log('ğŸ”µ saveDataå‡½æ•°è¢«è°ƒç”¨');
        
        // æ˜¾ç¤ºä¸€ä¸ªç«‹å³çš„æç¤ºï¼Œç¡®è®¤å‡½æ•°è¢«è°ƒç”¨
        Swal.fire({
            title: 'æ­£åœ¨ä¿å­˜...',
            text: 'è¯·ç¨å€™',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });

        const date = document.getElementById('dateInput').value;
        if (!date) {
            Swal.fire('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸï¼', 'error');
            return;
        }

        const orderNumber = document.getElementById('orderNumber').value;
        if (!orderNumber) {
            Swal.fire('é”™è¯¯', 'è¯·å…ˆç”Ÿæˆè¡¨å•ç¼–å·ï¼', 'error');
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼ï¼ˆURLä¸­æœ‰order_numberå‚æ•°ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const isEditMode = urlParams.get('order_number') && urlParams.get('order_number') === orderNumber;

        const dataToSave = {
            date: date,
            order_number: orderNumber,
            freight_unit_price: parseFloat(document.getElementById('freightUnitPrice').value) || 0,
            total_settle_weight: parseFloat(document.getElementById('totalSettleWeight').value) || 0,
            actual_weight_with_box: parseFloat(document.getElementById('actualWeightWithBox').value) || 0,
            tracking_number: document.getElementById('trackingNumber').value || '',
            shipment_id: document.getElementById('shipmentId').value || '',
            box_count: parseInt(document.getElementById('boxCountInput').value, 10) || 0,
            merchants: []
        };

        const rows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
        rows.forEach(row => {
            const merchantNameInput = row.querySelector('.merchant-input');
            const weightInput = row.querySelector('.weight-input');
            const piecesInput = row.querySelector('.pieces-input');
            
            if (merchantNameInput && weightInput && piecesInput) {
                const merchantName = merchantNameInput.value;
                const weight = parseFloat(weightInput.value) || 0;
                const pieces = parseInt(piecesInput.value, 10) || 0;
                
                // è·å–è®¡ç®—å¥½çš„å­—æ®µ
                const settleWeight = parseFloat(row.querySelector('.settle-weight-cell')?.textContent) || 0;
                const amount = parseFloat(row.querySelector('.amount-cell')?.textContent) || 0;
                
                // è®¡ç®—æ¯”ä¾‹
                const totalActualWeight = getTotalActualWeight();
                const weightRatio = totalActualWeight > 0 ? (weight / totalActualWeight * 100) : 0;
                
                // è·å–å çº¸ç®±å’Œå æŠ›å‡ºé‡é‡
                const boxWeightCell = row.querySelector('td:nth-child(6)');
                const throwWeightCell = row.querySelector('td:nth-child(7)');
                const boxWeight = boxWeightCell ? parseFloat(boxWeightCell.textContent) || 0 : 0;
                const throwWeight = throwWeightCell ? parseFloat(throwWeightCell.textContent) || 0 : 0;
                
                if (merchantName && weight > 0) {
                    dataToSave.merchants.push({
                        merchant_name: merchantName,
                        pieces: pieces,
                        weight: weight,
                        weight_ratio: weightRatio,
                        box_weight: boxWeight,
                        throw_weight: throwWeight,
                        settle_weight: settleWeight,
                        amount: amount
                    });
                }
            }
        });

        console.log('ğŸ“Š å‡†å¤‡ä¿å­˜çš„æ•°æ®:', dataToSave);
        console.log('ğŸ“ ç¼–è¾‘æ¨¡å¼:', isEditMode);

        try {
            let response;
            if (isEditMode) {
                // ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨ PUT æ–¹æ³•æ›´æ–°æ•°æ®
                console.log('ğŸ”„ ä½¿ç”¨ç¼–è¾‘æ¨¡å¼æ›´æ–°æ•°æ®');
                response = await fetch(`/api/shipping_allocations/${encodeURIComponent(orderNumber)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSave)
                });
            } else {
                // æ–°å¢æ¨¡å¼ï¼šä½¿ç”¨ POST æ–¹æ³•åˆ›å»ºæ•°æ®
                console.log('â• ä½¿ç”¨æ–°å¢æ¨¡å¼åˆ›å»ºæ•°æ®');
                response = await fetch('/api/shipping_allocations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSave)
                });
            }

            console.log('ğŸŒ APIå“åº”çŠ¶æ€:', response.status);

            if (response.status === 401) {
                Swal.fire('è®¤è¯å¤±è´¥', 'æ‚¨çš„ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                return;
            }

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const result = await response.json();
            console.log('ğŸ“„ APIå“åº”ç»“æœ:', result);

            if (result.success) {
                const action = isEditMode ? 'æ›´æ–°' : 'ä¿å­˜';
                Swal.fire('æˆåŠŸ!', `åˆ†æ‘Šæ•°æ®å·²æˆåŠŸ${action}åˆ°æ•°æ®åº“`, 'success');
                
                // å¦‚æœæ˜¯æ–°å¢æ¨¡å¼ï¼Œæ›´æ–°URLå‚æ•°ä»¥åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                if (!isEditMode) {
                    const newUrl = `${window.location.pathname}?order_number=${encodeURIComponent(orderNumber)}`;
                    window.history.replaceState({}, '', newUrl);
                }
            } else {
                throw new Error(result.message || `${isEditMode ? 'æ›´æ–°' : 'ä¿å­˜'}å¤±è´¥`);
            }
        } catch (error) {
            console.error('ğŸ’¥ ä¿å­˜/æ›´æ–°å¤±è´¥:', error);
            Swal.fire('é”™è¯¯', `æ•°æ®${isEditMode ? 'æ›´æ–°' : 'ä¿å­˜'}å¤±è´¥: ` + error.message, 'error');
        }
    }

    /**
     * ä»URLè·å– order_number å‚æ•°ï¼Œå¹¶æ ¹æ®è¯¥å‚æ•°åŠ è½½æ•°æ®ï¼Œæˆ–é‡ç½®è¡¨å•
     * @async
     * @returns {Promise<void>}
     */
    async function loadDataFromUrlOrReset(forceNewOrderNumber = false) {
        const urlParams = new URLSearchParams(window.location.search);
        const orderNumberFromUrl = urlParams.get('order_number');
        
        const tbody = document.getElementById('detailTable');
        
        // ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨
        ensureTotalRowExists();
        
        // æ¸…é™¤ç°æœ‰çš„æ•°æ®è¡Œï¼ˆä¿ç•™åˆè®¡è¡Œï¼‰
        const rows = tbody.querySelectorAll('tr:not(.bg-gradient-to-r)');
        rows.forEach(row => row.remove());

        const dateInput = document.getElementById('dateInput');
        const orderNumberInput = document.getElementById('orderNumber');

        if (orderNumberFromUrl && !forceNewOrderNumber) {
            // å¦‚æœ URL ä¸­æœ‰ order_number ä¸”ä¸æ˜¯å¼ºåˆ¶ç”Ÿæˆæ–°ç¼–å·ï¼Œåˆ™å°è¯•ä»MySQLæ•°æ®åº“åŠ è½½æ•°æ®
            try {
                // é¦–å…ˆå°è¯•ä»æ–°çš„APIè·å–æ•°æ®
                const response = await fetch(`/api/shipping_allocations/${encodeURIComponent(orderNumberFromUrl)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    console.error('ä»æ•°æ®åº“åŠ è½½æ•°æ®å¤±è´¥', result.message);
                    Swal.fire('é”™è¯¯', 'åŠ è½½æ•°æ®å¤±è´¥: ' + result.message, 'error');
                    resetFormInputs(); // Reset inputs if loading fails
                    return;
                }

                const data = result.data;

                if (data) {
                    console.log('ğŸ” ä»APIåŠ è½½çš„æ•°æ®:', data);
                    console.log('ğŸ“… æ—¥æœŸæ•°æ®:', data.date);
                    
                    // å¡«å……è¡¨å•æ•°æ® - APIå·²ç»è¿”å›YYYY-MM-DDæ ¼å¼çš„æ—¥æœŸ
                    dateInput.value = data.date || '';
                    document.getElementById('freightUnitPrice').value = data.freight_unit_price || '';
                    document.getElementById('totalSettleWeight').value = data.total_settle_weight || '';
                    document.getElementById('actualWeightWithBox').value = data.actual_weight_with_box || '';
                    document.getElementById('trackingNumber').value = data.tracking_number || '';
                    document.getElementById('shipmentId').value = data.shipment_id || '';
                    orderNumberInput.value = data.order_number || '';
                    document.getElementById('boxCountInput').value = data.box_count || '';
                    
                    console.log('ğŸ’¾ æ—¥æœŸè¾“å…¥æ¡†è®¾ç½®ä¸º:', dateInput.value);

                    // å¤„ç†å•†æˆ·æ•°æ®
                    const merchantsData = data.merchants || [];

                    if (merchantsData && merchantsData.length > 0) {
                        merchantsData.forEach(m => {
                            const merchantName = m.merchant_name || '';
                            const weight = m.actual_weight || 0;
                            const pieces = m.pieces || 1;
                            
                            addNewRow(merchantName, weight, pieces, false);
                            
                            // æ¢å¤è®¡ç®—å¥½çš„æ•°å€¼
                            const lastRow = document.querySelector('#detailTable tr:last-of-type:not(.bg-gradient-to-r)');
                            if (lastRow) {
                                // è®¾ç½®ç»“ç®—é‡é‡
                                if (m.settle_weight) {
                                    lastRow.querySelector('.settle-weight-cell').textContent = parseFloat(m.settle_weight).toFixed(3);
                                }
                                // è®¾ç½®é‡‘é¢
                                if (m.amount) {
                                    lastRow.querySelector('.amount-cell').textContent = parseFloat(m.amount).toFixed(2);
                                }
                            }
                        });
                    } else {
                        addNewRow('', '0', '1', false); // å³ä½¿æœ‰æ•°æ®ï¼Œå¦‚æœmerchantsä¸ºç©ºï¼Œä¹Ÿæ·»åŠ ä¸€è¡Œ
                    }
                } else {
                    // æ‰¾ä¸åˆ°å¯¹åº”order_numberçš„æ•°æ®ï¼Œåˆ™ç”Ÿæˆæ–°çš„è¡¨å•ç¼–å·
                    Swal.fire('æç¤º', `æœªæ‰¾åˆ°è¡¨å•ç¼–å·ä¸º ${orderNumberFromUrl} çš„æ•°æ®ï¼Œå°†ä¸ºæ‚¨ç”Ÿæˆæ–°çš„è¡¨å•ç¼–å·ã€‚`, 'info');
                    await generateNewOrderNumber(); // ç”Ÿæˆæ–°ç¼–å·
                    addNewRow('', '0', '1', false);
                }
            } catch (e) {
                console.error('åŠ è½½æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸', e.message);
                Swal.fire('é”™è¯¯', 'åŠ è½½æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸ ' + e.message, 'error');
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•ç”Ÿæˆæ–°çš„è¡¨å•ç¼–å·
                await generateNewOrderNumber(); // ç”Ÿæˆæ–°ç¼–å·
                addNewRow('', '0', '1', false);
            } finally {
                ensureTotalRowExists(); // ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨
                calculateAll(); // å§‹ç»ˆåœ¨åŠ è½½æˆ–é‡ç½®åé‡æ–°è®¡ç®—
            }
        } else {
            // å¦‚æœ URLä¸­æ²¡æœ‰order_numberï¼Œæˆ–è€…å¼ºåˆ¶ç”Ÿæˆæ–°ç¼–å·ï¼Œåˆ™é‡ç½®ä¸ºåˆå§‹çŠ¶æ€å¹¶ç”Ÿæˆæ–°ç¼–å·
            await generateNewOrderNumber(); // ç”Ÿæˆæ–°ç¼–å·
            resetFormInputs(); // é‡ç½®orderNumberä»¥å¤–çš„å…¶ä»–è¾“å…¥æ¡†
            addNewRow('', '0', '1', false);
            ensureTotalRowExists(); // ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨
            calculateAll();
        }
    }

    /**
     * ç”Ÿæˆæ–°çš„è¡¨å•ç¼–å·å¹¶å¡«å……åˆ°è¾“å…¥æ¡†
     * @async
     * @returns {Promise<void>}
     */
    async function generateNewOrderNumber() {
        const dateInput = document.getElementById('dateInput');
        const orderNumberInput = document.getElementById('orderNumber');

        const selectedDate = dateInput.value; // è·å–å½“å‰æ—¥æœŸè¾“å…¥æ¡†çš„å€¼
        if (!selectedDate) { // å¦‚æœæ—¥æœŸä¸ºç©ºï¼Œè®¾ç½®ä¸€ä¸ªä»Šå¤©çš„é»˜è®¤å€¼
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            selectedDate = dateInput.value; // æ›´æ–°selectedDate
        }

        const datePrefix = selectedDate.replace(/-/g, ''); // æ ¼å¼åŒ–ä¸ºYYYYMMDD

        try {
            const response = await fetch(`/api/shipping_allocations?order_number_prefix=${datePrefix}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            let nextSequence = 1;
            if (result.success && result.data && result.data.length > 0) {
                // æ‰¾åˆ°ä»¥å½“å‰æ—¥æœŸä¸ºå‰ç¼€çš„æœ€å¤§è®¢å•å·
                const ordersWithPrefix = result.data.filter(item => 
                    item.order_number && item.order_number.startsWith(datePrefix)
                );
                
                if (ordersWithPrefix.length > 0) {
                    // æŒ‰è®¢å•å·é™åºæ’åºï¼Œè·å–æœ€å¤§çš„
                    ordersWithPrefix.sort((a, b) => b.order_number.localeCompare(a.order_number));
                    const lastOrderNumber = ordersWithPrefix[0].order_number;
                    const lastSequenceStr = lastOrderNumber.slice(-3); // è·å–æœ€åä¸‰ä½åºåˆ—å·
                    const lastSequence = parseInt(lastSequenceStr, 10);
                    if (!isNaN(lastSequence)) {
                        nextSequence = lastSequence + 1;
                    }
                }
            }

            const newOrderNumber = `${datePrefix}${String(nextSequence).padStart(3, '0')}`;
            orderNumberInput.value = newOrderNumber;
        } catch (e) {
            console.error('ç”Ÿæˆè¡¨å•ç¼–å·å¤±è´¥:', e.message);
            Swal.fire('é”™è¯¯', 'è‡ªåŠ¨ç”Ÿæˆè¡¨å•ç¼–å·å¤±è´¥: ' + e.message, 'error');
            orderNumberInput.value = ''; // å¤±è´¥æ—¶æ¸…ç©º
        }
    }

    /**
     * é‡ç½®è¡¨å•é¡¶éƒ¨è¾“å…¥æ¡†çš„å€¼
     */
    function resetFormInputs() {
                  document.getElementById('freightUnitPrice').value = '';
        document.getElementById('totalSettleWeight').value = '';
        document.getElementById('actualWeightWithBox').value = '';
        document.getElementById('trackingNumber').value = '';
        document.getElementById('shipmentId').value = '';
        document.getElementById('boxCountInput').value = '';
        // document.getElementById('orderNumber').value = ''; // è¡¨å•ç¼–å·ç”±generateNewOrderNumberç®¡ç†
    }

    /**
     * æ¸…é™¤æ‰€æœ‰å•†æˆ·å‚æ•°ä»¥ä¾›é‡æ–°è¾“å…¥ï¼Œå¹¶æ˜¾ç¤ºä¸€ä¸ªç¾è§‚çš„ç¡®è®¤å¯¹è¯æ¡†
     */
    function resetForm() {
      // æ’­æ”¾æç¤ºéŸ³
      document.getElementById('notificationSound').play().catch(e => console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e));

      // ä½¿ç”¨SweetAlert2æ˜¾ç¤ºè‡ªå®šä¹‰å¯¹è¯æ¡†
      Swal.fire({
        title: 'ç¡®è®¤æ“ä½œ',
        text: "æ‚¨ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å•†æˆ·æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†ï¼Œ",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#165DFF', // åŒ¹é…ä¸»é¢˜ä¸»è‰²
        cancelButtonColor: '#d33',
        confirmButtonText: 'æ˜¯çš„ï¼Œå…¨éƒ¨æ¸…é™¤ï¼',
        cancelButtonText: 'å–æ¶ˆ',
        customClass: {
          popup: 'rounded-xl shadow-lg',
          confirmButton: 'btn-hover',
          cancelButton: 'btn-hover'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const rows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
          
          rows.forEach(row => {
            row.querySelector('.merchant-input').value = '';
            row.querySelector('.weight-input').value = '0';
            row.querySelector('.pieces-input').value = '0';
          });

          // æ¸…é™¤é¡¶éƒ¨çš„å¯æ‰‹åŠ¨è¾“å…¥æ¡†
          document.getElementById('trackingNumber').value = '';
          document.getElementById('shipmentId').value = '';
          document.getElementById('totalSettleWeight').value = '';
          document.getElementById('actualWeightWithBox').value = '';
          document.getElementById('orderNumber').value = '';
          document.getElementById('boxCountInput').value = '';
          
          // ç¡®ä¿åˆè®¡è¡Œå­˜åœ¨
          ensureTotalRowExists();
          
          // é‡æ–°è®¡ç®—ä»¥æ›´æ–°æ‰€æœ‰å­—æ®µä¸º0æˆ–é»˜è®¤çŠ¶æ€
          calculateAll();

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          Swal.fire({
            icon: 'success',
            title: 'å·²æ¸…é™¤',
            text: 'æ‰€æœ‰æ•°æ®å·²è¢«æ¸…ç©ºï¼Œæ‚¨å¯ä»¥é‡æ–°è¾“å…¥äº†',
            timer: 1500,
            showConfirmButton: false,
            customClass: {
              popup: 'rounded-xl shadow-lg'
            }
          });
        }
      });
    }
    
    /**
     * è®¡ç®—æ‰€æœ‰æ•°æ®
     * æ­¤å‡½æ•°é‡æ–°è®¡ç®—é¡µé¢ä¸Šçš„æ‰€æœ‰è´¢åŠ¡æ•°æ®
     * å®ƒæ”¯æŒæ‰‹åŠ¨è¾“å…¥æ€»ç»“ç®—é‡é‡å’Œ"å®é‡+çº¸ç®±"é‡é‡
     * å¦‚æœæ‰‹åŠ¨è¾“å…¥"å®é‡+çº¸ç®±"ï¼Œå®ƒå°†æŒ‰æ¯”ä¾‹åˆ†é…çº¸ç®±é‡é‡åˆ°æ¯ä¸€è¡Œ
     * å¦‚æœæ‰‹åŠ¨è¾“å…¥æ€»ç»“ç®—é‡é‡ï¼Œå®ƒä¼šæ ¹æ®æ¯ä¸ªå•†æˆ·çš„ç»“ç®—é‡é‡æŒ‰æ¯”ä¾‹é‡æ–°åˆ†é…æ€»è´¹ç”¨
     * @param {Event} [event] - è§¦å‘è®¡ç®—çš„äº‹ä»¶å¯¹è±¡
     */
    function calculateAll(event) {
      const trigger = event ? event.target : null;
      const rows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
      const freightUnitPrice = parseFloat(document.getElementById('freightUnitPrice').value) || 0;
      
      // 1. Calculate totalActualWeight (sum from table)
      let totalActualWeight = 0;
      let totalPieces = 0;
      rows.forEach(row => {
          const weightInput = row.querySelector('.weight-input');
          const piecesInput = row.querySelector('.pieces-input');
          if (weightInput && piecesInput) {
            totalActualWeight += parseFloat(weightInput.value) || 0;
            totalPieces += parseInt(piecesInput.value, 10) || 0;
          }
      });

      // 2. Calculate and distribute Box Weight based on the "Actual Weight + Box" input.
      const actualWeightWithBoxInput = document.getElementById('actualWeightWithBox');
      const manualActualWeightWithBox = parseFloat(actualWeightWithBoxInput.value) || 0;
      let totalBoxWeight = manualActualWeightWithBox - totalActualWeight;
      if (totalBoxWeight < 0) totalBoxWeight = 0;

      rows.forEach(row => {
          const actualWeight = parseFloat(row.querySelector('.weight-input')?.value) || 0;
          const proportion = totalActualWeight > 0 ? (actualWeight / totalActualWeight) * totalBoxWeight : (rows.length > 0 ? totalBoxWeight / rows.length : 0);
          const boxInput = row.querySelector('.box-input');
          if (boxInput) {
            boxInput.value = proportion.toFixed(3);
          }
      });
      
      const actualWeightWithBox = totalActualWeight + totalBoxWeight;
      
      // 3. Get finalTotalSettleWeight from input. If not provided, it's just actual+box.
      const totalSettleWeightInput = document.getElementById('totalSettleWeight');
      let finalTotalSettleWeight = parseFloat(totalSettleWeightInput.value) || actualWeightWithBox;
      if (parseFloat(totalSettleWeightInput.value) === 0) { // allow 0 input
        finalTotalSettleWeight = 0;
      }
      
      // If the input was empty and we calculated it, update the input field for clarity.
      if (!totalSettleWeightInput.value && finalTotalSettleWeight > 0) {
        totalSettleWeightInput.value = finalTotalSettleWeight.toFixed(3);
      }

      // 4. Calculate totalThrow and distribute it.
      let totalThrow = finalTotalSettleWeight - actualWeightWithBox;
      if (totalThrow < 0) totalThrow = 0;

      rows.forEach(row => {
          const actualWeight = parseFloat(row.querySelector('.weight-input')?.value) || 0;
          const proportion = totalActualWeight > 0 ? (actualWeight / totalActualWeight) * totalThrow : (rows.length > 0 ? totalThrow / rows.length : 0);
          const throwInput = row.querySelector('.throw-input');
          if (throwInput) {
            throwInput.value = proportion.toFixed(3);
          }
      });
      
      // 5. Final pass to calculate row values and totals.
      const rowData = [];
      let totalSettleWeightFromTable = 0;
      
      rows.forEach(row => {
        const actualWeight = parseFloat(row.querySelector('.weight-input')?.value) || 0;
        const boxWeight = parseFloat(row.querySelector('.box-input')?.value) || 0;
        const throwWeight = parseFloat(row.querySelector('.throw-input')?.value) || 0;
        const settleWeight = actualWeight + boxWeight + throwWeight;
        
        rowData.push({ row, actualWeight, settleWeight });
        totalSettleWeightFromTable += settleWeight;
      });
      
      const totalAmount = finalTotalSettleWeight * freightUnitPrice;
      
      rowData.forEach(data => {
        const { row, actualWeight, settleWeight } = data;
        
        const rate = totalActualWeight > 0 ? (actualWeight / totalActualWeight) * 100 : 0;
        const rateCell = row.querySelector('.rate-cell');
        if (rateCell) {
          rateCell.textContent = rate.toFixed(2) + '%';
        }
        
        let amount = 0;
        if (totalSettleWeightFromTable > 0) {
          amount = totalAmount * (settleWeight / totalSettleWeightFromTable);
        } else if (rowData.length > 0 && totalAmount > 0) {
          amount = totalAmount / rowData.length;
        }
        
        const settleWeightCell = row.querySelector('.settle-weight-cell');
        const amountCell = row.querySelector('.amount-cell');
        if (settleWeightCell) {
          settleWeightCell.textContent = settleWeight.toFixed(3);
        }
        if (amountCell) {
          amountCell.textContent = amount.toFixed(2);
        }
      });

      const finalTotalAmountFromTable = rowData.reduce((sum, data) => {
        const amountCell = data.row.querySelector('.amount-cell');
        return sum + (amountCell ? parseFloat(amountCell.textContent) : 0);
      }, 0);

      // æ›´æ–°åˆè®¡è¡Œ
      const totalActualWeightElement = document.querySelector('.total-actual-weight');
      const totalPiecesElement = document.querySelector('.total-pieces');
      const totalBoxWeightElement = document.querySelector('.total-box-weight');
      const totalThrowElement = document.querySelector('.total-throw');
      const totalSettleWeightElement = document.querySelector('.total-settle-weight');
      const totalAmountElement = document.querySelector('.total-amount');
      
      if (totalActualWeightElement) totalActualWeightElement.textContent = totalActualWeight.toFixed(3);
      if (totalPiecesElement) totalPiecesElement.textContent = totalPieces;
      if (totalBoxWeightElement) totalBoxWeightElement.textContent = totalBoxWeight.toFixed(3);
      if (totalThrowElement) totalThrowElement.textContent = totalThrow.toFixed(3);
      if (totalSettleWeightElement) totalSettleWeightElement.textContent = totalSettleWeightFromTable.toFixed(3);
      if (totalAmountElement) totalAmountElement.textContent = finalTotalAmountFromTable.toFixed(2);
      
      // æ›´æ–°æ±‡æ€»ä¿¡æ¯
      const actualWeightSumElement = document.getElementById('actualWeightSum');
      const boxWeightElement = document.getElementById('boxWeight');
      const throwOutElement = document.getElementById('throwOut');
      const totalFreightElement = document.getElementById('totalFreight');
      
      if (actualWeightSumElement) actualWeightSumElement.textContent = totalActualWeight.toFixed(3) + ' kg';
      if (boxWeightElement) boxWeightElement.textContent = totalBoxWeight.toFixed(3) + ' kg';
      if (throwOutElement) throwOutElement.textContent = totalThrow.toFixed(3) + ' kg';
      if (totalFreightElement) totalFreightElement.textContent = 'Â¥' + finalTotalAmountFromTable.toFixed(2);
      
      // æ›´æ–°ç®±æ•°æ˜¾ç¤º
      const boxCountValue = parseInt(document.getElementById('boxCountInput').value, 10) || 0;
      const boxCountElement = document.getElementById('boxCount');
      if (boxCountElement) boxCountElement.textContent = boxCountValue;
      
      // æ›´æ–°å•†æˆ·æ•°é‡
      const merchantCountElement = document.getElementById('merchantCount');
      if (merchantCountElement) merchantCountElement.textContent = rows.length;
      
      updateChart();
    }
    
    // æ›´æ–°å›¾è¡¨
    function updateChart() {
      if (distributionChart) {
        const labels = Array.from(document.querySelectorAll('.merchant-input')).map(input => input.value);
        const amounts = Array.from(document.querySelectorAll('.amount-cell')).map(cell => parseFloat(cell.textContent));
        
        distributionChart.data.labels = labels;
        distributionChart.data.datasets[0].data = amounts;
        distributionChart.update();
      }
    }
    
    // å¯¼å‡ºExcel
    function downloadExcel() {
      // åˆ›å»ºå·¥ä½œç°¿
      const wb = XLSX.utils.book_new();
      
      // åˆ›å»ºå·¥ä½œè¡¨æ•°ç»„
      const ws_data = [];
      
      // æ·»åŠ å¤´éƒ¨ä¿¡æ¯
      const now = new Date();
      const exportDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      ws_data.push([`å¯¼å‡ºæ—¶é—´: ${exportDateTime}`]);

      const trackingNumber = document.getElementById('trackingNumber').value;
      const shipmentId = document.getElementById('shipmentId').value;
      const orderNumber = document.getElementById('orderNumber').value;

      if (trackingNumber) {
        ws_data.push([`å¿«é€’å•å·: ${trackingNumber}`]);
      }
      if (shipmentId) {
        ws_data.push([`è´§ä»¶ID: ${shipmentId}`]);
      }
      if (orderNumber) {
        ws_data.push([`è¡¨å•ç¼–å·: ${orderNumber}`]);
      }
      
      ws_data.push([]); // ç©ºè¡Œç”¨äºé—´éš”

      // æ·»åŠ è¡¨å¤´
      ws_data.push([
        'åºå·', 'å•†æˆ·', 'ä»¶æ•°', 'è´§ç‰©å®é‡(kg)', 'æ¯”ä¾‹(%)', 'å çº¸ç®±(kg)', 
        'å æŠ›å‡º(kg)', 'ç»“ç®—é‡é‡(kg)', 'è¿è´¹å•ä»·(Â¥/kg)', 'åˆè®¡é‡‘é¢(Â¥)'
      ]);
      
      // è·å–è¿è´¹å•ä»·
      const freightUnitPrice = parseFloat(document.getElementById('freightUnitPrice').value) || 0;
      
      // æ·»åŠ è¡¨æ ¼æ•°æ®
      const rows = document.querySelectorAll('#detailTable tr:not(.bg-gradient-to-r)');
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = [];
        
        // åºå·
        rowData.push(cells[0].textContent);
        
        // å•†æˆ·
        rowData.push(row.querySelector('.merchant-input').value);
        
        // ä»¶æ•°
        rowData.push(parseInt(row.querySelector('.pieces-input').value, 10) || 0);
        
        // è´§ç‰©å®é‡
        rowData.push(parseFloat(row.querySelector('.weight-input').value) || 0);
        
        // æ¯”ä¾‹
        rowData.push(parseFloat(row.querySelector('.rate-cell').textContent) || 0);
        
        // çº¸ç®±
        rowData.push(parseFloat(row.querySelector('.box-input').value) || 0);
        
        // æŠ›å‡º
        rowData.push(parseFloat(row.querySelector('.throw-input').value) || 0);
        
        // ç»“ç®—é‡é‡
        rowData.push(parseFloat(row.querySelector('.settle-weight-cell').textContent) || 0);
        
        // è¿è´¹å•ä»·
        rowData.push(freightUnitPrice);
        
        // åˆè®¡é‡‘é¢
        rowData.push(parseFloat(row.querySelector('.amount-cell').textContent) || 0);
        
        ws_data.push(rowData);
      });
      
      // åˆ›å»ºå·¥ä½œè¡¨
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      
      // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
      XLSX.utils.book_append_sheet(wb, ws, "å‘è´§è´¹ç”¨åˆ†æ‘Šè¡¨");
      
      // è·å–æ—¥æœŸä½œä¸ºæ–‡ä»¶å
      const date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
      const filename = `å‘è´§è´¹ç”¨åˆ†æ‘Šè¡¨_${date}.xlsx`;
      
      // å¯¼å‡ºExcel
      XLSX.writeFile(wb, filename);
    }

    /**
     * ä»è…¾è®¯äº‘ MySQL æ•°æ®åº“è·å–å•†æˆ·åˆ—è¡¨å¹¶å¡«å……åˆ°datalistä¸­
     * ä½“éªŒä¸å·¥ä½œæµé¡µé¢ä¸€è‡´ï¼šä¸‹æ‹‰æ˜¾ç¤º"ç¼–å· - åç§°"ï¼Œé€‰ä¸­ååªå¡«åç§°
     * @async
     * @returns {Promise<void>}
     */
    async function populateMerchantDatalist() {
        const merchantListDatalist = document.getElementById('merchantList');
        if (!merchantListDatalist) return;

        try {
            const response = await fetch('/api/merchants');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                console.error('è·å–å•†æˆ·åˆ—è¡¨å¤±è´¥:', result.message);
                return;
            }

            const merchants = result.data || [];
            merchantListDatalist.innerHTML = '';

            merchants.forEach(merchant => {
                const option = document.createElement('option');
                option.value = merchant.merchant_name; // é€‰ä¸­ååªå¡«åç§°
                option.textContent = `${merchant.merchant_id_code} - ${merchant.merchant_name}`; // ä¸‹æ‹‰æ˜¾ç¤ºç¼–å·-åç§°
                merchantListDatalist.appendChild(option);
            });
            
            console.log(`æˆåŠŸåŠ è½½ ${merchants.length} ä¸ªå•†æˆ·åˆ°ä¸‹æ‹‰åˆ—è¡¨`);
        } catch (e) {
            console.error('å¡«å……å•†æˆ·åˆ—è¡¨æ—¶å‘ç”Ÿå¼‚å¸¸', e.message);
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–å•†æˆ·æ•°æ®åˆ—è¡¨
        populateMerchantDatalist();
        
        // æ·»åŠ ç®±æ•°è¾“å…¥æ¡†çš„äº‹ä»¶ç›‘å¬
        const boxCountInput = document.getElementById('boxCountInput');
        if (boxCountInput) {
            boxCountInput.addEventListener('input', function() {
                const boxCountValue = parseInt(this.value, 10) || 0;
                document.getElementById('boxCount').textContent = boxCountValue;
            });
        }
    });
  </script>
</body>
</html>
<!-- Vercel deployment trigger comment -->  
