<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>账户管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- 引入 Supabase JS 库 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Custom styles if needed, Tailwind handles most */
    .table-container {
        overflow-x: auto;
    }
    .tab-item.active {
        border-bottom: 2px solid #4F46E5; /* Indigo-600 */
        color: #4F46E5; /* Indigo-600 */
    }
    .tab-item:not(.active) {
        color: #6B7280; /* Gray-500 */
    }
    td, th { padding-top: 2px !important; padding-bottom: 2px !important; }
    input, select { padding-top: 1px !important; padding-bottom: 1px !important; height: 24px !important; font-size: 13px !important; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Admin Dashboard -->
  <div class="container mx-auto p-4 flex-grow">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">| 账户管理</h1>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex border-b border-gray-200 mb-6">
        <button class="tab-item active py-2 px-4 text-sm font-medium focus:outline-none" id="accountManagementTab">
          账号管理
        </button>
        <button class="tab-item py-2 px-4 text-sm font-medium focus:outline-none" id="roleListTab">
          角色列表
          </button>
        <button class="tab-item py-2 px-4 text-sm font-medium focus:outline-none" id="merchantManagementTab">
          商家管理
        </button>
        <button id="logoutBtn" class="ml-auto bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600 transition duration-300 text-sm">
          登出 ({{ session.username }})
        </button>
      </div>

      <div id="accountManagementContent">
        <div class="flex justify-between items-center mb-4">
          <button class="bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition duration-300 text-sm">
            + 新增子账号
          </button>
          <div class="relative flex items-center">
            <input type="text" placeholder="请输入账号名称" class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
            <svg class="absolute left-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
        </div>

        <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  账号名
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  账号类型
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                角色
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  账号备注
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                操作
              </th>
            </tr>
          </thead>
          <tbody id="membersTableBody" class="bg-white divide-y divide-gray-200">
            {% for member in members %}
              <tr data-id="{{ member.id }}" data-permissions="{{ member.permissions | safe }}">
                <td class="px-6 py-4 whitespace-nowrap">{{ member.username }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ member.email }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ member.role }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ member.notes or '' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  {% if member.role != 'admin' %}
                  <button class="text-indigo-600 hover:text-indigo-900 mr-4 edit-btn" data-id="{{ member.id }}">编辑</button>
                  <button class="text-red-600 hover:text-red-900 delete-btn" data-id="{{ member.id }}">删除</button>
                  <button class="text-blue-600 hover:text-blue-900 ml-4 manage-permissions-btn" data-id="{{ member.id }}">权限管理</button>
                  {% else %}
                  <span class="text-gray-500">N/A</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </div>

      <div id="roleListContent" class="hidden">
        <!-- Role list content will go here -->
        <p class="text-gray-600">角色列表内容待开发...</p>
      </div>

      <div id="merchantManagementContent" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <button id="addNewMerchantBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-300 text-sm">
            + 新增商家
          </button>
          <div class="relative flex items-center">
            <input type="text" id="merchantSearchInput" placeholder="请输入商家代号或名称" class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
            <svg class="absolute left-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
        </div>

        <div class="table-container">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商家编号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商家代号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商家名称</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody id="merchantsTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Merchants data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase配置
    const SUPABASE_URL = 'https://xehoqrboglykebqvovgj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlaG9xcmJvZ2x5a2VicXZvdmdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NTk2OTMsImV4cCI6MjA2NTIzNTY5M30.v8iMnNK_b3hGuum4qvreBzf19NiEJ11Dz4Q_Oy_7ySg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logoutBtn');
        const accountManagementTab = document.getElementById('accountManagementTab');
        const roleListTab = document.getElementById('roleListTab');
        const merchantManagementTab = document.getElementById('merchantManagementTab');
        const accountManagementContent = document.getElementById('accountManagementContent');
        const roleListContent = document.getElementById('roleListContent');
        const merchantManagementContent = document.getElementById('merchantManagementContent');
        const membersTableBody = document.getElementById('membersTableBody');
        const merchantsTableBody = document.getElementById('merchantsTableBody');

        /**
         * 显示 SweetAlert2 提示消息。
         * @param {string} icon - 图标类型 (success, error, warning, info, question)。
         * @param {string} title - 提示标题。
         * @param {string} text - 提示内容。
         * @param {number} timer - 自动关闭的毫秒数 (可选)。
         * @returns {Promise<SweetAlertResult>} SweetAlert2 结果对象。
         */
        const showAlert = (icon, title, text, timer = 0) => {
            return Swal.fire({
                icon: icon,
                title: title,
                text: text,
                timer: timer,
                showConfirmButton: !timer,
                customClass: {
                    popup: 'rounded-xl shadow-lg'
                }
            });
        };

        // Tab Switching Logic
        const tabs = document.querySelectorAll('.tab-item');
        const contents = {
          accountManagementTab: accountManagementContent,
          roleListTab: roleListContent,
          merchantManagementTab: merchantManagementContent
        };

        function switchTab(activeTabId) {
          Object.keys(contents).forEach(tabId => {
            const tab = document.getElementById(tabId);
            const content = contents[tabId];

            if (tabId === activeTabId) {
              tab.classList.add('active', 'border-indigo-500', 'text-indigo-600');
              tab.classList.remove('border-transparent', 'text-gray-500');
              content.classList.remove('hidden');
              if (activeTabId === 'merchantManagementTab') {
                loadMerchants(); // Load merchants when switching to this tab
              }
            } else {
              tab.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
              tab.classList.add('border-transparent', 'text-gray-500');
              content.classList.add('hidden');
            }
          });
        }

        tabs.forEach(tab => {
          tab.addEventListener('click', () => switchTab(tab.id));
        });

        // Initialize active tab (e.g., account management)
        switchTab('accountManagementTab');

        // Logout Logic
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error('Logout error:', error.message);
                        showAlert('error', '登出失败', error.message);
                    } else {
                        window.location.href = '/'; // Redirect to home/login page
                    }
                } catch (e) {
                    console.error('Logout exception:', e);
                    showAlert('error', '网络错误', '登出时发生错误。');
                }
            });
        }

        // Member Management Logic (Simplified as per existing HTML)
        // This part would typically interact with your Flask backend for user management
        // For now, it mostly handles display and basic client-side interactions
        const editBtns = membersTableBody.querySelectorAll('.edit-btn');
        const deleteBtns = membersTableBody.querySelectorAll('.delete-btn');
        const managePermissionsBtns = membersTableBody.querySelectorAll('.manage-permissions-btn');

        editBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const memberId = e.target.dataset.id;
                // Implement edit logic, e.g., open a modal with user data
                showAlert('info', '编辑用户', `编辑用户ID: ${memberId} - 功能待实现`);
            });
        });

        deleteBtns.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const memberId = e.target.dataset.id;
                const result = await showAlert('question', '确认删除？', '此操作不可撤销！');
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/api/member/${memberId}`, {
                            method: 'DELETE'
                        });
                        const data = await response.json();
                        if (response.ok) {
                            showAlert('success', '删除成功', data.message || '用户已删除！', 1500);
                            e.target.closest('tr').remove(); // Remove row from UI
                        } else {
                            showAlert('error', '删除失败', data.message || '删除用户失败。');
                        }
                    } catch (error) {
                        console.error('删除用户时发生错误:', error);
                        showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                    }
                }
            });
        });

        managePermissionsBtns.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const memberId = e.target.dataset.id;
                const memberRow = e.target.closest('tr');
                const permissionsData = memberRow.dataset.permissions ? JSON.parse(memberRow.dataset.permissions) : [];
                const username = memberRow.querySelector('td:first-child').textContent;
                showPermissionsDrawer(memberId, username, permissionsData);
            });
        });

        // Permissions Drawer Logic
        const permissionsDrawer = document.getElementById('permissionsDrawer');
        const closePermissionsDrawerBtn = document.getElementById('closePermissionsDrawerBtn');
        const permissionsDrawerOverlay = document.getElementById('permissionsDrawerOverlay');
        const showPermissionsDrawer = (memberId, username, currentPermissions) => {
            document.getElementById('permissionMemberName').textContent = username;
            document.getElementById('currentMemberIdForPermissions').value = memberId;
            
            // Reset all checkboxes
            for (const key in ALL_PERMISSIONS) {
                if (ALL_PERMISSIONS.hasOwnProperty(key)) {
                    ALL_PERMISSIONS[key].checked = false;
                }
            }
            // Set checked based on currentPermissions
            currentPermissions.forEach(perm => {
                if (ALL_PERMISSIONS[perm]) {
                    ALL_PERMISSIONS[perm].checked = true;
                }
            });

            permissionsDrawer.classList.remove('translate-x-full', 'hidden');
            permissionsDrawer.classList.add('translate-x-0');
            permissionsDrawerOverlay.classList.remove('hidden');
        };

        const hidePermissionsDrawer = () => {
            permissionsDrawer.classList.remove('translate-x-0');
            permissionsDrawer.classList.add('translate-x-full');
            permissionsDrawerOverlay.classList.add('hidden');
        };

        if (closePermissionsDrawerBtn) {
            closePermissionsDrawerBtn.addEventListener('click', hidePermissionsDrawer);
        }
        if (permissionsDrawerOverlay) {
            permissionsDrawerOverlay.addEventListener('click', hidePermissionsDrawer);
        }

        const cancelPermissionsBtn = document.getElementById('cancelPermissionsBtn');
        const permissionsForm = document.getElementById('permissionsForm');
        const currentMemberIdForPermissions = document.getElementById('currentMemberIdForPermissions');
        const permY2CostHtml = document.getElementById('perm_y2cost_html');
        const permTemuY2GzlHtml = document.getElementById('perm_temu_y2gzl_html');
        const permExpenseAllocationFunction = document.getElementById('perm_expense_allocation_function');
        const permBarcodeGeneratorHtml = document.getElementById('perm_barcode_generator_html');

        // 定义所有可能的功能权限及其对应的标识符
        const ALL_PERMISSIONS = {
            'y2cost_html': permY2CostHtml,
            'temu_y2gzl_html': permTemuY2GzlHtml,
            'expense_allocation_function': permExpenseAllocationFunction,
            'barcode_generator_html': permBarcodeGeneratorHtml
        };

        if (permissionsForm) {
            permissionsForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const memberId = currentMemberIdForPermissions.value;
                const selectedPermissions = [];

                for (const key in ALL_PERMISSIONS) {
                    if (ALL_PERMISSIONS.hasOwnProperty(key) && ALL_PERMISSIONS[key].checked) {
                        selectedPermissions.push(key);
                    }
                }

                try {
                    const response = await fetch(`/api/member/${memberId}/permissions`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ permissions: selectedPermissions })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showAlert('success', '权限更新成功', result.message || '会员权限已成功更新！', 1500);
                        hidePermissionsDrawer();
                        // 重新加载会员数据以更新表格中的权限显示
                        location.reload(); 
                    } else {
                        showAlert('error', '权限更新失败', result.message || '更新会员权限失败。');
                    }
                } catch (error) {
                    console.error('更新会员权限时发生错误:', error);
                    showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                }
            });
        }

        // Merchants Management Logic
        const addNewMerchantBtn = document.getElementById('addNewMerchantBtn');
        const newMerchantDrawer = document.getElementById('newMerchantDrawer');
        const closeMerchantDrawerBtn = document.getElementById('closeMerchantDrawerBtn');
        const cancelNewMerchantBtn = document.getElementById('cancelNewMerchantBtn');
        const merchantDrawerOverlay = document.getElementById('merchantDrawerOverlay');
        const newMerchantForm = document.getElementById('newMerchantForm');
        const merchantIdToEdit = document.getElementById('merchantIdToEdit');
        const merchantCodeInput = document.getElementById('merchantCode');
        const merchantNameInput = document.getElementById('merchantName');
        const merchantDrawerTitle = document.getElementById('merchantDrawerTitle');
        const merchantSearchInput = document.getElementById('merchantSearchInput');
        const merchantIdCodeInput = document.getElementById('merchantIdCode'); // 新增：商家编号输入框

        let allMerchants = []; // Store all fetched merchants for client-side filtering

        const showMerchantDrawer = (title, merchant = {}) => {
            merchantDrawerTitle.textContent = title;
            merchantIdToEdit.value = merchant.id || '';
            merchantCodeInput.value = merchant.merchant_code || '';
            merchantNameInput.value = merchant.merchant_name || '';
            merchantIdCodeInput.value = merchant.merchant_id_code || ''; // 填充商家编号

            // 如果是新增商家，自动生成商家编号
            if (title === '新增商家') {
                generateNewMerchantIdCode();
            } else {
                // 编辑时禁用商家编号输入框
                merchantIdCodeInput.readOnly = true;
                merchantIdCodeInput.classList.add('bg-gray-100');
            }
            
            newMerchantDrawer.classList.remove('translate-x-full', 'hidden');
            newMerchantDrawer.classList.add('translate-x-0');
            merchantDrawerOverlay.classList.remove('hidden');
        };

        const hideMerchantDrawer = () => {
            newMerchantDrawer.classList.remove('translate-x-0');
            newMerchantDrawer.classList.add('translate-x-full');
            merchantDrawerOverlay.classList.add('hidden');
            newMerchantForm.reset(); // Clear form on close
            merchantIdCodeInput.readOnly = false; // 恢复可编辑状态
            merchantIdCodeInput.classList.remove('bg-gray-100');
        };

        if (addNewMerchantBtn) {
            addNewMerchantBtn.addEventListener('click', () => showMerchantDrawer('新增商家'));
        }
        if (closeMerchantDrawerBtn) {
            closeMerchantDrawerBtn.addEventListener('click', hideMerchantDrawer);
        }
        if (cancelNewMerchantBtn) {
            cancelNewMerchantBtn.addEventListener('click', hideMerchantDrawer);
        }
        if (merchantDrawerOverlay) {
            merchantDrawerOverlay.addEventListener('click', hideMerchantDrawer);
        }

        newMerchantForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = merchantIdToEdit.value;
            const merchant_id_code = merchantIdCodeInput.value.trim(); // 获取商家编号
            const merchant_code = merchantCodeInput.value.trim();
            const merchant_name = merchantNameInput.value.trim();

            if (!merchant_id_code || !merchant_code || !merchant_name) {
                showAlert('warning', '输入有误', '商家编号、商家代号和商家名称不能为空。');
                return;
            }

            try {
                let response;
                const dataToSave = { merchant_id_code, merchant_code, merchant_name }; // 包含商家编号

                if (id) {
                    // Update existing merchant
                    response = await supabase
                        .from('merchants')
                        .update(dataToSave)
                        .eq('id', id);
                } else {
                    // Add new merchant
                    response = await supabase
                        .from('merchants')
                        .insert([dataToSave]);
                }

                if (response.error) {
                    if (response.error.code === '23505') { // Unique violation error code for PostgreSQL
                        // 检查是哪个唯一约束被违反
                        if (response.error.message.includes('merchant_id_code')) {
                            showAlert('error', '保存失败', '商家编号已存在，请重新生成或使用其他编号。');
                        } else if (response.error.message.includes('merchant_code')) {
                            showAlert('error', '保存失败', '商家代号已存在，请使用其他代号。');
                        } else {
                            showAlert('error', '保存失败', response.error.message);
                        }
                    } else {
                        showAlert('error', '保存失败', response.error.message);
                    }
                } else {
                    showAlert('success', '保存成功', '商家信息已保存！', 1500);
                    hideMerchantDrawer();
                    loadMerchants(); // Reload merchant list
                }
            } catch (error) { // 捕获网络或其他异常
                console.error('保存商家信息时发生错误:', error);
                showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
            }
        });

        // Load Merchants Data
        async function loadMerchants(searchTerm = '') {
            let query = supabase.from('merchants').select('*').order('merchant_id_code', { ascending: true }); // 按编号排序

            if (searchTerm) {
                query = query.or(`merchant_id_code.ilike.%${searchTerm}%,merchant_code.ilike.%${searchTerm}%,merchant_name.ilike.%${searchTerm}%`); // 搜索也包含商家编号
            }

            const { data, error } = await query;
            if (error) {
                console.error('Error fetching merchants:', error.message);
                merchantsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">加载失败: ${error.message}</td></tr>`; // 调整colspan
                return;
            }
            allMerchants = data || []; // Store all fetched merchants for search
            renderMerchantsTable(allMerchants); // Render filtered or all data
        }

        function renderMerchantsTable(merchantsToRender) {
            merchantsTableBody.innerHTML = '';
            if (merchantsToRender.length === 0) {
                merchantsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-4">暂无商家数据</td></tr>`; // 调整colspan
                return;
            }
            merchantsToRender.forEach(merchant => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${merchant.merchant_id_code || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${merchant.merchant_code}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${merchant.merchant_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-4 edit-merchant-btn" data-id="${merchant.id}">编辑</button>
                        <button class="text-red-600 hover:text-red-900 delete-merchant-btn" data-id="${merchant.id}">删除</button>
                    </td>
                `;
                merchantsTableBody.appendChild(tr);
            });

            // Attach event listeners for newly rendered buttons
            attachMerchantEventHandlers();
        }

        function attachMerchantEventHandlers() {
            merchantsTableBody.querySelectorAll('.edit-merchant-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const merchantId = e.target.dataset.id;
                    const merchantToEdit = allMerchants.find(m => m.id == merchantId);
                    if (merchantToEdit) {
                        showMerchantDrawer('编辑商家', merchantToEdit);
                    }
                });
            });

            merchantsTableBody.querySelectorAll('.delete-merchant-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const merchantId = e.target.dataset.id;
                    const merchantToDelete = allMerchants.find(m => m.id == merchantId);
                    const merchantName = merchantToDelete ? merchantToDelete.merchant_name : '该商家';

                    const result = await showAlert('question', '确认删除？', `确定要删除商家 ${merchantName} 吗？此操作不可撤销！`);
                    if (result.isConfirmed) {
                        try {
                            const { error } = await supabase
                                .from('merchants')
                                .delete()
                                .eq('id', merchantId);
                           
                            if (error) {
                                showAlert('error', '删除失败', error.message);
                            } else {
                                showAlert('success', '删除成功', '商家已删除！', 1500);
                                loadMerchants(); // Reload list after deletion
                            }
                        } catch (error) {
                            console.error('删除商家时发生错误:', error);
                            showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                        }
                    }
                });
            });
        }

        // 函数：生成新的商家编号
        async function generateNewMerchantIdCode() {
            try {
                const { data: latestMerchant, error } = await supabase
                    .from('merchants')
                    .select('merchant_id_code')
                    .order('merchant_id_code', { ascending: false })
                    .limit(1);

                let nextId = 1;
                if (latestMerchant && latestMerchant.length > 0 && latestMerchant[0].merchant_id_code) {
                    const lastIdCode = latestMerchant[0].merchant_id_code;
                    const lastIdNum = parseInt(lastIdCode, 10);
                    if (!isNaN(lastIdNum)) {
                        nextId = lastIdNum + 1;
                    }
                }
                merchantIdCodeInput.value = String(nextId).padStart(4, '0');
            } catch (e) {
                console.error('自动生成商家编号失败:', e.message);
                showAlert('error', '自动生成商家编号失败', e.message);
                merchantIdCodeInput.value = ''; // 失败时清空
            }
        }

        // Merchant Search Input Event
        if (merchantSearchInput) {
            merchantSearchInput.addEventListener('input', () => {
                const searchTerm = merchantSearchInput.value.trim();
                loadMerchants(searchTerm); // Load merchants with search term
            });
        }
    });
  </script>

  <!-- New Sub-account Drawer -->
  <div id="newAccountDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="drawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800">新建子账号</h2>
        <button id="closeDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="newSubAccountForm" class="flex-grow space-y-4">
        <h3 class="text-lg font-medium text-gray-700">基本信息</h3>
        <div>
          <label for="newUsername" class="block text-sm font-medium text-gray-700">*账号名</label>
          <input type="text" id="newUsername" name="username" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">*登录密码</label>
          <input type="password" id="newPassword" name="password" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700">*确认密码</label>
          <input type="password" id="confirmPassword" name="confirm_password" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="newEmail" class="block text-sm font-medium text-gray-700">邮箱</label>
          <input type="email" id="newEmail" name="email"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="newRole" class="block text-sm font-medium text-gray-700">*子账号角色</label>
          <div class="mt-1 p-3 bg-yellow-400 text-black text-center font-bold rounded-md">
            功能模块开发
          </div>
          <!-- <select id="newRole" name="role" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <option value="member">普通会员</option>
            <option value="admin">管理员</option>
          </select> -->
        </div>
        <!-- Other fields as needed -->

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelNewAccountBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">创建账号</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Permissions Management Drawer -->
  <div id="permissionsDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="permissionsDrawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800">管理会员权限 <span id="permissionUserName" class="text-sm text-gray-500 font-normal ml-2"></span></h2>
        <button id="closePermissionsDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="permissionsForm" class="flex-grow space-y-4">
        <input type="hidden" id="currentMemberIdForPermissions">
        <h3 class="text-lg font-medium text-gray-700 mb-4">请勾选该用户可访问的功能：</h3>

        <div class="space-y-2">
          <div class="flex items-center">
            <input type="checkbox" id="perm_expense_allocation_function" name="permissions" value="expense_allocation_function" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_expense_allocation_function" class="ml-2 block text-sm text-gray-900">运费分摊核算</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_y2cost_html" name="permissions" value="y2cost_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_y2cost_html" class="ml-2 block text-sm text-gray-900">成本核算</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_temu_y2gzl_html" name="permissions" value="temu_y2gzl_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_temu_y2gzl_html" class="ml-2 block text-sm text-gray-900">货物工作流</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_barcode_generator_html" name="permissions" value="barcode_generator_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_barcode_generator_html" class="ml-2 block text-sm text-gray-900">条形码生成</label>
          </div>
        </div>

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelPermissionsBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">保存权限</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Merchant Drawer -->
  <div id="newMerchantDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="merchantDrawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800" id="merchantDrawerTitle">新增商家</h2>
        <button id="closeMerchantDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="newMerchantForm" class="flex-grow space-y-4">
        <input type="hidden" id="merchantIdToEdit">
        <div>
            <label for="merchantIdCode" class="block text-sm font-medium text-gray-700">*商家编号</label>
            <input type="text" id="merchantIdCode" name="merchant_id_code" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="merchantCode" class="block text-sm font-medium text-gray-700">*商家代号</label>
          <input type="text" id="merchantCode" name="merchant_code" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="merchantName" class="block text-sm font-medium text-gray-700">*商家名称</label>
          <input type="text" id="merchantName" name="merchant_name" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelNewMerchantBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">保存商家</button>
        </div>
      </form>
    </div>
  </div>

</body>
</html>