<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>账户管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Custom styles if needed, Tailwind handles most */
    .table-container {
        overflow-x: auto;
    }
    .tab-item.active {
        border-bottom: 2px solid #4F46E5; /* Indigo-600 */
        color: #4F46E5; /* Indigo-600 */
    }
    .tab-item:not(.active) {
        color: #6B7280; /* Gray-500 */
    }
    td, th { padding-top: 2px !important; padding-bottom: 2px !important; }
    input, select { padding-top: 1px !important; padding-bottom: 1px !important; height: 24px !important; font-size: 13px !important; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Admin Dashboard -->
  <div class="container mx-auto p-4 flex-grow">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">| 账户管理</h1>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex border-b border-gray-200 mb-6">
        <button class="tab-item active py-2 px-4 text-sm font-medium focus:outline-none" id="accountManagementTab">
          账号管理
        </button>
        <button class="tab-item py-2 px-4 text-sm font-medium focus:outline-none" id="roleListTab">
          角色列表
          </button>
        <button class="tab-item py-2 px-4 text-sm font-medium focus:outline-none" id="merchantManagementTab">
          商家管理
        </button>
        <button id="logoutBtn" class="ml-auto bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600 transition duration-300 text-sm">
          登出 ({{ session.username }})
        </button>
      </div>

      <div id="accountManagementContent">
        <div class="flex justify-between items-center mb-4">
          <button id="addNewSubAccountBtn" class="bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition duration-300 text-sm">
            + 新增子账号
          </button>
          <div class="relative flex items-center">
            <input type="text" placeholder="请输入账号名称" class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
            <svg class="absolute left-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
        </div>

        <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  账号名
              </th>
              <!-- <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  账号类型
              </th> -->
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                角色
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  账号备注
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  权限
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                操作
              </th>
            </tr>
          </thead>
          <tbody id="membersTableBody" class="bg-white divide-y divide-gray-200">
            {% for member in members %}
              <tr data-id="{{ member.id }}" data-permissions='{{ member.permissions | safe }}'>
                <td class="px-6 py-4 whitespace-nowrap">{{ member.username }}</td>
                <!-- <td class="px-6 py-4 whitespace-nowrap">{{ member.email }}</td> -->
                <td class="px-6 py-4 whitespace-nowrap">{{ member.role }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ member.notes or '' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  {% if member.role != 'admin' %}
                  <span class="permissions-display" data-permissions='{{ member.permissions | safe }}'>
                    {% set permission_names = {
                      'y2cost_html': '成本核算',
                      'temu_y2gzl_html': '货物工作流', 
                      'expense_allocation_function': '运费分摊核算',
                      'barcode_generator_html': '条形码生成',
                      'statistical_function': '统计功能',
                      'query_function': '查询功能',
                      'product_extractor_html': 'Temu产品提取器'
                    } %}
                    {% if member.permissions_array and member.permissions_array|length > 0 %}
                      {% set display_names = [] %}
                      {% for perm in member.permissions_array %}
                        {% set _ = display_names.append(permission_names.get(perm, perm)) %}
                      {% endfor %}
                      <span class="text-green-600">{{ display_names | join(', ') }}</span>
                    {% else %}
                      <span class="text-gray-400">无权限</span>
                    {% endif %}
                  </span>
                  {% else %}
                  <span class="text-gray-500">管理员</span>
                  {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  {% if member.role != 'admin' %}
                  <button class="text-indigo-600 hover:text-indigo-900 mr-4 edit-btn" data-id="{{ member.id }}">编辑</button>
                  <button class="text-red-600 hover:text-red-900 delete-btn" data-id="{{ member.id }}">删除</button>
                  <button class="text-blue-600 hover:text-blue-900 ml-4 manage-permissions-btn" data-id="{{ member.id }}">权限管理</button>
                  {% else %}
                  <span class="text-gray-500">N/A</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </div>

      <div id="roleListContent" class="hidden">
        <!-- Role list content will go here -->
        <p class="text-gray-600">角色列表内容待开发...</p>
      </div>

      <div id="merchantManagementContent" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <button id="addNewMerchantBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-300 text-sm">
            + 新增商家
          </button>
          <div class="relative flex items-center">
            <input type="text" id="merchantSearchInput" placeholder="请输入商家代号或名称" class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
            <svg class="absolute left-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
        </div>

        <div class="table-container">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商家编号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商家代号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商家名称</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody id="merchantsTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Merchants data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logoutBtn');
        const accountManagementTab = document.getElementById('accountManagementTab');
        const roleListTab = document.getElementById('roleListTab');
        const merchantManagementTab = document.getElementById('merchantManagementTab');
        const accountManagementContent = document.getElementById('accountManagementContent');
        const roleListContent = document.getElementById('roleListContent');
        const merchantManagementContent = document.getElementById('merchantManagementContent');
        const membersTableBody = document.getElementById('membersTableBody');
        const merchantsTableBody = document.getElementById('merchantsTableBody');

        /**
         * 显示 SweetAlert2 提示消息。
         * @param {string} icon - 图标类型 (success, error, warning, info, question)。
         * @param {string} title - 提示标题。
         * @param {string} text - 提示内容。
         * @param {number} timer - 自动关闭的毫秒数 (可选)。
         * @returns {Promise<SweetAlertResult>} SweetAlert2 结果对象。
         */
        const showAlert = (icon, title, text, timer = 0) => {
            return Swal.fire({
                icon: icon,
                title: title,
                text: text,
                timer: timer,
                showConfirmButton: !timer,
                customClass: {
                    popup: 'rounded-xl shadow-lg'
                }
            });
        };

        // Tab Switching Logic
        const tabs = document.querySelectorAll('.tab-item');
        const contents = {
          accountManagementTab: accountManagementContent,
          roleListTab: roleListContent,
          merchantManagementTab: merchantManagementContent
        };

        function switchTab(activeTabId) {
          Object.keys(contents).forEach(tabId => {
            const tab = document.getElementById(tabId);
            const content = contents[tabId];

            if (tabId === activeTabId) {
              tab.classList.add('active', 'border-indigo-500', 'text-indigo-600');
              tab.classList.remove('border-transparent', 'text-gray-500');
              content.classList.remove('hidden');
              if (activeTabId === 'merchantManagementTab') {
                loadMerchants(); // Load merchants when switching to this tab
              }
            } else {
              tab.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
              tab.classList.add('border-transparent', 'text-gray-500');
              content.classList.add('hidden');
            }
          });
        }

        tabs.forEach(tab => {
          tab.addEventListener('click', () => switchTab(tab.id));
        });

        // Initialize active tab (e.g., account management)
        switchTab('accountManagementTab');

        // 权限显示映射
        const PERMISSION_NAMES = {
            'y2cost_html': '成本核算',
            'temu_y2gzl_html': '货物工作流',
            'expense_allocation_function': '运费分摊核算',
            'barcode_generator_html': '条形码生成',
            'statistical_function': '统计功能',
            'query_function': '查询功能',
            'product_extractor_html': 'Temu产品提取器'
        };

        // 权限显示已由服务器端渲染，无需客户端解析
        console.log('权限显示已由服务器端处理完成');

        // Logout Logic
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                console.log("登出按钮被点击");
                try {
                    // 发送请求到后端登出路由
                    const response = await fetch('/logout', {
                        method: 'POST', // 使用 POST 方法更安全
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.redirect_url) {
                        // 如果后端返回重定向URL，则跳转
                        window.location.href = data.redirect_url;
                    } else {
                        // 如果后端返回错误或没有重定向URL
                        console.error('Logout error from backend:', data.message || '未知错误');
                        showAlert('error', '登出失败', data.message || '登出失败，请重试。');
                    }
                } catch (e) {
                    console.error('Logout request failed:', e);
                    showAlert('error', '网络错误', '无法连接到服务器，请检查网络连接。');
                }
            });
        }

        // Member Management Logic (Simplified as per existing HTML)
        // This part would typically interact with your Flask backend for user management
        // For now, it mostly handles display and basic client-side interactions
        const editBtns = membersTableBody.querySelectorAll('.edit-btn');
        const deleteBtns = membersTableBody.querySelectorAll('.delete-btn');
        const managePermissionsBtns = membersTableBody.querySelectorAll('.manage-permissions-btn');

        editBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const memberId = e.target.dataset.id;
                const memberRow = e.target.closest('tr');
                
                // 获取当前用户数据
                const username = memberRow.querySelector('td:nth-child(1)').textContent;
                const notes = memberRow.querySelector('td:nth-child(3)').textContent; // 备注列
                
                // 打开编辑抽屉
                showEditUserDrawer(memberId, username, notes);
            });
        });

        deleteBtns.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const memberId = e.target.dataset.id;
                const memberRow = e.target.closest('tr');
                const username = memberRow.querySelector('td:nth-child(1)').textContent;
                
                // 显示详细的删除确认对话框
                const result = await Swal.fire({
                    icon: 'warning',
                    title: '确认删除用户',
                    html: `您确定要删除用户 <strong>"${username}"</strong> 吗？<br><br><span style="color: #dc2626;">此操作不可撤销！</span>`,
                    showCancelButton: true,
                    confirmButtonText: '确定删除',
                    cancelButtonText: '取消',
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    reverseButtons: true,
                    focusCancel: true,
                    customClass: {
                        popup: 'rounded-xl shadow-lg'
                    }
                });
                
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/api/member/${memberId}`, {
                            method: 'DELETE'
                        });
                        const data = await response.json();
                        if (response.ok) {
                            showAlert('success', '删除成功', `用户 "${username}" 已成功删除！`, 1500);
                            e.target.closest('tr').remove(); // Remove row from UI
                        } else {
                            showAlert('error', '删除失败', data.message || '删除用户失败。');
                        }
                    } catch (error) {
                        console.error('删除用户时发生错误:', error);
                        showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                    }
                }
            });
        });

        managePermissionsBtns.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const memberId = e.target.dataset.id;
                const memberRow = e.target.closest('tr');
                
                console.log('权限管理点击 - 用户ID:', memberId, '行数据ID:', memberRow.dataset.id);
                
                // 安全解析权限数据
                let permissionsData = [];
                try {
                    const rawPermissions = memberRow.dataset.permissions;
                    console.log('原始权限数据:', rawPermissions);
                    
                    if (rawPermissions) {
                        if (typeof rawPermissions === 'string') {
                            if (rawPermissions.trim().startsWith('[')) {
                                permissionsData = JSON.parse(rawPermissions);
                            } else if (rawPermissions.trim() !== '' && rawPermissions.trim() !== '[]') {
                                permissionsData = rawPermissions.split(',').map(p => p.trim()).filter(p => p);
                            }
                        } else if (Array.isArray(rawPermissions)) {
                            permissionsData = rawPermissions;
                        }
                    }
                    
                    console.log('解析后权限数据:', permissionsData);
                } catch (error) {
                    console.error('解析权限数据失败:', error);
                    console.log('原始权限数据:', memberRow.dataset.permissions);
                    // 如果权限数据格式错误，默认为空数组
                    permissionsData = [];
                }
                
                const username = memberRow.querySelector('td:first-child').textContent;
                showPermissionsDrawer(memberId, username, permissionsData);
            });
        });

        // Permissions Drawer Logic
        const permissionsDrawer = document.getElementById('permissionsDrawer');
        const closePermissionsDrawerBtn = document.getElementById('closePermissionsDrawerBtn');
        const permissionsDrawerOverlay = document.getElementById('permissionsDrawerOverlay');
        const showPermissionsDrawer = (memberId, username, currentPermissions) => {
            console.log('显示权限抽屉 - 用户:', username, '权限:', currentPermissions);
            
            document.getElementById('permissionUserName').textContent = username;
            document.getElementById('currentMemberIdForPermissions').value = memberId;
            
            // Reset all checkboxes
            for (const key in ALL_PERMISSIONS) {
                if (ALL_PERMISSIONS.hasOwnProperty(key) && ALL_PERMISSIONS[key]) {
                    ALL_PERMISSIONS[key].checked = false;
                    console.log('重置复选框:', key, '元素:', ALL_PERMISSIONS[key]);
                }
            }
            
            // Set checked based on currentPermissions
            if (Array.isArray(currentPermissions)) {
                currentPermissions.forEach(perm => {
                    console.log('检查权限:', perm, '对应元素:', ALL_PERMISSIONS[perm]);
                    if (ALL_PERMISSIONS[perm]) {
                        ALL_PERMISSIONS[perm].checked = true;
                        console.log('已勾选权限:', perm);
                    } else {
                        console.log('权限元素未找到:', perm);
                    }
                });
            } else {
                console.log('权限数据不是数组:', currentPermissions, '类型:', typeof currentPermissions);
            }

            permissionsDrawer.classList.remove('translate-x-full', 'hidden');
            permissionsDrawer.classList.add('translate-x-0');
            permissionsDrawerOverlay.classList.remove('hidden');
        };

        const hidePermissionsDrawer = () => {
            permissionsDrawer.classList.remove('translate-x-0');
            permissionsDrawer.classList.add('translate-x-full');
            permissionsDrawerOverlay.classList.add('hidden');
        };

        if (closePermissionsDrawerBtn) {
            closePermissionsDrawerBtn.addEventListener('click', hidePermissionsDrawer);
        }
        if (permissionsDrawerOverlay) {
            permissionsDrawerOverlay.addEventListener('click', hidePermissionsDrawer);
        }

        const cancelPermissionsBtn = document.getElementById('cancelPermissionsBtn');
        const permissionsForm = document.getElementById('permissionsForm');
        const currentMemberIdForPermissions = document.getElementById('currentMemberIdForPermissions');
        const permY2CostHtml = document.getElementById('perm_y2cost_html');
        const permTemuY2GzlHtml = document.getElementById('perm_temu_y2gzl_html');
        const permExpenseAllocationFunction = document.getElementById('perm_expense_allocation_function');
        const permBarcodeGeneratorHtml = document.getElementById('perm_barcode_generator_html');

        const permStatisticalFunction = document.getElementById('perm_statistical_function'); // 新增：统计功能权限元素
        const permQueryFunction = document.getElementById('perm_query_function'); // 新增：查询功能权限元素
        const permProductExtractorHtml = document.getElementById('perm_product_extractor_html'); // 新增：Temu产品提取器权限元素

        // 定义所有可能的功能权限及其对应的标识符
        const ALL_PERMISSIONS = {
            'y2cost_html': permY2CostHtml,
            'temu_y2gzl_html': permTemuY2GzlHtml,
            'expense_allocation_function': permExpenseAllocationFunction,
            'barcode_generator_html': permBarcodeGeneratorHtml,
            'statistical_function': permStatisticalFunction, // 统计功能权限
            'query_function': permQueryFunction, // 查询功能权限
            'product_extractor_html': permProductExtractorHtml // 新增：Temu产品提取器权限
        };

        if (permissionsForm) {
            permissionsForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const memberId = currentMemberIdForPermissions.value;
                const selectedPermissions = [];

                for (const key in ALL_PERMISSIONS) {
                    if (ALL_PERMISSIONS.hasOwnProperty(key) && ALL_PERMISSIONS[key].checked) {
                        selectedPermissions.push(key);
                    }
                }

                console.log('保存权限 - 用户ID:', memberId, '选中权限:', selectedPermissions);
                
                try {
                    const response = await fetch(`/api/member/${memberId}/permissions`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ permissions: selectedPermissions })
                    });

                    console.log('权限更新响应状态:', response.status);
                    
                    const result = await response.json();
                    console.log('权限更新响应数据:', result);

                    if (response.ok) {
                        showAlert('success', '权限更新成功', result.message || '会员权限已成功更新！', 1500);
                        hidePermissionsDrawer();
                        
                        // 更新对应行的权限数据和显示
                        const memberRow = document.querySelector(`tr[data-id="${memberId}"]`);
                        if (memberRow) {
                            const newPermissionsStr = JSON.stringify(selectedPermissions);
                            memberRow.setAttribute('data-permissions', newPermissionsStr);
                            
                            // 更新权限显示列
                            const permissionDisplay = memberRow.querySelector('.permissions-display');
                            if (permissionDisplay) {
                                permissionDisplay.setAttribute('data-permissions', newPermissionsStr);
                                
                                // 直接更新显示内容
                                if (selectedPermissions.length > 0) {
                                    const permissionNames = selectedPermissions.map(p => PERMISSION_NAMES[p] || p).join(', ');
                                    permissionDisplay.innerHTML = `<span class="text-green-600">${permissionNames}</span>`;
                                } else {
                                    permissionDisplay.innerHTML = '<span class="text-gray-400">无权限</span>';
                                }
                            }
                        }
                    } else {
                        console.error('权限更新失败:', result);
                        showAlert('error', '权限更新失败', result.message || '更新会员权限失败。');
                    }
                } catch (error) {
                    console.error('更新会员权限时发生错误:', error);
                    console.error('错误堆栈:', error.stack);
                    
                    // 区分不同类型的错误
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        showAlert('error', '网络错误', '无法连接到服务器，请检查网络连接。');
                    } else if (error.name === 'SyntaxError') {
                        showAlert('error', '数据格式错误', '服务器返回的数据格式有误。');
                    } else {
                        showAlert('error', '操作失败', `权限更新时发生错误: ${error.message}`);
                    }
                }
            });
        }

        // Merchants Management Logic
        const addNewMerchantBtn = document.getElementById('addNewMerchantBtn');
        const newMerchantDrawer = document.getElementById('newMerchantDrawer');
        const closeMerchantDrawerBtn = document.getElementById('closeMerchantDrawerBtn');
        const cancelNewMerchantBtn = document.getElementById('cancelNewMerchantBtn');
        const merchantDrawerOverlay = document.getElementById('merchantDrawerOverlay');
        const newMerchantForm = document.getElementById('newMerchantForm');
        const merchantIdToEdit = document.getElementById('merchantIdToEdit');
        const merchantCodeInput = document.getElementById('merchantCode');
        const merchantNameInput = document.getElementById('merchantName');
        const merchantDrawerTitle = document.getElementById('merchantDrawerTitle');
        const merchantSearchInput = document.getElementById('merchantSearchInput');
        const merchantIdCodeInput = document.getElementById('merchantIdCode'); // 新增：商家编号输入框

        let allMerchants = []; // Store all fetched merchants for client-side filtering

        const showMerchantDrawer = (title, merchant = {}) => {
            merchantDrawerTitle.textContent = title;
            merchantIdToEdit.value = merchant.id || '';
            merchantCodeInput.value = merchant.merchant_code || '';
            merchantNameInput.value = merchant.merchant_name || '';
            merchantIdCodeInput.value = merchant.merchant_id_code || ''; // 填充商家编号

            // 如果是新增商家，自动生成商家编号
            if (title === '新增商家') {
                generateNewMerchantIdCode();
            } else {
                // 编辑时禁用商家编号输入框
                merchantIdCodeInput.readOnly = true;
                merchantIdCodeInput.classList.add('bg-gray-100');
            }
            
            newMerchantDrawer.classList.remove('translate-x-full', 'hidden');
            newMerchantDrawer.classList.add('translate-x-0');
            merchantDrawerOverlay.classList.remove('hidden');
        };

        const hideMerchantDrawer = () => {
            newMerchantDrawer.classList.remove('translate-x-0');
            newMerchantDrawer.classList.add('translate-x-full');
            merchantDrawerOverlay.classList.add('hidden');
            newMerchantForm.reset(); // Clear form on close
            merchantIdCodeInput.readOnly = false; // 恢复可编辑状态
            merchantIdCodeInput.classList.remove('bg-gray-100');
        };

        if (addNewMerchantBtn) {
            addNewMerchantBtn.addEventListener('click', () => showMerchantDrawer('新增商家'));
        }
        if (closeMerchantDrawerBtn) {
            closeMerchantDrawerBtn.addEventListener('click', hideMerchantDrawer);
        }
        if (cancelNewMerchantBtn) {
            cancelNewMerchantBtn.addEventListener('click', hideMerchantDrawer);
        }
        if (merchantDrawerOverlay) {
            merchantDrawerOverlay.addEventListener('click', hideMerchantDrawer);
        }

        newMerchantForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = merchantIdToEdit.value;
            const merchant_id_code = merchantIdCodeInput.value.trim(); // 获取商家编号
            const merchant_code = merchantCodeInput.value.trim();
            const merchant_name = merchantNameInput.value.trim();

            if (!merchant_id_code || !merchant_code || !merchant_name) {
                showAlert('warning', '输入有误', '商家编号、商家代号和商家名称不能为空。');
                return;
            }

            try {
                const dataToSave = { merchant_id_code, merchant_code, merchant_name }; // 包含商家编号

                if (id) {
                    // Update existing merchant
                    const response = await fetch(`/api/merchants/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSave)
                    });
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showAlert('success', '更新成功', '商家信息已更新！', 1500);
                        hideMerchantDrawer();
                        loadMerchants(); // Reload merchant list
                    } else {
                        showAlert('error', '更新失败', result.message || '更新商家失败。');
                    }
                } else {
                    // Add new merchant
                    const response = await fetch('/api/merchants', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSave)
                    });
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showAlert('success', '保存成功', '商家信息已保存！', 1500);
                        hideMerchantDrawer();
                        loadMerchants(); // Reload merchant list
                    } else {
                        showAlert('error', '保存失败', result.message || '保存商家失败。');
                    }
                }
            } catch (error) { // 捕获网络或其他异常
                console.error('保存商家信息时发生错误:', error);
                showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
            }
        });

        // Load Merchants Data
        async function loadMerchants(searchTerm = '') {
            try {
                let url = '/api/merchants';
                if (searchTerm) {
                    url += `?search=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    allMerchants = result.data || []; // Store all fetched merchants for search
                    renderMerchantsTable(allMerchants); // Render filtered or all data
                } else {
                    console.error('Error fetching merchants:', result.message);
                    merchantsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">加载失败: ${result.message}</td></tr>`; // 调整colspan
                }
            } catch (error) {
                console.error('Error fetching merchants:', error);
                merchantsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">网络连接失败</td></tr>`; // 调整colspan
            }
        }

        function renderMerchantsTable(merchantsToRender) {
            merchantsTableBody.innerHTML = '';
            if (merchantsToRender.length === 0) {
                merchantsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-4">暂无商家数据</td></tr>`; // 调整colspan
                return;
            }
            merchantsToRender.forEach(merchant => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${merchant.merchant_id_code || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${merchant.merchant_code}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${merchant.merchant_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-4 edit-merchant-btn" data-id="${merchant.id}">编辑</button>
                        <button class="text-red-600 hover:text-red-900 delete-merchant-btn" data-id="${merchant.id}">删除</button>
                    </td>
                `;
                merchantsTableBody.appendChild(tr);
            });

            // Attach event listeners for newly rendered buttons
            attachMerchantEventHandlers();
        }

        function attachMerchantEventHandlers() {
            merchantsTableBody.querySelectorAll('.edit-merchant-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const merchantId = e.target.dataset.id;
                    const merchantToEdit = allMerchants.find(m => m.id == merchantId);
                    if (merchantToEdit) {
                        showMerchantDrawer('编辑商家', merchantToEdit);
                    }
                });
            });

            merchantsTableBody.querySelectorAll('.delete-merchant-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const merchantId = e.target.dataset.id;
                    const merchantToDelete = allMerchants.find(m => m.id == merchantId);
                    const merchantName = merchantToDelete ? merchantToDelete.merchant_name : '该商家';

                    const result = await showAlert('question', '确认删除？', `确定要删除商家 ${merchantName} 吗？此操作不可撤销！`);
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`/api/merchants/${merchantId}`, {
                                method: 'DELETE'
                            });
                            
                            const result = await response.json();
                            if (response.ok && result.success) {
                                showAlert('success', '删除成功', '商家已删除！', 1500);
                                loadMerchants(); // Reload list after deletion
                            } else {
                                showAlert('error', '删除失败', result.message || '删除商家失败。');
                            }
                        } catch (error) {
                            console.error('删除商家时发生错误:', error);
                            showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                        }
                    }
                });
            });
        }

        // 函数：生成新的商家编号
        async function generateNewMerchantIdCode() {
            try {
                const response = await fetch('/api/merchants');
                const result = await response.json();
                
                let nextId = 1;
                if (response.ok && result.success && result.data && result.data.length > 0) {
                    // 找到最大的编号
                    const maxId = Math.max(...result.data.map(merchant => {
                        const idCode = merchant.merchant_id_code;
                        const idNum = parseInt(idCode, 10);
                        return isNaN(idNum) ? 0 : idNum;
                    }));
                    nextId = maxId + 1;
                }
                merchantIdCodeInput.value = String(nextId).padStart(4, '0');
            } catch (e) {
                console.error('自动生成商家编号失败:', e);
                showAlert('error', '自动生成商家编号失败', e.message || '网络连接失败');
                merchantIdCodeInput.value = ''; // 失败时清空
            }
        }

        // Merchant Search Input Event
        if (merchantSearchInput) {
            merchantSearchInput.addEventListener('input', () => {
                const searchTerm = merchantSearchInput.value.trim();
                loadMerchants(searchTerm); // Load merchants with search term
            });
        }

        // Sub-account Management Logic
        const addNewSubAccountBtn = document.getElementById('addNewSubAccountBtn');
        const newAccountDrawer = document.getElementById('newAccountDrawer');
        const closeDrawerBtn = document.getElementById('closeDrawerBtn');
        const cancelNewAccountBtn = document.getElementById('cancelNewAccountBtn');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const newSubAccountForm = document.getElementById('newSubAccountForm');

        const showSubAccountDrawer = () => {
            newAccountDrawer.classList.remove('translate-x-full', 'hidden');
            newAccountDrawer.classList.add('translate-x-0');
            drawerOverlay.classList.remove('hidden');
        };

        const hideSubAccountDrawer = () => {
            newAccountDrawer.classList.remove('translate-x-0');
            newAccountDrawer.classList.add('translate-x-full');
            drawerOverlay.classList.add('hidden');
            // 清空表单
            newSubAccountForm.reset();
        };

        if (addNewSubAccountBtn) {
            addNewSubAccountBtn.addEventListener('click', showSubAccountDrawer);
        }

        if (closeDrawerBtn) {
            closeDrawerBtn.addEventListener('click', hideSubAccountDrawer);
        }

        if (cancelNewAccountBtn) {
            cancelNewAccountBtn.addEventListener('click', hideSubAccountDrawer);
        }

        if (drawerOverlay) {
            drawerOverlay.addEventListener('click', hideSubAccountDrawer);
        }

        if (newSubAccountForm) {
            newSubAccountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const email = document.getElementById('newEmail').value.trim();

                // 验证输入
                if (!username || !password) {
                    showAlert('warning', '输入有误', '账号名和密码不能为空。');
                    return;
                }

                if (password !== confirmPassword) {
                    showAlert('warning', '密码不匹配', '两次输入的密码不一致。');
                    return;
                }

                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password,
                            email: email || `${username}`,
                            role: 'user',
                            notes: '子账号'
                        })
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        showAlert('success', '创建成功', '子账号已创建！', 1500);
                        hideSubAccountDrawer();
                        // 重新加载页面以显示新用户
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert('error', '创建失败', result.message || '创建子账号失败。');
                    }
                } catch (error) {
                    console.error('创建子账号时发生错误:', error);
                    showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                }
            });
        }

        // 编辑用户抽屉逻辑
        const editUserDrawer = document.getElementById('editUserDrawer');
        const closeEditUserDrawerBtn = document.getElementById('closeEditUserDrawerBtn');
        const editUserDrawerOverlay = document.getElementById('editUserDrawerOverlay');
        const editUserForm = document.getElementById('editUserForm');
        const cancelEditUserBtn = document.getElementById('cancelEditUserBtn');

        // 显示编辑用户抽屉
        const showEditUserDrawer = (memberId, username, notes) => {
            console.log('显示编辑用户抽屉:', { memberId, username, notes });
            
            // 填充表单数据
            document.getElementById('editUserId').value = memberId;
            document.getElementById('editUsernameDisplay').textContent = username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editPasswordConfirm').value = '';
            document.getElementById('editNotes').value = notes || '';
            
            // 显示抽屉
            editUserDrawer.classList.remove('translate-x-full', 'hidden');
            editUserDrawer.classList.add('translate-x-0');
            editUserDrawerOverlay.classList.remove('hidden');
        };

        // 隐藏编辑用户抽屉
        const hideEditUserDrawer = () => {
            editUserDrawer.classList.remove('translate-x-0');
            editUserDrawer.classList.add('translate-x-full');
            editUserDrawerOverlay.classList.add('hidden');
        };

        // 关闭按钮事件
        if (closeEditUserDrawerBtn) {
            closeEditUserDrawerBtn.addEventListener('click', hideEditUserDrawer);
        }
        if (editUserDrawerOverlay) {
            editUserDrawerOverlay.addEventListener('click', hideEditUserDrawer);
        }
        if (cancelEditUserBtn) {
            cancelEditUserBtn.addEventListener('click', hideEditUserDrawer);
        }

        // 编辑用户表单提交
        if (editUserForm) {
            editUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userId = document.getElementById('editUserId').value;
                const password = document.getElementById('editPassword').value.trim();
                const passwordConfirm = document.getElementById('editPasswordConfirm').value.trim();
                const notes = document.getElementById('editNotes').value.trim();
                
                // 验证密码
                if (!password) {
                    showAlert('warning', '输入有误', '新密码不能为空。');
                    return;
                }
                
                if (password.length < 6) {
                    showAlert('warning', '密码太短', '密码长度至少为6位。');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    showAlert('warning', '密码不匹配', '两次输入的密码不一致，请重新输入。');
                    return;
                }

                try {
                    const response = await fetch(`/api/member/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            password: password,
                            notes: notes
                        })
                    });

                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showAlert('success', '更新成功', '用户密码和备注已更新！', 1500);
                        hideEditUserDrawer();
                        
                        // 更新表格中的备注数据
                        const memberRow = document.querySelector(`tr[data-id="${userId}"]`);
                        if (memberRow) {
                            memberRow.querySelector('td:nth-child(3)').textContent = notes || '';
                        }
                    } else {
                        showAlert('error', '更新失败', result.message || '更新用户信息失败。');
                    }
                } catch (error) {
                    console.error('更新用户信息时发生错误:', error);
                    showAlert('error', '网络错误', '无法连接到服务器，请稍后再试。');
                }
            });
        }

        // 将 showEditUserDrawer 函数暴露给全局作用域，以便编辑按钮可以调用
        window.showEditUserDrawer = showEditUserDrawer;
    });
  </script>

  <!-- New Sub-account Drawer -->
  <div id="newAccountDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="drawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800">新建子账号</h2>
        <button id="closeDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="newSubAccountForm" class="flex-grow space-y-4">
        <h3 class="text-lg font-medium text-gray-700">基本信息</h3>
        <div>
          <label for="newUsername" class="block text-sm font-medium text-gray-700">*账号名</label>
          <input type="text" id="newUsername" name="username" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">*登录密码</label>
          <input type="password" id="newPassword" name="password" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700">*确认密码</label>
          <input type="password" id="confirmPassword" name="confirm_password" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="newEmail" class="block text-sm font-medium text-gray-700">邮箱</label>
          <input type="email" id="newEmail" name="email"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="newRole" class="block text-sm font-medium text-gray-700">*子账号角色</label>
          <div class="mt-1 p-3 bg-yellow-400 text-black text-center font-bold rounded-md">
            功能模块开发
          </div>
          <!-- <select id="newRole" name="role" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <option value="member">普通会员</option>
            <option value="admin">管理员</option>
          </select> -->
        </div>
        <!-- Other fields as needed -->

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelNewAccountBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">创建账号</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Permissions Management Drawer -->
  <div id="permissionsDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="permissionsDrawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800">管理会员权限 <span id="permissionUserName" class="text-sm text-gray-500 font-normal ml-2"></span></h2>
        <button id="closePermissionsDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="permissionsForm" class="flex-grow space-y-4">
        <input type="hidden" id="currentMemberIdForPermissions">
        <h3 class="text-lg font-medium text-gray-700 mb-4">请勾选该用户可访问的功能：</h3>

        <div class="space-y-2">
          <div class="flex items-center">
            <input type="checkbox" id="perm_expense_allocation_function" name="permissions" value="expense_allocation_function" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_expense_allocation_function" class="ml-2 block text-sm text-gray-900">运费分摊核算</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_y2cost_html" name="permissions" value="y2cost_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_y2cost_html" class="ml-2 block text-sm text-gray-900">成本核算</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_temu_y2gzl_html" name="permissions" value="temu_y2gzl_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_temu_y2gzl_html" class="ml-2 block text-sm text-gray-900">货物工作流</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_barcode_generator_html" name="permissions" value="barcode_generator_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_barcode_generator_html" class="ml-2 block text-sm text-gray-900">条形码生成</label>
          </div>

                    <div class="flex items-center">
            <input type="checkbox" id="perm_statistical_function" name="permissions" value="statistical_function" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_statistical_function" class="ml-2 block text-sm text-gray-900">统计功能</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_query_function" name="permissions" value="query_function" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_query_function" class="ml-2 block text-sm text-gray-900">查询功能</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="perm_product_extractor_html" name="permissions" value="product_extractor_html" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <label for="perm_product_extractor_html" class="ml-2 block text-sm text-gray-900">Temu产品提取器</label>
          </div>
        </div>

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelPermissionsBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">保存权限</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Drawer -->
  <div id="editUserDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="editUserDrawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800">编辑用户信息</h2>
        <button id="closeEditUserDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="editUserForm" class="flex-grow space-y-4">
        <input type="hidden" id="editUserId">
        
        <!-- 只读的用户名显示 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">用户名</label>
          <div id="editUsernameDisplay" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600 text-sm"></div>
        </div>
        
        <!-- 密码编辑字段 -->
        <div>
          <label for="editPassword" class="block text-sm font-medium text-gray-700">*新密码</label>
          <input type="password" id="editPassword" name="password" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                 placeholder="请输入新密码">
        </div>
        
        <!-- 确认密码字段 -->
        <div>
          <label for="editPasswordConfirm" class="block text-sm font-medium text-gray-700">*确认新密码</label>
          <input type="password" id="editPasswordConfirm" name="password_confirm" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                 placeholder="请再次输入新密码">
        </div>
        
        <!-- 备注编辑字段 -->
        <div>
          <label for="editNotes" class="block text-sm font-medium text-gray-700">备注</label>
          <textarea id="editNotes" name="notes" rows="3"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                    placeholder="请输入备注信息"></textarea>
        </div>

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelEditUserBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">保存更改</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Merchant Drawer -->
  <div id="newMerchantDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="merchantDrawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800" id="merchantDrawerTitle">新增商家</h2>
        <button id="closeMerchantDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="newMerchantForm" class="flex-grow space-y-4">
        <input type="hidden" id="merchantIdToEdit">
        <div>
            <label for="merchantIdCode" class="block text-sm font-medium text-gray-700">*商家编号</label>
            <input type="text" id="merchantIdCode" name="merchant_id_code" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="merchantCode" class="block text-sm font-medium text-gray-700">*商家代号</label>
          <input type="text" id="merchantCode" name="merchant_code" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>
        <div>
          <label for="merchantName" class="block text-sm font-medium text-gray-700">*商家名称</label>
          <input type="text" id="merchantName" name="merchant_name" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
        </div>

        <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
          <button type="button" id="cancelNewMerchantBtn" class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300 text-sm">取消</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm">保存商家</button>
        </div>
      </form>
    </div>
  </div>

</body>
</html>