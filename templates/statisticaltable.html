<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>统计功能</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .filter-section {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 text-sm">
  <div class="container mx-auto px-4 py-8 max-w-screen-2xl">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">统计功能</h1>
      <!-- 返回功能列表按钮，假设存在一个 pt_function_interface 路由 -->
      <a href="{{ url_for('pt_function_interface') }}" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg transform hover:translate-y-[-2px] hover:shadow-xl">
        <i class="fa fa-arrow-left mr-2"></i> 返回功能列表
      </a>
    </div>

    <!-- 筛选功能区域 -->
    <div class="bg-white rounded-xl p-6 mb-6 filter-section">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 items-end">
        <div class="flex flex-col">
          <label for="startDateFilter" class="text-gray-600 font-medium mb-1 text-sm">开始时间:</label>
          <input type="date" id="startDateFilter" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm">
        </div>
        <div class="flex flex-col">
          <label for="endDateFilter" class="text-gray-600 font-medium mb-1 text-sm">结束时间:</label>
          <input type="date" id="endDateFilter" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm">
        </div>
        <div class="flex flex-col">
          <label for="trackingNumberFilter" class="text-gray-600 font-medium mb-1 text-sm">运单号:</label>
          <input type="text" id="trackingNumberFilter" placeholder="请输入运单号 (多个请用逗号分隔)" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm">
        </div>
        <div class="flex flex-col">
          <label for="merchantFilter" class="text-gray-600 font-medium mb-1 text-sm">商家:</label>
          <input type="text" id="merchantFilter" placeholder="请输入商家名称" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm" list="merchantsList">
          <datalist id="merchantsList"></datalist>
        </div>
        <div class="flex justify-end lg:justify-start items-end">
          <button id="queryBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg justify-center text-sm">
            <i class="fa fa-search mr-2"></i> 查询
          </button>
        </div>
      </div>
    </div>

    <!-- 统计数据展示区域 -->
    <div class="bg-white rounded-xl overflow-hidden filter-section p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">统计数据概览</h2>
        <div class="flex items-center space-x-2">
          <button id="saveAllBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg justify-center text-sm">
            <i class="fa fa-save mr-2"></i> 保存查询结果
          </button>
          <button id="exportExcelBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg justify-center text-sm">
            <i class="fa fa-file-excel-o mr-2"></i> 导出Excel
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
          <thead>
            <tr class="bg-gray-50 text-left">
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">序号</th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group flex items-center justify-center">
                <div class="flex items-center">
                  日期
                  <div class="flex flex-col ml-1">
                    <i id="sortDateAsc" class="fa fa-sort-asc cursor-pointer text-gray-400 hover:text-gray-600" title="按日期升序排序"></i>
                    <i id="sortDateDesc" class="fa fa-sort-desc cursor-pointer text-gray-400 hover:text-gray-600" title="按日期降序排序"></i>
                  </div>
                </div>
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                运单号
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                表单编号
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                商家
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                结算重量
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                货代价
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                报税价
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                小计运费
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                件数
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                操作费
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                小计操作费
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">合计</th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody id="statisticalSummaryBody" class="bg-white divide-y divide-gray-200">
            <!-- Data rows will be inserted here -->
          </tbody>
          <tfoot class="bg-gray-50">
            <tr class="font-bold text-gray-700">
              <td colspan="5" class="px-4 py-2 text-right">合计:</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 total-settle-weight-sum">0.000</td>
              <td class="px-4 py-2"></td> <!-- 货代价 -->
              <td class="px-4 py-2"></td> <!-- 报税价 -->
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-freight-sum">0.00</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 pieces-sum">0</td>
              <td class="px-4 py-2"></td> <!-- 操作费 -->
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-operating-fee-sum">0.00</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 total-overall-sum">0.00</td>
              <td class="px-4 py-2"></td> <!-- 操作列，合计行不需要显示数据 -->
            </tr>
          </tfoot>
        </table>
      </div>
      <div id="statisticsDisplay" class="text-gray-700 mt-4">
        <!-- Old placeholder text. Will be replaced by updating cells directly. -->
      </div>
    </div>
  </div>

  <!-- 自定义右键菜单 -->
  <div id="customContextMenu" class="fixed bg-white border border-gray-300 rounded-md shadow-lg z-50 py-1 hidden">
    <a href="#" id="saveRowOption" class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-500 hover:text-white">保存当前行</a>
  </div>

  <!-- 结算单据侧边栏 (Drawer) -->
  <div id="settlementBillDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out hidden">
    <!-- Overlay -->
    <div id="billDrawerOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden"></div>

    <!-- Drawer Panel -->
    <div class="absolute right-0 top-0 w-full md:w-1/2 lg:w-1/3 h-full bg-white shadow-xl flex flex-col p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-800">结算单据</h2>
        <button id="closeBillDrawerBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <div id="billContent" class="flex-grow overflow-y-auto p-4 border rounded-md bg-gray-50 mb-6 text-sm leading-relaxed">
        <h3 class="text-center font-bold text-lg mb-4">结算单据</h3>
        <table class="w-full text-left table-auto border-collapse">
          <tbody>
            <tr><td class="py-1 font-medium">日期:</td><td class="py-1" id="billDate"></td></tr>
            <tr><td class="py-1 font-medium">运单号:</td><td class="py-1" id="billTrackingNumber"></td></tr>
            <tr><td class="py-1 font-medium">结算重量:</td><td class="py-1" id="billSettleWeight"></td></tr>
            <tr><td class="py-1 font-medium">报税价:</td><td class="py-1" id="billTaxUnitPrice"></td></tr>
            <tr><td class="py-1 font-medium">小计运费:</td><td class="py-1" id="billSubtotalFreight"></td></tr>
            <tr><td class="py-1 font-medium">件数:</td><td class="py-1" id="billPieces"></td></tr>
            <tr><td class="py-1 font-medium">操作费:</td><td class="py-1" id="billOperatingFee"></td></tr>
            <tr><td class="py-1 font-medium">小计操作费:</td><td class="py-1" id="billSubtotalOperatingFee"></td></tr>
            <tr><td class="py-1 font-medium">合计:</td><td class="py-1" id="billTotalOverall"></td></tr>
            <tr><td class="py-1 font-medium">备注:</td><td class="py-1"><textarea id="billNotes" class="w-full p-1 border border-gray-300 rounded-md text-sm" rows="3"></textarea></td></tr>
          </tbody>
        </table>
        <div class="mt-4 text-center text-gray-600">Generated on: <span id="billGenerationDate"></span></div>
      </div>

      <div class="flex justify-end pt-4 border-t border-gray-200 mt-auto">
        <button id="printBillBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 text-sm flex items-center">
          <i class="fa fa-print mr-2"></i> 打印单据
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase 初始化 (假设与现有项目配置一致)
    const SUPABASE_URL = 'https://xehoqrboglykebqvovgj.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlaG9xcmJvZ2x5a2VicXZvdmdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NTk2OTMsImV4cCI6MjA2NTIzNTY5M30.v8iMnNK_b3hGuum4qvreBzf19NiEJ11Dz4Q_Oy_7ySg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let finalData = []; // 将 finalData 声明为全局变量
    console.log("Script loaded. Initial finalData:", finalData); // Debugging: Check initial finalData

    document.addEventListener('DOMContentLoaded', function() {
      const startDateFilter = document.getElementById('startDateFilter');
      const endDateFilter = document.getElementById('endDateFilter');
      const trackingNumberFilter = document.getElementById('trackingNumberFilter');
      const merchantFilter = document.getElementById('merchantFilter');
      const queryBtn = document.getElementById('queryBtn');
      const saveAllBtn = document.getElementById('saveAllBtn'); // New: Get saveAllBtn
      const exportExcelBtn = document.getElementById('exportExcelBtn'); // New: Get exportExcelBtn
      const merchantsList = document.getElementById('merchantsList');
      const statisticalSummaryBody = document.getElementById('statisticalSummaryBody'); // 获取 tbody 元素

      // --- 合计计算和显示函数 START
      const updateTotalsDisplay = () => {
        let totalSettleWeightSum = 0;
        let subtotalFreightSum = 0;
        let piecesSum = 0;
        let subtotalOperatingFeeSum = 0;
        let totalOverallSum = 0;

        const rows = document.querySelectorAll('#statisticalSummaryBody tr');
        rows.forEach(row => {
          totalSettleWeightSum += parseFloat(row.querySelector('td:nth-child(6)').textContent) || 0; // 结算重量 (第6列)
          subtotalFreightSum += parseFloat(row.querySelector('.subtotal-freight').textContent) || 0; // 小计运费
          piecesSum += parseInt(row.querySelector('td:nth-child(10)').textContent) || 0; // 件数 (第10列)
          subtotalOperatingFeeSum += parseFloat(row.querySelector('.subtotal-operating-fee').textContent) || 0; // 小计操作费
          totalOverallSum += parseFloat(row.querySelector('.total-overall').textContent) || 0; // 合计
        });

        document.querySelector('.total-settle-weight-sum').textContent = totalSettleWeightSum.toFixed(3);
        document.querySelector('.subtotal-freight-sum').textContent = subtotalFreightSum.toFixed(2);
        document.querySelector('.pieces-sum').textContent = piecesSum;
        document.querySelector('.subtotal-operating-fee-sum').textContent = subtotalOperatingFeeSum.toFixed(2);
        document.querySelector('.total-overall-sum').textContent = totalOverallSum.toFixed(2);
      };
      // --- 合计计算和显示函数 END

      // 渲染表格的函数，将数据绑定到HTML
      const renderTable = (dataToRender) => {
        statisticalSummaryBody.innerHTML = ''; // 清空之前的内容

        if (dataToRender && dataToRender.length > 0) {
          dataToRender.forEach((item, index) => {
            const date = item.date || '';
            const trackingNumber = item.tracking_number || '';
            const totalSettleWeight = (parseFloat(item.total_settle_weight) || 0).toFixed(3);
            const freightUnitPrice = (parseFloat(item.freight_unit_price) || 0).toFixed(2);
            const merchantName = item.merchant_name || '';
            const pieces = (parseInt(item.merchant_pieces) || 0);
            // 计算每个商户的结算重量： (商户的货物实重 / 整个运单的实重+纸箱) * 整个运单的总结算重量
            const merchantSettleWeightDisplay = ((parseFloat(item.merchant_weight) || 0) / (parseFloat(item.actual_weight_with_box) || 1.0) * (parseFloat(item.total_settle_weight) || 0)).toFixed(3);
            const taxUnitPrice = (parseFloat(item.merchant_tax_unit_price) || 0).toFixed(2);
            const operatingFee = (parseFloat(item.merchant_operating_fee) || 0).toFixed(2);
            const subtotalFreight = (parseFloat(item.subtotal_freight) || 0).toFixed(2);
            const subtotalOperatingFee = (parseFloat(item.subtotal_operating_fee) || 0).toFixed(2);
            const totalOverall = (parseFloat(item.total_overall) || 0).toFixed(2);

            const row = document.createElement('tr');
            row.classList.add('bg-white', 'divide-y', 'divide-gray-200');
            row.dataset.itemId = item.id; // shipping_costs 的 ID
            row.dataset.merchantName = merchantName; // 商家名称

            row.innerHTML = `
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${date}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${trackingNumber}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${item.order_number || ''}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${merchantName}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${merchantSettleWeightDisplay}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${freightUnitPrice}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <input type="number" class="tax-unit-price-input px-1 py-0.5 border border-gray-300 rounded-md w-24 text-sm text-right focus:ring-blue-300 focus:border-blue-300" value="${taxUnitPrice}" step="0.01" data-original-value="${taxUnitPrice}">
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-freight">${subtotalFreight}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${pieces}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <input type="number" class="operating-fee-input px-1 py-0.5 border border-gray-300 rounded-md w-24 text-sm text-right focus:ring-blue-300 focus:border-blue-300" value="${operatingFee}" step="0.01" data-original-value="${operatingFee}">
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-operating-fee">${subtotalOperatingFee}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 total-overall">${totalOverall}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <button class="bill-btn bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 mr-2">开单</button>
                <select class="settlement-status-select px-2 py-1 border border-gray-300 rounded-md w-24 text-sm focus:ring-blue-300 focus:border-blue-300">
                  <option value="未结款" ${item.settlement_status === '未结款' ? 'selected' : ''}>未结款</option>
                  <option value="已结款" ${item.settlement_status === '已结款' ? 'selected' : ''}>已结款</option>
                </select>
              </td>
            `;
            statisticalSummaryBody.appendChild(row);

            // 为新创建的 input 和 select 添加事件监听
            const newTaxInput = row.querySelector('.tax-unit-price-input');
            const newOperatingInput = row.querySelector('.operating-fee-input');

            const updateCalculations = () => {
              const currentTaxUnitPrice = parseFloat(newTaxInput.value) || 0;
              const currentOperatingFee = parseFloat(newOperatingInput.value) || 0;

              const currentMerchantSettleWeight = parseFloat(row.querySelector('td:nth-child(6)').textContent) || 0; // 现在是第6列
              const currentPieces = parseFloat(row.querySelector('td:nth-child(10)').textContent) || 0; // 现在是第10列

              const newSubtotalFreight = (currentMerchantSettleWeight * currentTaxUnitPrice).toFixed(2);
              const newSubtotalOperatingFee = (currentPieces * currentOperatingFee).toFixed(2);
              const newTotalOverall = (parseFloat(newSubtotalFreight) + parseFloat(newSubtotalOperatingFee)).toFixed(2);

              row.querySelector('.subtotal-freight').textContent = newSubtotalFreight;
              row.querySelector('.subtotal-operating-fee').textContent = newSubtotalOperatingFee;
              row.querySelector('.total-overall').textContent = newTotalOverall;

              // 更新合计行
              updateTotalsDisplay();
            };

            newTaxInput.addEventListener('input', updateCalculations);
            newOperatingInput.addEventListener('input', updateCalculations);

            // 新增：为结算状态下拉选择框添加事件监听
            const settlementStatusSelect = row.querySelector('.settlement-status-select');
            settlementStatusSelect.addEventListener('change', async (e) => {
              const newStatus = e.target.value;
              const itemId = row.dataset.itemId;

              try {
                const response = await fetch('/api/shipping_costs/update_settlement_status', {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ id: itemId, settlement_status: newStatus })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                  Swal.fire({
                    icon: 'success',
                    title: '状态更新成功！',
                    text: result.message,
                    timer: 1500,
                    showConfirmButton: false
                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: '状态更新失败！',
                    text: result.message || '未知错误',
                    timer: 3000
                  });
                  e.target.value = e.target.options[e.target.dataset.originalIndex].value; // Revert to original if error
                }
              } catch (error) {
                console.error('更新结款状态请求失败:', error);
                Swal.fire({
                  icon: 'error',
                  title: '网络错误',
                  text: '无法连接到服务器，请检查网络连接。'
                });
                e.target.value = e.target.options[e.target.dataset.originalIndex].value; // Revert to original if error
              }
            });
            settlementStatusSelect.dataset.originalIndex = settlementStatusSelect.selectedIndex; // Store original selected index

            // 新增：为开单按钮添加事件监听
            const billBtn = row.querySelector('.bill-btn');
            billBtn.addEventListener('click', () => {
              showSettlementBillDrawer(item); // 传递当前行的数据
            });
          });
        } else {
          statisticalSummaryBody.innerHTML = `<tr><td colspan="13" class="px-4 py-2 text-center text-gray-500">没有找到匹配的数据。</td></tr>`;
        }
        updateTotalsDisplay(); // Ensure totals are updated after initial render
      };

      // --- 排序功能 START
      const sortDateAsc = document.getElementById('sortDateAsc');
      const sortDateDesc = document.getElementById('sortDateDesc');

      const sortDataByDate = (order) => {
        if (!finalData || finalData.length === 0) return;

        finalData.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          if (order === 'asc') {
            return dateA.getTime() - dateB.getTime();
          } else {
            return dateB.getTime() - dateA.getTime();
          }
        });
        renderTable(finalData); // 重新渲染表格
      };

      sortDateAsc.addEventListener('click', () => sortDataByDate('asc'));
      sortDateDesc.addEventListener('click', () => sortDataByDate('desc'));
      // --- 排序功能 END

      // 加载所有唯一的商家名称到 datalist
      async function loadMerchantsIntoDatalist() {
        try {
          // 修改：从 'merchants' 表中选择 'merchant_name' 字段
          const { data, error } = await supabase.from('merchants').select('merchant_name').order('merchant_name', { ascending: true });

          if (error) {
            console.error('加载商家数据失败:', error.message);
            return;
          }

          merchantsList.innerHTML = ''; // 清空现有选项
          if (data) {
            data.forEach(item => {
              if (item.merchant_name) {
                const option = document.createElement('option');
                option.value = item.merchant_name;
                merchantsList.appendChild(option);
              }
            });
          }

        } catch (e) {
          console.error('加载商家数据时发生异常:', e.message);
        }
      }

      // 初始加载商家列表
      loadMerchantsIntoDatalist();

      // Table column resizing logic
      const resizers = document.querySelectorAll('.resizer');
      let currentColumn;
      let initialX;
      let initialWidth;

      resizers.forEach(resizer => {
        resizer.addEventListener('mousedown', (e) => {
          currentColumn = e.target.closest('th');
          initialX = e.clientX;
          initialWidth = currentColumn.offsetWidth;

          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
          document.body.style.cursor = 'col-resize'; // Change cursor while dragging
        });
      });

      const mouseMoveHandler = (e) => {
        const diffX = e.clientX - initialX;
        const newWidth = initialWidth + diffX;
        if (newWidth > 50) { // Minimum width to prevent columns from becoming too small
          currentColumn.style.width = `${newWidth}px`;
          currentColumn.style.minWidth = `${newWidth}px`;
        }
      };

      const mouseUpHandler = () => {
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
        document.body.style.cursor = ''; // Reset cursor
      };

      queryBtn.addEventListener('click', async () => {
        const startDate = startDateFilter.value;
        const endDate = endDateFilter.value;
        let trackingNumber = trackingNumberFilter.value;
        const merchant = merchantFilter.value;

        // 直接从 shipping_costs 表查询数据，确保能获取到 order_number 字段
        let query = supabase.from('shipping_costs').select(`
          id, date, tracking_number, order_number, freight_unit_price, 
          total_settle_weight, actual_weight_with_box, settlement_status, merchants
        `);
        
        // 应用筛选条件
        if (startDate) {
          query = query.gte('date', startDate);
        }
        if (endDate) {
          query = query.lte('date', endDate);
        }
        if (trackingNumber) {
          const trackingNumbers = trackingNumber.split(',').map(num => num.trim()).filter(num => num !== '');
          if (trackingNumbers.length === 1) {
            query = query.eq('tracking_number', trackingNumbers[0]);
          } else if (trackingNumbers.length > 1) {
            query = query.in('tracking_number', trackingNumbers);
          }
        }
        
        let { data: rawData, error: finalError } = await query.order('date', { ascending: false });
        
        console.log('Supabase Raw Data:', rawData); // 打印原始查询数据
        console.log('Supabase Query Error:', finalError);
        
        // 将数据展开为每个商家一行的格式
        const expandedData = [];
        if (rawData && !finalError) {
          rawData.forEach(item => {
            if (item.merchants && Array.isArray(item.merchants)) {
              item.merchants.forEach(merchantData => {
                // 商家名称筛选
                if (!merchant || merchantData.name.toLowerCase().includes(merchant.toLowerCase())) {
                  const merchantWeight = parseFloat(merchantData.weight) || 0;
                  const merchantPieces = parseInt(merchantData.pieces) || 0;
                  const merchantTaxUnitPrice = parseFloat(merchantData.tax_unit_price) || 0;
                  const merchantOperatingFee = parseFloat(merchantData.operating_fee) || 0;
                  
                  // 计算商家结算重量（按重量比例分配）
                  const totalActualWeight = parseFloat(item.actual_weight_with_box) || 1;
                  const merchantSettleWeight = (merchantWeight / totalActualWeight) * (parseFloat(item.total_settle_weight) || 0);
                  
                  // 计算费用
                  const subtotalFreight = merchantSettleWeight * merchantTaxUnitPrice;
                  const subtotalOperatingFee = merchantPieces * merchantOperatingFee;
                  const totalOverall = subtotalFreight + subtotalOperatingFee;
                  
                  expandedData.push({
                    id: item.id,
                    date: item.date,
                    tracking_number: item.tracking_number,
                    order_number: item.order_number, // 关键：确保包含表单编号
                    freight_unit_price: item.freight_unit_price,
                    total_settle_weight: merchantSettleWeight, // 商家的结算重量
                    actual_weight_with_box: item.actual_weight_with_box,
                    settlement_status: item.settlement_status,
                    merchant_name: merchantData.name,
                    merchant_weight: merchantWeight,
                    merchant_pieces: merchantPieces,
                    merchant_tax_unit_price: merchantTaxUnitPrice,
                    merchant_operating_fee: merchantOperatingFee,
                    subtotal_freight: subtotalFreight,
                    subtotal_operating_fee: subtotalOperatingFee,
                    total_overall: totalOverall
                  });
                }
              });
            }
          });
        }
        
        finalData = expandedData; // 赋值给全局变量

        // 调试：检查第一条数据是否包含order_number字段
        if (finalData && finalData.length > 0) {
          console.log('第一条处理后数据详情:', finalData[0]);
          console.log('order_number字段值:', finalData[0].order_number);
        }

        if (finalError) {
          console.error('查询统计数据失败:', finalError.message);
          statisticalSummaryBody.innerHTML = `<tr><td colspan="13" class="px-4 py-2 text-center text-red-500">加载失败: ${finalError.message}</td></tr>`;
          document.querySelector('.total-settle-weight-sum').textContent = '0.000';
          document.querySelector('.subtotal-freight-sum').textContent = '0.00';
          document.querySelector('.pieces-sum').textContent = '0';
          document.querySelector('.subtotal-operating-fee-sum').textContent = '0.00';
          document.querySelector('.total-overall-sum').textContent = '0.00';
          return;
        }

        renderTable(finalData); // 调用渲染函数
      });

      // 初始查询和渲染
      queryBtn.click(); // 在页面加载时自动执行一次查询
    });

    // --- 右键菜单和保存功能 --- START
    const customContextMenu = document.getElementById('customContextMenu');
    const saveRowOption = document.getElementById('saveRowOption');
    let currentRowData = null; // 用于存储当前右键点击行的数据

    // 隐藏右键菜单的函数
    const hideContextMenu = () => {
      customContextMenu.classList.add('hidden');
    };

    // 在文档任意地方点击时隐藏菜单
    document.addEventListener('click', hideContextMenu);

    // 阻止右键菜单在自身上触发
    customContextMenu.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // 监听表格 tbody 的右键点击事件
    const statisticalSummaryBody = document.getElementById('statisticalSummaryBody'); // Get it here
    statisticalSummaryBody.addEventListener('contextmenu', (e) => {
      console.log('Right-click event detected on statisticalSummaryBody.', e.target); // Debugging line
      console.log('finalData at contextmenu:', finalData); // Added debug log
      const clickedRow = e.target.closest('tr');
      if (clickedRow) {
        console.log('Clicked row found:', clickedRow); // Debugging line
        e.preventDefault(); // 阻止默认右键菜单

        // 收集当前行的数据
        const itemId = clickedRow.dataset.itemId; // shipping_costs 的 ID
        const merchantName = clickedRow.dataset.merchantName; // 商家名称
        const taxInput = clickedRow.querySelector('.tax-unit-price-input');
        const operatingInput = clickedRow.querySelector('.operating-fee-input');
        const taxUnitPrice = parseFloat(taxInput.value) || 0;
        const operatingFee = parseFloat(operatingInput.value) || 0;

        // 获取当前行的计算值
        const currentSubtotalFreight = parseFloat(clickedRow.querySelector('.subtotal-freight').textContent) || 0;
        const currentSubtotalOperatingFee = parseFloat(clickedRow.querySelector('.subtotal-operating-fee').textContent) || 0;
        const currentTotalOverall = parseFloat(clickedRow.querySelector('.total-overall').textContent) || 0;

        currentRowData = {
          id: itemId,
          merchant_name: merchantName,
          tax_unit_price: taxUnitPrice,
          operating_fee: operatingFee,
          total_overall: currentTotalOverall // 保存时转为数字
        };

        // 显示自定义菜单
        customContextMenu.style.left = `${e.clientX}px`;
        customContextMenu.style.top = `${e.clientY}px`;
        customContextMenu.classList.remove('hidden');
        console.log('Context menu position set to:', customContextMenu.style.left, customContextMenu.style.top); // New debug log

        e.stopPropagation(); // 阻止事件冒泡到 document，以免立即隐藏菜单
      } else {
        console.log('No row found for right-click event. e.target:', e.target); // New debug log
        hideContextMenu(); // Hide the menu if no row is found, ensures default menu behavior is restored.
      }
    });

    // 保存选项点击事件
    saveRowOption.addEventListener('click', async () => {
      if (!currentRowData) return;

      try {
        const response = await fetch('/api/shipping_costs/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(currentRowData)
        });

        const result = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: '保存成功！',
            text: result.message,
            timer: 1500,
            showConfirmButton: false
          });
          // 可以选择重新加载数据或仅更新前端显示，这里简单起见，提示成功
        } else {
          Swal.fire({
            icon: 'error',
            title: '保存失败！',
            text: result.message || '未知错误',
            timer: 3000
          });
        }
      } catch (error) {
        console.error('保存请求失败:', error);
        Swal.fire({
          icon: 'error',
          title: '网络错误',
          text: '无法连接到服务器，请检查网络连接。',
          timer: 3000
        });
      }
      hideContextMenu();
      currentRowData = null; // 清空当前行数据
    });

    // Save All Button Event Listener
    saveAllBtn.addEventListener('click', async () => {
      const rowsToUpdate = [];
      const tableRows = document.querySelectorAll('#statisticalSummaryBody tr');

      tableRows.forEach(row => {
        const itemId = row.dataset.itemId;
        const merchantName = row.dataset.merchantName;
        if (itemId && merchantName) { // Only process rows that have an item ID and merchant name
          const taxInput = row.querySelector('.tax-unit-price-input');
          const operatingInput = row.querySelector('.operating-fee-input');

          const currentTaxUnitPrice = parseFloat(taxInput.value) || 0;
          const currentOperatingFee = parseFloat(operatingInput.value) || 0;

          const originalTaxUnitPrice = parseFloat(taxInput.dataset.originalValue) || 0;
          const originalOperatingFee = parseFloat(operatingInput.dataset.originalValue) || 0;

          // Check if values have changed
          if (currentTaxUnitPrice !== originalTaxUnitPrice || currentOperatingFee !== originalOperatingFee) {
            // 从当前DOM行中获取total_overall，因为它是最新计算的
            const currentTotalOverall = parseFloat(row.querySelector('.total-overall').textContent) || 0;
            rowsToUpdate.push({
              id: itemId,
              merchant_name: merchantName,
              tax_unit_price: currentTaxUnitPrice,
              operating_fee: currentOperatingFee,
              total_overall: currentTotalOverall
            });
          }
        }
      });

      if (rowsToUpdate.length === 0) {
        Swal.fire({
          icon: 'info',
          title: '没有需要保存的更改',
          timer: 1500,
          showConfirmButton: false
        });
        return;
      }

      let successCount = 0;
      let errorCount = 0;

      for (const rowData of rowsToUpdate) {
        try {
          const response = await fetch('/api/shipping_costs/update', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(rowData)
          });

          if (response.ok) {
            successCount++;
            // Update original values in the DOM after successful save
            document.querySelectorAll(`[data-item-id="${rowData.id}"][data-merchant-name="${rowData.merchant_name}"]`).forEach(row => {
              const taxInput = row.querySelector('.tax-unit-price-input');
              const operatingInput = row.querySelector('.operating-fee-input');
              if (taxInput) taxInput.dataset.originalValue = rowData.tax_unit_price;
              if (operatingInput) operatingInput.dataset.originalValue = rowData.operating_fee;
            });
          } else {
            errorCount++;
            const errorResult = await response.json();
            console.error('保存失败:', rowData.id, rowData.merchant_name, errorResult.message);
          }
        } catch (error) {
          errorCount++;
          console.error('保存请求失败:', rowData.id, rowData.merchant_name, error);
        }
      }

      if (successCount > 0 && errorCount === 0) {
        Swal.fire({
          icon: 'success',
          title: '所有更改已成功保存！',
          text: `成功保存 ${successCount} 条记录。`,
          timer: 2000,
          showConfirmButton: false
        });
      } else if (successCount > 0 && errorCount > 0) {
        Swal.fire({
          icon: 'warning',
          title: '部分保存成功！',
          text: `成功保存 ${successCount} 条记录，${errorCount} 条记录保存失败。请检查控制台了解详情。`,
          timer: 3000
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: '保存失败！',
          text: `所有记录保存失败。请检查控制台了解详情。`,
          timer: 3000
        });
      }
    });

    // Export to Excel Button Event Listener
    exportExcelBtn.addEventListener('click', () => {
      const table = document.querySelector('table'); // Get the table element

      // Create a new workbook and a new worksheet
      const wb = XLSX.utils.book_new();
      const ws_data = [];

      // Get table headers
      const headers = [];
      table.querySelectorAll('thead th').forEach(th => {
        // Exclude the resizer div and sort icons from the header text
        let headerText = th.textContent.trim();
        // Remove specific text if present, e.g., "日期" from "日期 排序图标"
        headerText = headerText.replace('日期', '').replace(' ', ''); // Remove '日期' if it's separate
        if (headerText === '') { // For the date column where only icons might be present
            headerText = '日期';
        }
        if (th.querySelector('.tax-unit-price-input')) { // This is an approximate way to find the header for editable fields
          headerText = '报税价';
        } else if (th.querySelector('.operating-fee-input')) {
          headerText = '操作费';
        }
        // Fallback for cases where textContent might be empty but there's an input
        if (headerText === '' && th.children.length > 0) {
            // Heuristic: check for specific input types within the header to identify it
            if (th.querySelector('input[type="number"][class*="tax-unit-price-input"]')) {
                headerText = '报税价';
            } else if (th.querySelector('input[type="number"][class*="operating-fee-input"]')) {
                headerText = '操作费';
            }
        }
        // Clean up any remaining whitespace or unwanted characters
        headerText = headerText.replace(/\n/g, '').trim();
        // Remove sort icons text
        headerText = headerText.replace(/按日期升序排序|按日期降序排序/g, '');

        headers.push(headerText);
      });
      // Remove empty headers or headers that might be '保存当前行' for the context menu
      const filteredHeaders = headers.filter(header => header !== '' && header !== '保存当前行' && header !== '返回功能列表');
      ws_data.push(filteredHeaders);

      // Get table data rows
      table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach((cell, cellIndex) => {
          // For editable input fields, get their value
          const inputElement = cell.querySelector('input[type="number"]');
          if (inputElement) {
            rowData.push(parseFloat(inputElement.value) || 0); // Get value from input
          } else {
            // For '日期' column, format it to YYYY-MM-DD
            if (cellIndex === 1) { // Assuming Date is the second column (index 1)
              const dateValue = cell.textContent.trim();
              try {
                const dateObj = new Date(dateValue);
                if (!isNaN(dateObj.getTime())) {
                  rowData.push(dateObj.toISOString().split('T')[0]); // Format to YYYY-MM-DD
                } else {
                  rowData.push(dateValue); // Keep original if invalid date
                }
              } catch (e) {
                rowData.push(dateValue); // Keep original on error
              }
            }
            // For '运单号' column, ensure it's treated as text
            else if (cellIndex === 2) { // Assuming Tracking Number is the third column (index 2)
                rowData.push(cell.textContent.trim()); // Remove the prefix with \' to force text in Excel
            }
            // For '表单编号' column, ensure it's treated as text
            else if (cellIndex === 3) { // Form Number is the fourth column (index 3)
                rowData.push(cell.textContent.trim()); // Treat as text in Excel
            }
            else {
              rowData.push(cell.textContent.trim());
            }
          }
        });
        ws_data.push(rowData);
      });

      // Get footer data (totals)
      const footerRow = table.querySelector('tfoot tr');
      if (footerRow) {
          const footerData = new Array(filteredHeaders.length).fill(''); // Initialize with empty strings for all columns

          // "合计:" text goes into the first column, which corresponds to the colspan 4
          footerData[0] = footerRow.querySelector('td:nth-child(1)').textContent.trim();

          // Find and assign values to their correct column indices
          footerData[5] = footerRow.querySelector('.total-settle-weight-sum').textContent.trim(); // 结算重量 - Col 6 (index 5)
          footerData[8] = footerRow.querySelector('.subtotal-freight-sum').textContent.trim(); // 小计运费 - Col 9 (index 8)
          footerData[9] = footerRow.querySelector('.pieces-sum').textContent.trim(); // 件数 - Col 10 (index 9)
          footerData[11] = footerRow.querySelector('.subtotal-operating-fee-sum').textContent.trim(); // 小计操作费 - Col 12 (index 11)
          footerData[12] = footerRow.querySelector('.total-overall-sum').textContent.trim(); // 合计 - Col 13 (index 12)

          ws_data.push(footerData);
      }

      // Convert array of arrays to worksheet
      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      // Add the worksheet to the workbook
      XLSX.utils.book_append_sheet(wb, ws, "统计数据");

      // Write the workbook and trigger download
      XLSX.writeFile(wb, "统计数据概览.xlsx");
    });

    // 结算单据侧边栏相关的 DOM 元素
    const settlementBillDrawer = document.getElementById('settlementBillDrawer');
    const closeBillDrawerBtn = document.getElementById('closeBillDrawerBtn');
    const billDrawerOverlay = document.getElementById('billDrawerOverlay');
    const billContent = document.getElementById('billContent');
    const printBillBtn = document.getElementById('printBillBtn');

    // 显示结算单据侧边栏的函数
    const showSettlementBillDrawer = (data) => {
      // 填充单据数据
      document.getElementById('billDate').textContent = data.date || '';
      document.getElementById('billTrackingNumber').textContent = data.tracking_number || '';
      document.getElementById('billSettleWeight').textContent = ((parseFloat(data.merchant_weight) || 0) / (parseFloat(data.actual_weight_with_box) || 1.0) * (parseFloat(data.total_settle_weight) || 0)).toFixed(3);
      document.getElementById('billTaxUnitPrice').textContent = (parseFloat(data.merchant_tax_unit_price) || 0).toFixed(2);
      document.getElementById('billSubtotalFreight').textContent = (parseFloat(data.subtotal_freight) || 0).toFixed(2);
      document.getElementById('billPieces').textContent = (parseInt(data.merchant_pieces) || 0);
      document.getElementById('billOperatingFee').textContent = (parseFloat(data.merchant_operating_fee) || 0).toFixed(2);
      document.getElementById('billSubtotalOperatingFee').textContent = (parseFloat(data.subtotal_operating_fee) || 0).toFixed(2);
      document.getElementById('billTotalOverall').textContent = (parseFloat(data.total_overall) || 0).toFixed(2);
      // 备注字段改为输入框，无需从 data 中获取，每次打开清空或默认N/A
      document.getElementById('billNotes').value = ''; // 每次打开清空

      document.getElementById('billGenerationDate').textContent = new Date().toLocaleString();

      settlementBillDrawer.classList.remove('translate-x-full', 'hidden');
      settlementBillDrawer.classList.add('translate-x-0');
      billDrawerOverlay.classList.remove('hidden');
    };

    // 隐藏结算单据侧边栏的函数
    const hideSettlementBillDrawer = () => {
      settlementBillDrawer.classList.remove('translate-x-0');
      settlementBillDrawer.classList.add('translate-x-full');
      billDrawerOverlay.classList.add('hidden');
    };

    // 绑定侧边栏关闭事件
    closeBillDrawerBtn.addEventListener('click', hideSettlementBillDrawer);
    billDrawerOverlay.addEventListener('click', hideSettlementBillDrawer);

    // 打印单据功能
    printBillBtn.addEventListener('click', () => {
      const printContent = billContent.cloneNode(true); // 克隆要打印的内容
      const originalDisplay = printContent.style.display; // 保存原始display
      printContent.style.display = 'block'; // 确保内容可见
      printContent.querySelector('.mt-4.text-center.text-gray-600').remove(); // 移除生成日期

      // 获取备注 textarea 的当前值并设置到克隆内容的相应位置
      const notesTextarea = billContent.querySelector('#billNotes');
      if (notesTextarea) {
        const clonedNotesDisplay = printContent.querySelector('#billNotes');
        if (clonedNotesDisplay) {
          // 将 textarea 转换为一个普通的文本显示区域以便打印
          const pElement = document.createElement('p');
          pElement.textContent = notesTextarea.value;
          clonedNotesDisplay.parentNode.replaceChild(pElement, clonedNotesDisplay);
        }
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write('<html><head><title>结算单据</title>');
      // 引入 Tailwind CSS（如果需要，或者直接内联样式）
      printWindow.document.write('<link href="https://cdn.tailwindcss.com" rel="stylesheet">');
      printWindow.document.write('<style>');
      printWindow.document.write('body { font-family: sans-serif; margin: 20px; }');
      printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
      printWindow.document.write('td { padding: 8px; border: 1px solid #ddd; }');
      printWindow.document.write('.text-center { text-align: center; }');
      printWindow.document.write('.font-bold { font-weight: bold; }');
      printWindow.document.write('.text-lg { font-size: 1.125rem; }');
      printWindow.document.write('h3 { margin-bottom: 1rem; }');
      printWindow.document.write('</style>');
      printWindow.document.write('</head><body>');
      printWindow.document.write(printContent.innerHTML); // 写入克隆的内容
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    });
  </script>
</body>
</html> 