<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>统计功能</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .filter-section {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 text-sm">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">统计功能</h1>
      <!-- 返回功能列表按钮，假设存在一个 pt_function_interface 路由 -->
      <a href="{{ url_for('pt_function_interface') }}" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg transform hover:translate-y-[-2px] hover:shadow-xl">
        <i class="fa fa-arrow-left mr-2"></i> 返回功能列表
      </a>
    </div>

    <!-- 筛选功能区域 -->
    <div class="bg-white rounded-xl p-6 mb-6 filter-section">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 items-end">
        <div class="flex flex-col">
          <label for="startDateFilter" class="text-gray-600 font-medium mb-1 text-sm">开始时间:</label>
          <input type="date" id="startDateFilter" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm">
        </div>
        <div class="flex flex-col">
          <label for="endDateFilter" class="text-gray-600 font-medium mb-1 text-sm">结束时间:</label>
          <input type="date" id="endDateFilter" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm">
        </div>
        <div class="flex flex-col">
          <label for="trackingNumberFilter" class="text-gray-600 font-medium mb-1 text-sm">运单号:</label>
          <input type="text" id="trackingNumberFilter" placeholder="请输入运单号 (多个请用逗号分隔)" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm">
        </div>
        <div class="flex flex-col">
          <label for="merchantFilter" class="text-gray-600 font-medium mb-1 text-sm">商家:</label>
          <input type="text" id="merchantFilter" placeholder="请输入商家名称" class="px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600/50 focus:border-red-600 focus:outline-none w-full text-sm" list="merchantsList">
          <datalist id="merchantsList"></datalist>
        </div>
        <div class="flex justify-end lg:justify-start items-end">
          <button id="queryBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg justify-center text-sm">
            <i class="fa fa-search mr-2"></i> 查询
          </button>
        </div>
      </div>
    </div>

    <!-- 统计数据展示区域 -->
    <div class="bg-white rounded-xl overflow-hidden filter-section p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">统计数据概览</h2>
        <div class="flex items-center space-x-2">
          <button id="saveAllBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg justify-center text-sm">
            <i class="fa fa-save mr-2"></i> 保存查询结果
          </button>
          <button id="exportExcelBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg justify-center text-sm">
            <i class="fa fa-file-excel-o mr-2"></i> 导出Excel
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
          <thead>
            <tr class="bg-gray-50 text-left">
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">序号</th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group flex items-center justify-center">
                <div class="flex items-center">
                  日期
                  <div class="flex flex-col ml-1">
                    <i id="sortDateAsc" class="fa fa-sort-asc cursor-pointer text-gray-400 hover:text-gray-600" title="按日期升序排序"></i>
                    <i id="sortDateDesc" class="fa fa-sort-desc cursor-pointer text-gray-400 hover:text-gray-600" title="按日期降序排序"></i>
                  </div>
                </div>
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                运单号
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                商家
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                结算重量
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                货代价
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                报税价
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                小计运费
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                件数
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                操作费
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider relative group">
                小计操作费
                <div class="resizer absolute top-0 right-0 w-2 h-full cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
              </th>
              <th class="px-4 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">合计</th>
            </tr>
          </thead>
          <tbody id="statisticalSummaryBody" class="bg-white divide-y divide-gray-200">
            <!-- Data rows will be inserted here -->
          </tbody>
          <tfoot class="bg-gray-50">
            <tr class="font-bold text-gray-700">
              <td colspan="4" class="px-4 py-2 text-right">合计:</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 total-settle-weight-sum">0.000</td>
              <td class="px-4 py-2"></td> <!-- 货代价 -->
              <td class="px-4 py-2"></td> <!-- 报税价 -->
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-freight-sum">0.00</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 pieces-sum">0</td>
              <td class="px-4 py-2"></td> <!-- 操作费 -->
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-operating-fee-sum">0.00</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 total-overall-sum">0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div id="statisticsDisplay" class="text-gray-700 mt-4">
        <!-- Old placeholder text. Will be replaced by updating cells directly. -->
      </div>
    </div>
  </div>

  <!-- 自定义右键菜单 -->
  <div id="customContextMenu" class="fixed bg-white border border-gray-300 rounded-md shadow-lg z-50 py-1 hidden">
    <a href="#" id="saveRowOption" class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-500 hover:text-white">保存当前行</a>
  </div>

  <script>
    // Supabase 初始化 (假设与现有项目配置一致)
    const SUPABASE_URL = 'https://xehoqrboglykebqvovgj.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlaG9xcmJvZ2x5a2VicXZvdmdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NTk2OTMsImV4cCI6MjA2NTIzNTY5M30.v8iMnNK_b3hGuum4qvreBzf19NiEJ11Dz4Q_Oy_7ySg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let finalData = []; // 将 finalData 声明为全局变量
    console.log("Script loaded. Initial finalData:", finalData); // Debugging: Check initial finalData

    document.addEventListener('DOMContentLoaded', function() {
      const startDateFilter = document.getElementById('startDateFilter');
      const endDateFilter = document.getElementById('endDateFilter');
      const trackingNumberFilter = document.getElementById('trackingNumberFilter');
      const merchantFilter = document.getElementById('merchantFilter');
      const queryBtn = document.getElementById('queryBtn');
      const saveAllBtn = document.getElementById('saveAllBtn'); // New: Get saveAllBtn
      const exportExcelBtn = document.getElementById('exportExcelBtn'); // New: Get exportExcelBtn
      const merchantsList = document.getElementById('merchantsList');
      const statisticalSummaryBody = document.getElementById('statisticalSummaryBody'); // 获取 tbody 元素

      // --- 合计计算和显示函数 START
      const updateTotalsDisplay = () => {
        let totalSettleWeightSum = 0;
        let subtotalFreightSum = 0;
        let piecesSum = 0;
        let subtotalOperatingFeeSum = 0;
        let totalOverallSum = 0;

        const rows = document.querySelectorAll('#statisticalSummaryBody tr');
        rows.forEach(row => {
          totalSettleWeightSum += parseFloat(row.querySelector('td:nth-child(5)').textContent) || 0; // 结算重量 (现在是第5列)
          subtotalFreightSum += parseFloat(row.querySelector('.subtotal-freight').textContent) || 0; // 小计运费
          piecesSum += parseInt(row.querySelector('td:nth-child(9)').textContent) || 0; // 件数 (现在是第9列)
          subtotalOperatingFeeSum += parseFloat(row.querySelector('.subtotal-operating-fee').textContent) || 0; // 小计操作费
          totalOverallSum += parseFloat(row.querySelector('.total-overall').textContent) || 0; // 合计
        });

        document.querySelector('.total-settle-weight-sum').textContent = totalSettleWeightSum.toFixed(3);
        document.querySelector('.subtotal-freight-sum').textContent = subtotalFreightSum.toFixed(2);
        document.querySelector('.pieces-sum').textContent = piecesSum;
        document.querySelector('.subtotal-operating-fee-sum').textContent = subtotalOperatingFeeSum.toFixed(2);
        document.querySelector('.total-overall-sum').textContent = totalOverallSum.toFixed(2);
      };
      // --- 合计计算和显示函数 END

      // 渲染表格的函数，将数据绑定到HTML
      const renderTable = (dataToRender) => {
        statisticalSummaryBody.innerHTML = ''; // 清空之前的内容

        if (dataToRender && dataToRender.length > 0) {
          dataToRender.forEach((item, index) => {
            const date = item.date || '';
            const trackingNumber = item.tracking_number || '';
            const totalSettleWeight = (parseFloat(item.total_settle_weight) || 0).toFixed(3);
            const freightUnitPrice = (parseFloat(item.freight_unit_price) || 0).toFixed(2);
            const merchantName = item.merchant_name || '';
            const pieces = (parseInt(item.merchant_pieces) || 0);
            // 计算每个商户的结算重量： (商户的货物实重 / 整个运单的实重+纸箱) * 整个运单的总结算重量
            const merchantSettleWeightDisplay = ((parseFloat(item.merchant_weight) || 0) / (parseFloat(item.actual_weight_with_box) || 1.0) * (parseFloat(item.total_settle_weight) || 0)).toFixed(3);
            const taxUnitPrice = (parseFloat(item.merchant_tax_unit_price) || 0).toFixed(2);
            const operatingFee = (parseFloat(item.merchant_operating_fee) || 0).toFixed(2);
            const subtotalFreight = (parseFloat(item.subtotal_freight) || 0).toFixed(2);
            const subtotalOperatingFee = (parseFloat(item.subtotal_operating_fee) || 0).toFixed(2);
            const totalOverall = (parseFloat(item.total_overall) || 0).toFixed(2);

            const row = document.createElement('tr');
            row.classList.add('bg-white', 'divide-y', 'divide-gray-200');
            row.dataset.itemId = item.id; // shipping_costs 的 ID
            row.dataset.merchantName = merchantName; // 商家名称

            row.innerHTML = `
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${date}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${trackingNumber}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${merchantName}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${merchantSettleWeightDisplay}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${freightUnitPrice}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <input type="number" class="tax-unit-price-input px-1 py-0.5 border border-gray-300 rounded-md w-24 text-sm text-right focus:ring-blue-300 focus:border-blue-300" value="${taxUnitPrice}" step="0.01" data-original-value="${taxUnitPrice}">
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-freight">${subtotalFreight}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${pieces}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <input type="number" class="operating-fee-input px-1 py-0.5 border border-gray-300 rounded-md w-24 text-sm text-right focus:ring-blue-300 focus:border-blue-300" value="${operatingFee}" step="0.01" data-original-value="${operatingFee}">
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 subtotal-operating-fee">${subtotalOperatingFee}</td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 total-overall">${totalOverall}</td>
            `;
            statisticalSummaryBody.appendChild(row);

            // 为新创建的 input 添加事件监听
            const newTaxInput = row.querySelector('.tax-unit-price-input');
            const newOperatingInput = row.querySelector('.operating-fee-input');

            const updateCalculations = () => {
              const currentTaxUnitPrice = parseFloat(newTaxInput.value) || 0;
              const currentOperatingFee = parseFloat(newOperatingInput.value) || 0;

              const currentMerchantSettleWeight = parseFloat(row.querySelector('td:nth-child(5)').textContent) || 0; // 现在是第5列
              const currentPieces = parseFloat(row.querySelector('td:nth-child(9)').textContent) || 0; // 现在是第9列

              const newSubtotalFreight = (currentMerchantSettleWeight * currentTaxUnitPrice).toFixed(2);
              const newSubtotalOperatingFee = (currentPieces * currentOperatingFee).toFixed(2);
              const newTotalOverall = (parseFloat(newSubtotalFreight) + parseFloat(newSubtotalOperatingFee)).toFixed(2);

              row.querySelector('.subtotal-freight').textContent = newSubtotalFreight;
              row.querySelector('.subtotal-operating-fee').textContent = newSubtotalOperatingFee;
              row.querySelector('.total-overall').textContent = newTotalOverall;

              // 更新合计行
              updateTotalsDisplay();
            };

            newTaxInput.addEventListener('input', updateCalculations);
            newOperatingInput.addEventListener('input', updateCalculations);
          });
        } else {
          statisticalSummaryBody.innerHTML = `<tr><td colspan="12" class="px-4 py-2 text-center text-gray-500">没有找到匹配的数据。</td></tr>`;
        }
        updateTotalsDisplay(); // Ensure totals are updated after initial render
      };

      // --- 排序功能 START
      const sortDateAsc = document.getElementById('sortDateAsc');
      const sortDateDesc = document.getElementById('sortDateDesc');

      const sortDataByDate = (order) => {
        if (!finalData || finalData.length === 0) return;

        finalData.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          if (order === 'asc') {
            return dateA.getTime() - dateB.getTime();
          } else {
            return dateB.getTime() - dateA.getTime();
          }
        });
        renderTable(finalData); // 重新渲染表格
      };

      sortDateAsc.addEventListener('click', () => sortDataByDate('asc'));
      sortDateDesc.addEventListener('click', () => sortDataByDate('desc'));
      // --- 排序功能 END

      // 加载所有唯一的商家名称到 datalist
      async function loadMerchantsIntoDatalist() {
        try {
          // 修改：从 'merchants' 表中选择 'merchant_name' 字段
          const { data, error } = await supabase.from('merchants').select('merchant_name').order('merchant_name', { ascending: true });

          if (error) {
            console.error('加载商家数据失败:', error.message);
            return;
          }

          merchantsList.innerHTML = ''; // 清空现有选项
          if (data) {
            data.forEach(item => {
              if (item.merchant_name) {
                const option = document.createElement('option');
                option.value = item.merchant_name;
                merchantsList.appendChild(option);
              }
            });
          }

        } catch (e) {
          console.error('加载商家数据时发生异常:', e.message);
        }
      }

      // 初始加载商家列表
      loadMerchantsIntoDatalist();

      // Table column resizing logic
      const resizers = document.querySelectorAll('.resizer');
      let currentColumn;
      let initialX;
      let initialWidth;

      resizers.forEach(resizer => {
        resizer.addEventListener('mousedown', (e) => {
          currentColumn = e.target.closest('th');
          initialX = e.clientX;
          initialWidth = currentColumn.offsetWidth;

          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
          document.body.style.cursor = 'col-resize'; // Change cursor while dragging
        });
      });

      const mouseMoveHandler = (e) => {
        const diffX = e.clientX - initialX;
        const newWidth = initialWidth + diffX;
        if (newWidth > 50) { // Minimum width to prevent columns from becoming too small
          currentColumn.style.width = `${newWidth}px`;
          currentColumn.style.minWidth = `${newWidth}px`;
        }
      };

      const mouseUpHandler = () => {
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
        document.body.style.cursor = ''; // Reset cursor
      };

      queryBtn.addEventListener('click', async () => {
        const startDate = startDateFilter.value;
        const endDate = endDateFilter.value;
        let trackingNumber = trackingNumberFilter.value;
        const merchant = merchantFilter.value;

        // 兼容多种分隔符：将空格和换行符替换为逗号，并清理多余的逗号
        if (trackingNumber) {
          trackingNumber = trackingNumber.replace(/\s+/g, ',') // 将一个或多个空格替换为逗号
                                         .replace(/[\n\r]/g, ','); // 将换行符替换为逗号
          // 移除开头和结尾的逗号，以及多个连续的逗号
          trackingNumber = trackingNumber.split(',').filter(num => num.trim() !== '').join(',');
        }

        // 调用新的 rpc 函数进行统一筛选
        let { data, error: finalError } = await supabase.rpc('get_shipping_costs_filtered', {
          merchant_name_param: merchant || null,
          start_date_param: startDate || null,
          end_date_param: endDate || null,
          tracking_numbers_param: trackingNumber || null
        });

        finalData = data; // Assign to the global finalData

        console.log('Supabase Query Data:', finalData); // 打印查询到的数据
        console.log('Supabase Query Error:', finalError);

        if (finalError) {
          console.error('查询统计数据失败:', finalError.message);
          statisticalSummaryBody.innerHTML = `<tr><td colspan="12" class="px-4 py-2 text-center text-red-500">加载失败: ${finalError.message}</td></tr>`;
          document.querySelector('.total-settle-weight-sum').textContent = '0.000';
          document.querySelector('.subtotal-freight-sum').textContent = '0.00';
          document.querySelector('.pieces-sum').textContent = '0';
          document.querySelector('.subtotal-operating-fee-sum').textContent = '0.00';
          document.querySelector('.total-overall-sum').textContent = '0.00';
          return;
        }

        renderTable(finalData); // 调用渲染函数
      });

      // 初始查询和渲染
      queryBtn.click(); // 在页面加载时自动执行一次查询
    });

    // --- 右键菜单和保存功能 --- START
    const customContextMenu = document.getElementById('customContextMenu');
    const saveRowOption = document.getElementById('saveRowOption');
    let currentRowData = null; // 用于存储当前右键点击行的数据

    // 隐藏右键菜单的函数
    const hideContextMenu = () => {
      customContextMenu.classList.add('hidden');
    };

    // 在文档任意地方点击时隐藏菜单
    document.addEventListener('click', hideContextMenu);

    // 阻止右键菜单在自身上触发
    customContextMenu.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // 监听表格 tbody 的右键点击事件
    const statisticalSummaryBody = document.getElementById('statisticalSummaryBody'); // Get it here
    statisticalSummaryBody.addEventListener('contextmenu', (e) => {
      console.log('Right-click event detected on statisticalSummaryBody.', e.target); // Debugging line
      console.log('finalData at contextmenu:', finalData); // Added debug log
      const clickedRow = e.target.closest('tr');
      if (clickedRow) {
        console.log('Clicked row found:', clickedRow); // Debugging line
        e.preventDefault(); // 阻止默认右键菜单

        // 收集当前行的数据
        const itemId = clickedRow.dataset.itemId; // shipping_costs 的 ID
        const merchantName = clickedRow.dataset.merchantName; // 商家名称
        const taxInput = clickedRow.querySelector('.tax-unit-price-input');
        const operatingInput = clickedRow.querySelector('.operating-fee-input');
        const taxUnitPrice = parseFloat(taxInput.value) || 0;
        const operatingFee = parseFloat(operatingInput.value) || 0;

        // 获取当前行的计算值
        const currentSubtotalFreight = parseFloat(clickedRow.querySelector('.subtotal-freight').textContent) || 0;
        const currentSubtotalOperatingFee = parseFloat(clickedRow.querySelector('.subtotal-operating-fee').textContent) || 0;
        const currentTotalOverall = parseFloat(clickedRow.querySelector('.total-overall').textContent) || 0;

        currentRowData = {
          id: itemId,
          merchant_name: merchantName,
          tax_unit_price: taxUnitPrice,
          operating_fee: operatingFee,
          total_overall: currentTotalOverall // 保存时转为数字
        };

        // 显示自定义菜单
        customContextMenu.style.left = `${e.clientX}px`;
        customContextMenu.style.top = `${e.clientY}px`;
        customContextMenu.classList.remove('hidden');
        console.log('Context menu position set to:', customContextMenu.style.left, customContextMenu.style.top); // New debug log

        e.stopPropagation(); // 阻止事件冒泡到 document，以免立即隐藏菜单
      } else {
        console.log('No row found for right-click event. e.target:', e.target); // New debug log
        hideContextMenu(); // Hide the menu if no row is found, ensures default menu behavior is restored.
      }
    });

    // 保存选项点击事件
    saveRowOption.addEventListener('click', async () => {
      if (!currentRowData) return;

      try {
        const response = await fetch('/api/shipping_costs/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(currentRowData)
        });

        const result = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: '保存成功！',
            text: result.message,
            timer: 1500,
            showConfirmButton: false
          });
          // 可以选择重新加载数据或仅更新前端显示，这里简单起见，提示成功
        } else {
          Swal.fire({
            icon: 'error',
            title: '保存失败！',
            text: result.message || '未知错误',
            timer: 3000
          });
        }
      } catch (error) {
        console.error('保存请求失败:', error);
        Swal.fire({
          icon: 'error',
          title: '网络错误',
          text: '无法连接到服务器，请检查网络连接。',
          timer: 3000
        });
      }
      hideContextMenu();
      currentRowData = null; // 清空当前行数据
    });

    // Save All Button Event Listener
    saveAllBtn.addEventListener('click', async () => {
      const rowsToUpdate = [];
      const tableRows = document.querySelectorAll('#statisticalSummaryBody tr');

      tableRows.forEach(row => {
        const itemId = row.dataset.itemId;
        const merchantName = row.dataset.merchantName;
        if (itemId && merchantName) { // Only process rows that have an item ID and merchant name
          const taxInput = row.querySelector('.tax-unit-price-input');
          const operatingInput = row.querySelector('.operating-fee-input');

          const currentTaxUnitPrice = parseFloat(taxInput.value) || 0;
          const currentOperatingFee = parseFloat(operatingInput.value) || 0;

          const originalTaxUnitPrice = parseFloat(taxInput.dataset.originalValue) || 0;
          const originalOperatingFee = parseFloat(operatingInput.dataset.originalValue) || 0;

          // Check if values have changed
          if (currentTaxUnitPrice !== originalTaxUnitPrice || currentOperatingFee !== originalOperatingFee) {
            // 从当前DOM行中获取total_overall，因为它是最新计算的
            const currentTotalOverall = parseFloat(row.querySelector('.total-overall').textContent) || 0;
            rowsToUpdate.push({
              id: itemId,
              merchant_name: merchantName,
              tax_unit_price: currentTaxUnitPrice,
              operating_fee: currentOperatingFee,
              total_overall: currentTotalOverall
            });
          }
        }
      });

      if (rowsToUpdate.length === 0) {
        Swal.fire({
          icon: 'info',
          title: '没有需要保存的更改',
          timer: 1500,
          showConfirmButton: false
        });
        return;
      }

      let successCount = 0;
      let errorCount = 0;

      for (const rowData of rowsToUpdate) {
        try {
          const response = await fetch('/api/shipping_costs/update', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(rowData)
          });

          if (response.ok) {
            successCount++;
            // Update original values in the DOM after successful save
            document.querySelectorAll(`[data-item-id="${rowData.id}"][data-merchant-name="${rowData.merchant_name}"]`).forEach(row => {
              const taxInput = row.querySelector('.tax-unit-price-input');
              const operatingInput = row.querySelector('.operating-fee-input');
              if (taxInput) taxInput.dataset.originalValue = rowData.tax_unit_price;
              if (operatingInput) operatingInput.dataset.originalValue = rowData.operating_fee;
            });
          } else {
            errorCount++;
            const errorResult = await response.json();
            console.error('保存失败:', rowData.id, rowData.merchant_name, errorResult.message);
          }
        } catch (error) {
          errorCount++;
          console.error('保存请求失败:', rowData.id, rowData.merchant_name, error);
        }
      }

      if (successCount > 0 && errorCount === 0) {
        Swal.fire({
          icon: 'success',
          title: '所有更改已成功保存！',
          text: `成功保存 ${successCount} 条记录。`,
          timer: 2000,
          showConfirmButton: false
        });
      } else if (successCount > 0 && errorCount > 0) {
        Swal.fire({
          icon: 'warning',
          title: '部分保存成功！',
          text: `成功保存 ${successCount} 条记录，${errorCount} 条记录保存失败。请检查控制台了解详情。`,
          timer: 3000
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: '保存失败！',
          text: `所有记录保存失败。请检查控制台了解详情。`,
          timer: 3000
        });
      }
    });

    // Export to Excel Button Event Listener
    exportExcelBtn.addEventListener('click', () => {
      const table = document.querySelector('table'); // Get the table element

      // Create a new workbook and a new worksheet
      const wb = XLSX.utils.book_new();
      const ws_data = [];

      // Get table headers
      const headers = [];
      table.querySelectorAll('thead th').forEach(th => {
        // Exclude the resizer div and sort icons from the header text
        let headerText = th.textContent.trim();
        // Remove specific text if present, e.g., "日期" from "日期 排序图标"
        headerText = headerText.replace('日期', '').replace(' ', ''); // Remove '日期' if it's separate
        if (headerText === '') { // For the date column where only icons might be present
            headerText = '日期';
        }
        if (th.querySelector('.tax-unit-price-input')) { // This is an approximate way to find the header for editable fields
          headerText = '报税价';
        } else if (th.querySelector('.operating-fee-input')) {
          headerText = '操作费';
        }
        // Fallback for cases where textContent might be empty but there's an input
        if (headerText === '' && th.children.length > 0) {
            // Heuristic: check for specific input types within the header to identify it
            if (th.querySelector('input[type="number"][class*="tax-unit-price-input"]')) {
                headerText = '报税价';
            } else if (th.querySelector('input[type="number"][class*="operating-fee-input"]')) {
                headerText = '操作费';
            }
        }
        // Clean up any remaining whitespace or unwanted characters
        headerText = headerText.replace(/\n/g, '').trim();
        // Remove sort icons text
        headerText = headerText.replace(/按日期升序排序|按日期降序排序/g, '');

        headers.push(headerText);
      });
      // Remove empty headers or headers that might be '保存当前行' for the context menu
      const filteredHeaders = headers.filter(header => header !== '' && header !== '保存当前行' && header !== '返回功能列表');
      ws_data.push(filteredHeaders);

      // Get table data rows
      table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach((cell, cellIndex) => {
          // For editable input fields, get their value
          const inputElement = cell.querySelector('input[type="number"]');
          if (inputElement) {
            rowData.push(parseFloat(inputElement.value) || 0); // Get value from input
          } else {
            // For '日期' column, format it to YYYY-MM-DD
            if (cellIndex === 1) { // Assuming Date is the second column (index 1)
              const dateValue = cell.textContent.trim();
              try {
                const dateObj = new Date(dateValue);
                if (!isNaN(dateObj.getTime())) {
                  rowData.push(dateObj.toISOString().split('T')[0]); // Format to YYYY-MM-DD
                } else {
                  rowData.push(dateValue); // Keep original if invalid date
                }
              } catch (e) {
                rowData.push(dateValue); // Keep original on error
              }
            }
            // For '运单号' column, ensure it's treated as text
            else if (cellIndex === 2) { // Assuming Tracking Number is the third column (index 2)
                rowData.push(cell.textContent.trim()); // Remove the prefix with \' to force text in Excel
            }
            else {
              rowData.push(cell.textContent.trim());
            }
          }
        });
        ws_data.push(rowData);
      });

      // Get footer data (totals)
      const footerRow = table.querySelector('tfoot tr');
      if (footerRow) {
          const footerData = new Array(filteredHeaders.length).fill(''); // Initialize with empty strings for all columns

          // "合计:" text goes into the first column, which corresponds to the colspan 4
          footerData[0] = footerRow.querySelector('td:nth-child(1)').textContent.trim();

          // Find and assign values to their correct column indices
          footerData[4] = footerRow.querySelector('.total-settle-weight-sum').textContent.trim(); // 结算重量 - Col 5 (index 4)
          footerData[7] = footerRow.querySelector('.subtotal-freight-sum').textContent.trim(); // 小计运费 - Col 8 (index 7)
          footerData[8] = footerRow.querySelector('.pieces-sum').textContent.trim(); // 件数 - Col 9 (index 8)
          footerData[10] = footerRow.querySelector('.subtotal-operating-fee-sum').textContent.trim(); // 小计操作费 - Col 11 (index 10)
          footerData[11] = footerRow.querySelector('.total-overall-sum').textContent.trim(); // 合计 - Col 12 (index 11)

          ws_data.push(footerData);
      }

      // Convert array of arrays to worksheet
      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      // Add the worksheet to the workbook
      XLSX.utils.book_append_sheet(wb, ws, "统计数据");

      // Write the workbook and trigger download
      XLSX.writeFile(wb, "统计数据概览.xlsx");
    });
  </script>
</body>
</html> 