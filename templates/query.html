<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†å²æ•°æ®æŸ¥è¯¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .card-shadow {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background-color: #6b7280;
    }
    .btn-secondary:hover {
      background-color: #4b5563;
      transform: translateY(-1px);
    }
    .btn-outline {
      border: 1px solid #d1d5db;
      background-color: white;
      color: #374151;
    }
    .btn-outline:hover {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }
    .btn-ghost {
      background-color: transparent;
      color: #6b7280;
    }
    .btn-ghost:hover {
      background-color: #f3f4f6;
      color: #374151;
    }
    .btn-danger {
      color: #dc2626;
    }
    .btn-danger:hover {
      color: #991b1b;
      background-color: #fef2f2;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-700 text-sm">

  <!-- å¼•å…¥ç”¨æˆ·çŠ¶æ€æ  -->
  {% include 'user_status_bar.html' %}

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-light text-gray-800 mb-2">å†å²æ•°æ®æŸ¥è¯¢</h1>
          <p class="text-gray-500">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„å†å²æ•°æ®è®°å½•</p>
        </div>
        <a href="{{ url_for('pt_function_interface') }}" class="btn-secondary text-white px-6 py-2 rounded-lg flex items-center transition-all duration-300 hover:shadow-lg">
            <i class="fa fa-arrow-left mr-2"></i> è¿”å›
        </a>
    </div>
    
    <!-- æŸ¥è¯¢æ¡ä»¶åŒºåŸŸ -->
    <div class="bg-gradient-to-br from-white to-blue-50/30 rounded-2xl shadow-xl border border-blue-100/50 mb-8 overflow-hidden">
      <!-- æ ‡é¢˜æ  -->
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-5">
        <h3 class="text-white font-bold text-xl flex items-center">
          <div class="bg-white/20 rounded-full p-2 mr-4">
            <i class="fa fa-search text-xl"></i>
          </div>
          æ•°æ®æŸ¥è¯¢ä¸ç®¡ç†ä¸­å¿ƒ
        </h3>
        <p class="text-blue-100 text-sm mt-2 ml-14">æ™ºèƒ½æŸ¥è¯¢å†å²æ•°æ®ï¼Œé«˜æ•ˆç®¡ç†ä¸šåŠ¡è®°å½•</p>
      </div>
      
      <!-- æŸ¥è¯¢è¡¨å•åŒºåŸŸ -->
      <div class="p-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div class="space-y-3">
            <label for="queryDateInput" class="text-gray-700 font-semibold text-base flex items-center">
              <div class="bg-blue-100 rounded-full p-2 mr-3">
                <i class="fa fa-calendar text-blue-600"></i>
              </div>
              é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ
            </label>
            <input type="date" id="queryDateInput" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-base bg-white shadow-sm hover:shadow-md hover:border-blue-300">
          </div>
          
          <div class="space-y-3">
            <label for="queryTrackingNumberInput" class="text-gray-700 font-semibold text-base flex items-center">
              <div class="bg-orange-100 rounded-full p-2 mr-3">
                <i class="fa fa-truck text-orange-600"></i>
              </div>
              å¿«é€’å•å·æŸ¥è¯¢
            </label>
            <textarea id="queryTrackingNumberInput" placeholder="è¯·è¾“å…¥å¿«é€’å•å·ï¼Œæ”¯æŒæ‰¹é‡æŸ¥è¯¢..." rows="3" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-base bg-white shadow-sm hover:shadow-md hover:border-blue-300 resize-none"></textarea>
            <div class="flex items-center text-sm text-blue-600 bg-blue-50 border border-blue-200 px-4 py-3 rounded-lg">
              <i class="fa fa-info-circle mr-2"></i>
              <span class="font-medium">æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼š</span>
              <span class="ml-2 text-gray-600">ç©ºæ ¼ã€æ¢è¡Œã€é€—å·å‡å¯</span>
            </div>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-2xl p-6 border border-gray-100">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <button id="searchBtn" class="group relative bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-5 rounded-xl flex items-center justify-center transition-all duration-300 hover:shadow-2xl hover:shadow-blue-500/30 hover:-translate-y-1 font-bold text-lg overflow-hidden">
              <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
              <div class="bg-white/20 rounded-full p-3 mr-4 group-hover:bg-white/30 transition-all relative z-10">
                <i class="fa fa-search text-xl"></i>
              </div>
              <span class="relative z-10">æŸ¥è¯¢æ•°æ®</span>
            </button>
            
            <button id="saveBatchBtn" class="group relative bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-8 py-5 rounded-xl flex items-center justify-center transition-all duration-300 hover:shadow-2xl hover:shadow-orange-500/30 hover:-translate-y-1 font-bold text-lg overflow-hidden">
              <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
              <div class="bg-white/20 rounded-full p-3 mr-4 group-hover:bg-white/30 transition-all relative z-10">
                <i class="fa fa-save text-xl"></i>
              </div>
              <span class="relative z-10">ä¿å­˜ä¿®æ”¹</span>
            </button>
            
            <button id="downloadExcelBtn" class="group relative bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-5 rounded-xl flex items-center justify-center transition-all duration-300 hover:shadow-2xl hover:shadow-green-500/30 hover:-translate-y-1 font-bold text-lg overflow-hidden">
              <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
              <div class="bg-white/20 rounded-full p-3 mr-4 group-hover:bg-white/30 transition-all relative z-10">
                <i class="fa fa-download text-xl"></i>
              </div>
              <span class="relative z-10">å¯¼å‡ºExcel</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="bg-white rounded-2xl overflow-hidden shadow-xl border border-gray-100/50">
      <!-- è¡¨æ ¼æ ‡é¢˜æ  -->
      <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
        <h4 class="text-lg font-bold text-gray-800 flex items-center">
          <div class="bg-blue-500 rounded-full p-2 mr-3">
            <i class="fa fa-table text-white"></i>
          </div>
          æ•°æ®åˆ—è¡¨
          <span class="ml-auto text-sm font-normal text-gray-500 bg-white px-3 py-1 rounded-full border">
            <i class="fa fa-database mr-1"></i>
            å®æ—¶æ•°æ®
          </span>
        </h4>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 text-left border-b-2 border-blue-200">
              <th class="px-4 py-4 font-bold text-gray-700 w-12 text-center">
                <input type="checkbox" id="selectAllCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded-md focus:ring-2 focus:ring-blue-500 border-2 border-gray-300">
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-sm">
                <div class="flex items-center">
                  <i class="fa fa-calendar mr-2 text-blue-500"></i>
                  æ—¥æœŸ
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-sm">
                <div class="flex items-center">
                  <i class="fa fa-truck mr-2 text-orange-500"></i>
                  å¿«é€’å•å·
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-sm">
                <div class="flex items-center">
                  <i class="fa fa-file-text mr-2 text-green-500"></i>
                  è¡¨å•ç¼–å·
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-center text-sm">
                <div class="flex items-center justify-center">
                  <i class="fa fa-boxes mr-2 text-purple-500"></i>
                  æ€»ä»¶æ•°
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-center text-sm">
                <div class="flex items-center justify-center">
                  <i class="fa fa-store mr-2 text-pink-500"></i>
                  å•†æˆ·è¯¦æƒ…
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-center text-sm">
                <div class="flex items-center justify-center">
                  <i class="fa fa-shipping-fast mr-2 text-blue-500"></i>
                  ç‰©æµçŠ¶æ€
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-center text-sm">
                <div class="flex items-center justify-center">
                  <i class="fa fa-check-circle mr-2 text-green-500"></i>
                  å®æ”¶ä»¶æ•°
                </div>
              </th>
              <th class="px-6 py-4 font-bold text-gray-700 text-center text-sm">
                <div class="flex items-center justify-center">
                  <i class="fa fa-cogs mr-2 text-gray-500"></i>
                  æ“ä½œ
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- Data will be injected here by script -->
          </tbody>
        </table>
      </div>
      
      <!-- åˆ†é¡µæ§ä»¶ -->
      <div class="bg-gradient-to-r from-gray-50 to-blue-50 border-t border-gray-200 px-8 py-6">
        <div class="flex justify-between items-center">
          <div class="flex items-center text-gray-600">
            <div class="bg-blue-100 rounded-full p-2 mr-3">
              <i class="fa fa-info-circle text-blue-600"></i>
            </div>
            <span class="font-medium">
              å…± <span id="totalCount" class="font-bold text-blue-600">0</span> æ¡è®°å½•ï¼Œ
              <span class="text-sm">æ¯é¡µæ˜¾ç¤º 20 æ¡</span>
            </span>
          </div>
          
          <div class="flex items-center space-x-3">
            <button id="prevPageBtn" class="group flex items-center px-4 py-2 bg-white border-2 border-gray-200 rounded-xl text-gray-600 hover:border-blue-300 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:border-gray-200 disabled:hover:text-gray-600 disabled:hover:bg-white">
              <i class="fa fa-chevron-left mr-2 group-hover:animate-pulse"></i>
              <span class="font-medium">ä¸Šä¸€é¡µ</span>
            </button>
            
            <div class="bg-white border-2 border-blue-200 rounded-xl px-6 py-2 shadow-sm">
              <span id="pageInfo" class="font-bold text-blue-600">ç¬¬ 1 é¡µ</span>
            </div>
            
            <button id="nextPageBtn" class="group flex items-center px-4 py-2 bg-white border-2 border-gray-200 rounded-xl text-gray-600 hover:border-blue-300 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:border-gray-200 disabled:hover:text-gray-600 disabled:hover:bg-white">
              <span class="font-medium">ä¸‹ä¸€é¡µ</span>
              <i class="fa fa-chevron-right ml-2 group-hover:animate-pulse"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const tbody = document.getElementById('historyTableBody');
      const queryDateInput = document.getElementById('queryDateInput');
      const queryTrackingNumberInput = document.getElementById('queryTrackingNumberInput');
      const searchBtn = document.getElementById('searchBtn');
      
      // åˆ†é¡µç›¸å…³å˜é‡
      let currentData = []; // å½“å‰æŸ¥è¯¢çš„æ‰€æœ‰æ•°æ®
      let currentPage = 1;
      const pageSize = 20;
      let totalPages = 1;
      
      // åˆ†é¡µæ§åˆ¶å…ƒç´ 
      const totalCountSpan = document.getElementById('totalCount');
      const pageInfoSpan = document.getElementById('pageInfo');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      
      /**
       * æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD æ ¼å¼
       */
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return dateString; // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›åŸå­—ç¬¦ä¸²
          
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        } catch (e) {
          console.error('æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', e);
          return dateString;
        }
      }
      
      /**
       * è§£æå¿«é€’å•å·è¾“å…¥ï¼ˆæ”¯æŒå¤šä¸ªå•å·ï¼‰
       */
      function parseTrackingNumbers(input) {
        if (!input || !input.trim()) return [];
        
        // æŒ‰ç©ºæ ¼ã€æ¢è¡Œã€é€—å·ï¼ˆä¸­è‹±æ–‡ï¼‰åˆ†éš”ï¼Œå»é™¤ç©ºç™½
        return input.split(/[\s\n,ï¼Œ]+/)
                   .map(num => num.trim())
                   .filter(num => num.length > 0);
      }

      /**
       * æ›´æ–°åˆ†é¡µä¿¡æ¯å’ŒæŒ‰é’®çŠ¶æ€
       */
      function updatePaginationInfo() {
        totalCountSpan.textContent = currentData.length;
        totalPages = Math.ceil(currentData.length / pageSize);
        pageInfoSpan.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
        
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
      }
      
      /**
       * æ¸²æŸ“å½“å‰é¡µæ•°æ®
       */
      function renderCurrentPage() {
        if (currentData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center py-20 border-b border-gray-100">
                <div class="flex flex-col items-center justify-center">
                  <div class="bg-gray-100 rounded-full p-6 mb-4">
                    <i class="fa fa-database text-4xl text-gray-400"></i>
                  </div>
                  <h3 class="text-xl font-semibold text-gray-600 mb-2">æš‚æ— å†å²æ•°æ®</h3>
                  <p class="text-gray-500 text-sm">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–æ·»åŠ æ–°çš„æ•°æ®è®°å½•</p>
                  <div class="mt-4 flex items-center text-blue-500 text-sm">
                    <i class="fa fa-lightbulb mr-2"></i>
                    <span>æç¤ºï¼šæ‚¨å¯ä»¥é€šè¿‡æ—¥æœŸæˆ–å¿«é€’å•å·è¿›è¡Œç²¾ç¡®æŸ¥è¯¢</span>
                  </div>
                </div>
              </td>
            </tr>
          `;
          updatePaginationInfo();
          return;
        }

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, currentData.length);
        const pageData = currentData.slice(startIndex, endIndex);

        tbody.innerHTML = '';

        pageData.forEach(item => {
          const formattedDate = formatDate(item.date);
          const trackingNumber = item.tracking_number || 'N/A';
          const orderNumber = item.order_number || 'N/A';

          // è®¡ç®—å†…è£…æ€»ä»¶æ•°å’Œå¤„ç†å•†æˆ·æ•°æ®
          let totalPieces = 0;
          let merchantsData = [];
          
          if (item.isNewFormat) {
            // æ–°åˆ†æ‘Šè¡¨æ ¼å¼
            merchantsData = item.merchants || [];
            totalPieces = merchantsData.reduce((sum, merchant) => {
              return sum + (parseInt(merchant.pieces) || 1);
            }, 0);
          } else {
            // æ—§è¡¨æ ¼å¼ï¼Œéœ€è¦è§£æJSON
            try {
              if (item.merchants) {
                merchantsData = JSON.parse(item.merchants);
                if (Array.isArray(merchantsData)) {
                  totalPieces = merchantsData.reduce((sum, merchant) => {
                    return sum + (parseInt(merchant.pieces) || 1);
                  }, 0);
                }
              }
            } catch (e) {
              console.error('è§£æmerchantsæ•°æ®å¤±è´¥:', e);
              totalPieces = 1;
              merchantsData = [{
                merchant_name: 'è§£æé”™è¯¯',
                pieces: 1
              }];
            }
          }

          if (totalPieces === 0) {
            totalPieces = 1;
            merchantsData = [{
              merchant_name: 'æœªçŸ¥å•†å®¶',
              pieces: 1
            }];
          }

          const row = document.createElement('tr');
          row.className = 'border-b border-gray-50 hover:bg-gray-50/50 transition-colors';
          
          // è·å–ç‰©æµçŠ¶æ€å’Œå®æ”¶ä»¶æ•°
          const defaultMerchant = merchantsData[0] || {};
          const logisticsStatus = defaultMerchant.logistics_status || 'é€”ä¸­';
          const actualReceivedCount = defaultMerchant.actual_received_count || 0;

          row.innerHTML = `
            <td class="px-4 py-3 text-center border-b border-gray-100">
              <input type="checkbox" class="row-checkbox h-4 w-4 text-blue-600 rounded-md focus:ring-2 focus:ring-blue-500 border-2 border-gray-300" data-date="${formattedDate}" data-order-number="${orderNumber}" data-tracking-number="${trackingNumber}">
            </td>
            <td class="px-6 py-3 font-semibold text-gray-800 border-b border-gray-100">${formattedDate}</td>
            <td class="px-6 py-3 text-gray-700 border-b border-gray-100 font-mono text-sm">${trackingNumber}</td>
            <td class="px-6 py-3 text-gray-700 border-b border-gray-100">${orderNumber}</td>
            <td class="px-6 py-3 text-center border-b border-gray-100">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">
                    ${totalPieces}
                </span>
            </td>
            <td class="px-6 py-3 text-center border-b border-gray-100">
                <button class="view-details-btn inline-flex items-center px-3 py-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg text-xs font-medium transition-all duration-300 hover:shadow-lg hover:scale-105" data-item-id="${item.id}">
                    <i class="fa fa-eye mr-1"></i>
                    æŸ¥çœ‹è¯¦æƒ…
                </button>
            </td>
            <td class="px-6 py-3 text-center border-b border-gray-100">
                <select class="logistics-status-select border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white hover:border-blue-300 transition-all" data-tracking-number="${trackingNumber}">
                    <option value="é€”ä¸­" ${logisticsStatus === 'é€”ä¸­' ? 'selected' : ''}>ğŸšš é€”ä¸­</option>
                    <option value="ç­¾æ”¶" ${logisticsStatus === 'ç­¾æ”¶' ? 'selected' : ''}>âœ… ç­¾æ”¶</option>
                    <option value="å»¶è¯¯" ${logisticsStatus === 'å»¶è¯¯' ? 'selected' : ''}>âš ï¸ å»¶è¯¯</option>
                </select>
            </td>
            <td class="px-6 py-3 text-center border-b border-gray-100">
                <input type="number" class="actual-received-input border-2 border-gray-200 rounded-lg px-3 py-2 text-sm w-20 text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white hover:border-blue-300 transition-all font-semibold" 
                       value="${actualReceivedCount}" min="0" data-tracking-number="${trackingNumber}">
            </td>
            <td class="px-6 py-3 text-center border-b border-gray-100">
                <div class="flex items-center justify-center gap-2">
                    <button class="edit-btn group bg-green-100 hover:bg-green-500 text-green-600 hover:text-white px-3 py-2 rounded-lg transition-all duration-300 hover:shadow-md hover:scale-105" data-date="${formattedDate}" data-order-number="${orderNumber}" data-tracking-number="${trackingNumber}" title="ç¼–è¾‘">
                        <i class="fa fa-edit text-sm group-hover:animate-pulse"></i>
                    </button>
                    <button class="enter-workflow-btn group bg-blue-100 hover:bg-blue-500 text-blue-600 hover:text-white px-3 py-2 rounded-lg transition-all duration-300 hover:shadow-md hover:scale-105" data-date="${formattedDate}" data-tracking-number="${trackingNumber}" data-order-number="${orderNumber}" title="å½•å…¥å·¥ä½œæµ">
                        <i class="fa fa-plus text-sm group-hover:animate-pulse"></i>
                    </button>
                    <button class="delete-btn group bg-red-100 hover:bg-red-500 text-red-600 hover:text-white px-3 py-2 rounded-lg transition-all duration-300 hover:shadow-md hover:scale-105" data-item-id="${item.id}" data-date="${formattedDate}" data-order-number="${orderNumber}" data-tracking-number="${trackingNumber}" data-new-format="${item.isNewFormat}" title="åˆ é™¤">
                        <i class="fa fa-trash text-sm group-hover:animate-pulse"></i>
                    </button>
                </div>
            </td>
          `;
          tbody.appendChild(row);

          // ä¿å­˜merchantsæ•°æ®åˆ°å…ƒç´ 
          row.dataset.merchants = JSON.stringify(merchantsData);
        });

        updatePaginationInfo();
        
        // é‡æ–°ç»‘å®šå½“å‰é¡µçš„äº‹ä»¶
        bindCurrentPageEvents();
      }

      /**
       * ä» API è·å–æ‰€æœ‰å†å²æ•°æ®å¹¶æ¸²æŸ“è¡¨æ ¼
       */
      async function loadAndRenderHistory(dateFilter, trackingNumberFilter) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-20 border-b border-gray-100">
              <div class="flex flex-col items-center justify-center">
                <div class="relative">
                  <div class="bg-blue-100 rounded-full p-6 mb-4 animate-pulse">
                    <i class="fa fa-spinner text-4xl text-blue-500 animate-spin"></i>
                  </div>
                  <div class="absolute -inset-2 bg-blue-200 rounded-full animate-ping opacity-20"></div>
                </div>
                <h3 class="text-xl font-semibold text-blue-600 mb-2">æ­£åœ¨åŠ è½½æ•°æ®...</h3>
                <p class="text-gray-500 text-sm">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢ç›¸å…³è®°å½•</p>
                <div class="mt-4 flex items-center justify-center space-x-1">
                  <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                  <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                  <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
              </div>
            </td>
          </tr>
        `;

        try {
          // è§£æå¿«é€’å•å·
          const trackingNumbers = parseTrackingNumbers(trackingNumberFilter);
          
          // æ„å»ºæŸ¥è¯¢å‚æ•°
          const params = new URLSearchParams();
          if (dateFilter) {
            params.append('start_date', dateFilter);
            params.append('end_date', dateFilter);
          }
          if (trackingNumbers.length > 0) {
            // ä½¿ç”¨å¤šä¸ªå¿«é€’å•å·å‚æ•°
            params.append('tracking_numbers', trackingNumbers.join(','));
          }

          console.log('æŸ¥è¯¢å‚æ•°:', params.toString());
          console.log('è§£æçš„å¿«é€’å•å·:', trackingNumbers);

          // å…ˆå°è¯•ä»æ–°çš„åˆ†æ‘Šè¡¨è·å–æ•°æ®
          let allData = [];
          try {
            const newResponse = await fetch(`/api/shipping_allocations?${params.toString()}`);
            if (newResponse.ok) {
              const newResult = await newResponse.json();
              if (newResult.success && newResult.data && newResult.data.length > 0) {
                console.log('ä»æ–°åˆ†æ‘Šè¡¨è·å–æ•°æ®:', newResult);
                allData = newResult.data.map(item => ({
                  ...item,
                  isNewFormat: true
                }));
              }
            }
          } catch (e) {
            console.log('æ–°åˆ†æ‘Šè¡¨æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æ—§è¡¨:', e);
          }

          // å¦‚æœæ–°è¡¨æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æ—§è¡¨è·å–
          if (allData.length === 0) {
            const params2 = new URLSearchParams();
            if (dateFilter) {
              params2.append('start_date', dateFilter);
              params2.append('end_date', dateFilter);
            }
            if (trackingNumbers.length > 0) {
              // æ—§è¡¨APIä½¿ç”¨tracking_numberså‚æ•°
              params2.append('tracking_numbers', trackingNumbers.join(','));
            }

            const oldResponse = await fetch(`/api/shipping_costs?${params2.toString()}`);
            if (!oldResponse.ok) {
              throw new Error(`HTTP error! status: ${oldResponse.status}`);
            }
            
            const oldResult = await oldResponse.json();
            console.log('ä»æ—§è¡¨è·å–æ•°æ®:', oldResult);

            if (!oldResult.success) {
              throw new Error(oldResult.message || 'æŸ¥è¯¢å¤±è´¥');
            }

            allData = (oldResult.data || []).map(item => ({
              ...item,
              isNewFormat: false
            }));
          }

          // ä¿å­˜æ•°æ®å¹¶é‡ç½®åˆ°ç¬¬ä¸€é¡µ
          currentData = allData;
          currentPage = 1;
          
          // æ¸²æŸ“å½“å‰é¡µ
          renderCurrentPage();

        } catch (error) {
          console.error('æŸ¥è¯¢å¤±è´¥:', error);
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center py-20 border-b border-gray-100">
                <div class="flex flex-col items-center justify-center">
                  <div class="bg-red-100 rounded-full p-6 mb-4">
                    <i class="fa fa-exclamation-triangle text-4xl text-red-500"></i>
                  </div>
                  <h3 class="text-xl font-semibold text-red-600 mb-2">æŸ¥è¯¢å¤±è´¥</h3>
                  <p class="text-gray-500 text-sm mb-4">ç½‘ç»œè¿æ¥å¼‚å¸¸æˆ–æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨</p>
                  <button onclick="loadAndRenderHistory('${dateFilter || ''}', '${trackingNumberFilter || ''}')" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-all duration-300 hover:shadow-lg">
                    <i class="fa fa-refresh mr-2"></i>
                    é‡è¯•
                  </button>
                  <div class="mt-4 flex items-center text-gray-500 text-sm">
                    <i class="fa fa-info-circle mr-2"></i>
                    <span>å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ</span>
                  </div>
                </div>
              </td>
            </tr>
          `;
        }
      }
      
      /**
       * ç»‘å®šå½“å‰é¡µé¢çš„äº‹ä»¶
       */
      function bindCurrentPageEvents() {
        // ç»‘å®šæŸ¥çœ‹è¯¦æƒ…äº‹ä»¶
        document.querySelectorAll('.view-details-btn').forEach(button => {
          button.addEventListener('click', function() {
            const row = this.closest('tr');
            const merchantsData = JSON.parse(row.dataset.merchants || '[]');
            const date = row.querySelector('td:nth-child(2)').textContent;
            const trackingNumber = row.querySelector('td:nth-child(3)').textContent;
            const orderNumber = row.querySelector('td:nth-child(4)').textContent;
            
            showMerchantDetailsModal({
              date: date,
              tracking_number: trackingNumber,
              order_number: orderNumber,
              merchants: merchantsData
            });
          });
        });
        
        // ç»‘å®šç¼–è¾‘äº‹ä»¶
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.addEventListener('click', function() {
            const orderNumberToEdit = this.getAttribute('data-order-number');
            if (orderNumberToEdit && orderNumberToEdit !== 'N/A') {
              window.location.href = `{{ url_for('expense_allocation_function') }}?order_number=${encodeURIComponent(orderNumberToEdit)}`;
            } else {
              Swal.fire('é”™è¯¯', 'è¯¥è®°å½•æ²¡æœ‰æœ‰æ•ˆçš„è¡¨å•ç¼–å·ï¼Œæ— æ³•ç¼–è¾‘', 'error');
            }
          });
        });
        
        // ç»‘å®šåˆ é™¤äº‹ä»¶
        document.querySelectorAll('.delete-btn').forEach(button => {
          button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const isNewFormat = this.getAttribute('data-new-format') === 'true';
            const orderNumber = this.getAttribute('data-order-number');
            const trackingNumber = this.getAttribute('data-tracking-number');
            
            Swal.fire({
              title: 'ç¡®è®¤åˆ é™¤',
              text: `ç¡®å®šè¦åˆ é™¤å¿«é€’å•å· ${trackingNumber} çš„è®°å½•å—ï¼Ÿ`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              cancelButtonColor: '#3085d6',
              confirmButtonText: 'ç¡®å®šåˆ é™¤',
              cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
              if (result.isConfirmed) {
                deleteRecord(itemId, isNewFormat, orderNumber, trackingNumber);
              }
            });
          });
        });
        
        // ç»‘å®šå½•å…¥å·¥ä½œæµæŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.enter-workflow-btn').forEach(button => {
          button.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            const trackingNumber = this.getAttribute('data-tracking-number');
            const orderNumber = this.getAttribute('data-order-number');
            
            const url = new URL(`{{ url_for('temu_y2gzl_html') }}`, window.location.origin);
            url.searchParams.set('date', date);
            url.searchParams.set('tracking_number', trackingNumber);
            url.searchParams.set('order_number', orderNumber);
            
            window.open(url.toString(), '_blank');
          });
        });
      }
      
      /**
       * æ˜¾ç¤ºå•†å®¶ä»¶æ•°æ˜ç»†å¼¹çª—
       */
      function showMerchantDetailsModal(orderData) {
        let totalPieces = 0;
        let merchantDetailsHtml = '';
        
        orderData.merchants.forEach((merchant, index) => {
          const merchantName = merchant.merchant_name || merchant.name || 'æœªçŸ¥å•†å®¶';
          const pieces = parseInt(merchant.pieces) || 1;
          totalPieces += pieces;
          
          merchantDetailsHtml += `
            <div class="flex justify-between items-center py-2 px-3 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} rounded">
              <span class="font-medium text-gray-700">${merchantName}</span>
              <span class="text-blue-600 font-semibold">${pieces} ä»¶</span>
            </div>
          `;
        });
        
        Swal.fire({
          title: `å•†å®¶ä»¶æ•°æ˜ç»†`,
          html: `
            <div class="text-left">
              <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">
                  <strong>æ—¥æœŸï¼š</strong>${orderData.date}
                </div>
                <div class="text-sm text-gray-600 mb-1">
                  <strong>è¡¨å•ç¼–å·ï¼š</strong>${orderData.order_number || 'N/A'}
                </div>
                <div class="text-sm text-gray-600">
                  <strong>å¿«é€’å•å·ï¼š</strong>${orderData.tracking_number || 'N/A'}
                </div>
              </div>
              
              <div class="mb-3">
                <h4 class="font-semibold text-gray-800 mb-2">å•†å®¶ä»¶æ•°æ˜ç»†ï¼š</h4>
                <div class="space-y-1 max-h-60 overflow-y-auto">
                  ${merchantDetailsHtml}
                </div>
              </div>
              
              <div class="border-t pt-3 mt-3">
                <div class="flex justify-between items-center p-3 bg-blue-100 rounded-lg">
                  <span class="font-bold text-gray-800">æ€»è®¡ï¼š</span>
                  <span class="text-blue-700 font-bold text-lg">${totalPieces} ä»¶</span>
                </div>
              </div>
            </div>
          `,
          width: '500px',
          showConfirmButton: true,
          confirmButtonText: 'å…³é—­',
          confirmButtonColor: '#3b82f6'
        });
      }
      
      /**
       * åˆ é™¤è®°å½•
       */
      async function deleteRecord(itemId, isNewFormat, orderNumber, trackingNumber) {
        try {
          const apiUrl = isNewFormat ? 
            `/api/shipping_allocations/${itemId}` : 
            `/api/shipping_costs/${itemId}`;
          
          console.log('åˆ é™¤API URL:', apiUrl, 'æ•°æ®æ ¼å¼:', isNewFormat ? 'æ–°åˆ†æ‘Šè¡¨' : 'æ—§æˆæœ¬è¡¨');
          
          const response = await fetch(apiUrl, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          if (result.success) {
            Swal.fire('å·²åˆ é™¤!', 'è¯¥æ¡å†å²æ•°æ®å·²è¢«åˆ é™¤ã€‚', 'success');
            // é‡æ–°åŠ è½½å½“å‰é¡µæ•°æ®
            const date = queryDateInput.value;
            const trackingNumberFilter = queryTrackingNumberInput.value;
            loadAndRenderHistory(date, trackingNumberFilter);
          } else {
            throw new Error(result.message || 'åˆ é™¤å¤±è´¥');
          }
        } catch (error) {
          console.error('åˆ é™¤æ•°æ®å¤±è´¥:', error);
          Swal.fire('é”™è¯¯', 'åˆ é™¤æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
      }

      // åˆ†é¡µæŒ‰é’®äº‹ä»¶
      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderCurrentPage();
        }
      });

      nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderCurrentPage();
        }
      });

      // åˆå§‹åŠ è½½
      loadAndRenderHistory();

      // ç»‘å®šæŸ¥è¯¢æŒ‰é’®äº‹ä»¶
      searchBtn.addEventListener('click', () => {
        const date = queryDateInput.value;
        const trackingNumber = queryTrackingNumberInput.value;
        loadAndRenderHistory(date, trackingNumber);
      });

      // ç»‘å®šå¯¼å‡ºExcelæŒ‰é’®äº‹ä»¶
      document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);

      // ç»‘å®šæ‰¹é‡ä¿å­˜æŒ‰é’®äº‹ä»¶
      document.getElementById('saveBatchBtn').addEventListener('click', saveBatchUpdates);

      /**
       * æ‰¹é‡ä¿å­˜ç‰©æµçŠ¶æ€å’Œå®æ”¶ä»¶æ•°
       */
      async function saveBatchUpdates() {
        const saveBtn = document.getElementById('saveBatchBtn');
        const originalText = saveBtn.textContent;
        
        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          saveBtn.textContent = 'ä¿å­˜ä¸­...';
          saveBtn.disabled = true;

          // æ”¶é›†æ‰€æœ‰ç¼–è¾‘çš„æ•°æ®
          const updateList = [];
          const rows = document.querySelectorAll('#historyTableBody tr');
          
          rows.forEach(row => {
            const logisticsSelect = row.querySelector('.logistics-status-select');
            const actualReceivedInput = row.querySelector('.actual-received-input');
            
            if (logisticsSelect && actualReceivedInput) {
              const trackingNumber = logisticsSelect.getAttribute('data-tracking-number');
              if (trackingNumber && trackingNumber !== 'N/A') {
                updateList.push({
                  tracking_number: trackingNumber,
                  logistics_status: logisticsSelect.value,
                  actual_received_count: parseInt(actualReceivedInput.value) || 0
                });
              }
            }
          });

          if (updateList.length === 0) {
            Swal.fire('æç¤º', 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦ä¿å­˜çš„æ•°æ®', 'info');
            return;
          }

          console.log('å‡†å¤‡æ‰¹é‡æ›´æ–°æ•°æ®:', updateList);

          // è°ƒç”¨æ‰¹é‡æ›´æ–°API
          const response = await fetch('/api/shipping_allocation_details/batch_update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ details: updateList })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          
          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'ä¿å­˜æˆåŠŸï¼',
              text: `å·²æˆåŠŸæ›´æ–° ${result.updated || updateList.length} æ¡è®°å½•çš„ç‰©æµçŠ¶æ€å’Œå®æ”¶ä»¶æ•°`,
              timer: 2000,
              showConfirmButton: false
            });
          } else {
            throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
          }

        } catch (error) {
          console.error('æ‰¹é‡ä¿å­˜å¤±è´¥:', error);
          Swal.fire({
            icon: 'error',
            title: 'ä¿å­˜å¤±è´¥',
            text: 'ä¿å­˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message
          });
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          const saveBtn = document.getElementById('saveBatchBtn');
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }

      function downloadExcel() {
        const wb = XLSX.utils.book_new();
        const ws_data = [];

        const now = new Date();
        const exportDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        ws_data.push([`å¯¼å‡ºæ—¶é—´: ${exportDateTime}`]);
        ws_data.push([]);

        ws_data.push([
          'æ—¥æœŸ', 'å¿«é€’å•å·', 'è¡¨å•ç¼–å·', 'å†…è£…æ€»ä»¶æ•°', 'å•†æˆ·è¯¦æƒ…', 'ç‰©æµçŠ¶æ€', 'å®æ”¶ä»¶æ•°'
        ]);

        const rows = document.querySelectorAll('#historyTableBody tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 9) {
            const merchantsData = JSON.parse(row.dataset.merchants || '[]');
            const merchantDetails = merchantsData.map(m => `${m.merchant_name || m.name || 'æœªçŸ¥å•†å®¶'}:${m.pieces || 1}ä»¶`).join('; ');
            
            const logisticsSelect = row.querySelector('.logistics-status-select');
            const actualReceivedInput = row.querySelector('.actual-received-input');
            
            const rowData = [
              cells[1].textContent, // æ—¥æœŸ
              cells[2].textContent, // å¿«é€’å•å·
              cells[3].textContent, // è¡¨å•ç¼–å·
              cells[4].textContent, // å†…è£…æ€»ä»¶æ•°
              merchantDetails,       // å•†æˆ·è¯¦æƒ…
              logisticsSelect ? logisticsSelect.value : 'é€”ä¸­',  // ç‰©æµçŠ¶æ€
              actualReceivedInput ? actualReceivedInput.value : '0'  // å®æ”¶ä»¶æ•°
            ];
            ws_data.push(rowData);
          }
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "å†å²æ•°æ®æŸ¥è¯¢");
        
        const filename = `å†å²æ•°æ®æŸ¥è¯¢_${exportDateTime.split(' ')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
      }
    });
  </script>
</body>
</html> 